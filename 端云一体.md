:::color1
9月份 meta70 top5000

端云体系还未真正成型- API不兼容-一些服务不完善。

:::

:::color1
应用卡片demo代码- [service_demo.zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727513328040-5560f76a-56e7-4b57-bd63-685bd0003d6a.zip)

端云一体仓库： [https://gitee.com/shuiruohanyu/flowme](https://gitee.com/shuiruohanyu/flowme)

:::

<h1 id="j8S7Q">元服务基本概念</h1>
:::color2
<font style="color:rgba(0, 0, 0, 0.9);">元服务（原名为原子化服务）是HarmonyOS提供的一种面向未来的服务提供方式，是有独立入口、免安装、可为用户提供一个或多个便捷服务的新型应用程序形态。</font>

<font style="color:rgba(0, 0, 0, 0.9);">以线上购物为例：</font>

+ <font style="color:rgb(36, 39, 40);">传统购物应用：需要先安装应用，打开应用查找商品，加入购物车，然后完成支付。</font>
+ <font style="color:rgb(36, 39, 40);">调整为包含“商品浏览”、“购物车”、“支付”等多个服务的元服务：无需安装，通过丰富入口直达服务页面。例如：将心仪商品页添加桌面，实时掌握商品价格变动。等到秒杀时间点，直达购物车进行结算。</font>

<font style="color:rgba(0, 0, 0, 0.9);">元服务基于HarmonyOS API开发，支持运行在1+8+N设备上，供用户在合适的场景、合适的设备上便捷使用。元服务相对于传统方式的需要安装的应用形态更加轻量，同时提供更丰富的入口、更精准的分发。</font>



:::

:::color3
<font style="color:rgba(0, 0, 0, 0.9);">元服务</font>**<font style="color:#DF2A3F;">类似微信小程序，无需安装，从目前编辑器更新的特性来说，元服务和应用的区别就是一个不需要安装，另外一个需要安装，其他基本一致</font>**

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716281690859-d9d31dae-b6b6-4647-bd19-37ed6cacc6a8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ 官方对比图

| **** | **** | **** |
| --- | --- | --- |
| **项目** | **元服务** | **传统应用** |
| **软件包形态** | [**App Pack**](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-package-structure-stage-0000001579865918)**（.app）** | [**App Pack**](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-package-structure-stage-0000001579865918)**（.app）** |
| **分发平台** | **由应用市场（AppGallery）管理和分发** | **由应用市场（AppGallery）管理和分发** |
| **安装后有无桌面icon** | **无桌面icon，但可手动添加到桌面，显示形式为服务卡片** | **有桌面icon** |
| **HAP免安装要求** | **所有**[**HAP（包括Entry HAP和Feature HAP）**](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/application-package-structure-stage-0000001579865918)<br/>**均需满足**[**免安装**](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/atomic-service-package-basics-0000001560901158#section94551775274)<br/>**要求** | **所有HAP（包括Entry HAP和Feature HAP）均为非免安装的** |


+ 入口

:::color1
<font style="color:rgba(0, 0, 0, 0.9);">打开负一屏搜索页，输入关键字，搜索获取所需的元服务。</font>

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713515211347-39f601ac-347f-4c8b-84e0-dd4ada30a1d7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
+ <font style="color:rgba(0, 0, 0, 0.9);">打开华为应用市场，点击“应用”页签，进入“元服务”专区发现并使用元服务。</font>

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713515211157-6cd23175-1ada-4bf6-ad76-9d83f4030df5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)





![](https://cdn.nlark.com/yuque/0/2024/png/639379/1704421755765-a3a59e54-0070-4b63-bc90-f06c0525a068.png?x-oss-process=image%2Fresize%2Cw_892%2Climit_0%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_25%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="25437424">创建元服务</h1>
1. 若首次打开DevEco Studio，请选择Create Project开始创建一个新工程。如果已经打开了一个工程，请在菜单栏选择File > New > Create Project来创建一个新工程。选择Atomic Service元服务开发，选择“Empty Ability”模板，单击Next进行下一步配置。

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708442437662-72620f42-b5bb-4348-96cb-0cf02129404b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

1. 进入配置工程界面，修改“Project name，其他参数保持默认设置即可。

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716189254767-ea40e0b9-abe9-4a71-9aac-355d695774ab.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
本质上-元服务和应用的区别仅仅是一个配置的区别

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713520854176-ebe55786-be9d-4b89-855f-2dfbd8024310.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_66%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

有这个属性就是元服务，没有就是应用，除此之外，没有其他差别了。

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716189757040-e49c6114-ab39-48da-b81f-7493632343a2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="22ec302a">项目目录结构-元服务名称修改</h1>
:::color2
创建完毕的项目结构之前的应用类似，目前主要关注3个不同点即可：

1.  卡片生命周期管理文件（EntryFormAbility.ts） 

其他的和之前创建的应用是一致的，直接套用之前的理解即可，详细的说明如下：

+ AppScope > app.json5：元服务的全局配置信息。
+ entry：HarmonyOS工程模块，编译构建生成一个HAP。 
    - src > main > ets：用于存放ArkTS源码。
    - src > main > ets > entryability：元服务的入口。
    - src > main > ets > pages：元服务包含的页面。
    - src > main > resources：用于存放元服务所用到的资源文件，如图形、多媒体、字符串、布局文件等。关于资源文件，详见[资源分类与访问](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/js-framework-resource-restriction-0000001427744632-V2)。
    - src > main > module.json5：模块配置文件。主要包含HAP的配置信息、元服务在具体设备上的配置信息以及元服务的全局配置信息。具体的配置文件说明，详见[module.json5](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/module-configuration-file-0000001427744540-V2)。
    - build-profile.json5：当前的模块信息 、编译信息配置项，包括buildOption、targets配置等。
    - hvigorfile.ts：模块级编译构建任务脚本，开发者可以自定义相关任务和代码实现。
+ oh_modules：用于存放三方库依赖信息。关于原npm工程适配ohpm操作，请参考[历史工程手动迁移](https://developer.harmonyos.com/cn/docs/documentation/doc-guides-V3/project_overview-0000001053822398-V3#section108143331212)。
+ build-profile.json5：元服务级配置信息，包括签名signingConfigs、产品配置products等。其中products中可配置当前运行环境，默认为HarmonyOS。
+ hvigorfile.ts：元服务级编译构建任务脚本。
+ EntryCard：元服务卡片快照图片存放目录。

:::



:::color2
**<font style="color:#DF2A3F;">目前元服务的版本优先级较低，官方给的版本还需要进一步升级，所以很多特性还未和应用开发同步</font>**

:::

+ 修改元服务的app的名称和图标

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713757248565-68574520-097d-405a-a724-d6701553c71f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_66%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713757284524-789b0da9-ea2e-4f2d-a8c6-ab53d4953fcf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
值得注意的是： 元服务的名称具备缓存，想要生效需要将上一次的元服务移除之后，才可以生效

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713757335740-6a9ba7e6-8012-4a86-a512-63238e107374.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_12%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ 更换元服务图标

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713757617538-f3aceffa-8a3a-47e9-a58e-4759beef71a6.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_69%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716190205021-2ea97232-ae7e-48e7-acdd-c0a09bf59996.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="42a89aab">添加一个服务卡片</h1>
:::color1
卡片用来显示或者提示一些基本信息或者进行一些基本操作。注意不能做重逻辑，所有重要逻辑全部交给应用

:::

:::warning
因为元服务不提供桌面应用图标，我们可以通过用户手动的方式在桌面上添加一张卡片，通过点击卡片来唤起元服务。

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708585516667-0f83192f-4ff1-4d45-80e1-c5a00fa064e1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::warning
选择动态卡片

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708573944509-93def254-9e1e-4d02-aaed-483ef94401ea.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708574026051-012bc7ca-ba6b-4035-872c-36531cb646e2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708574126859-558539e6-b21d-4d1e-9ab2-9c24f6e9ae79.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708574150181-52a3ae55-bc89-4de8-ab43-7ec40da6d394.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_61%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

卡片特点：

1. 卡片可以承载少量的内容显示和交互
2. 卡片可以充当元服务的入口，点击卡片可以唤起元服务

:::warning
**注意！！**

1. 普通应用中也**可以添加服务卡片**并进行服务卡片开发，但是**默认并没有添加卡片**
2. 元服务**因为没有icon**作为入口，所以默认提供了一张**服务卡片**作为入口

:::

:::color1
**<font style="color:#DF2A3F;">当前模拟器元服务异常！直接把元服务改成应用即可</font>**

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716191019249-38932c87-57c8-4bec-b9b8-d39c6fe826c0.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ 添加卡片

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716190961234-286b5561-3c7e-4c08-a604-3aeb1c3c7890.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_13%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716190967865-1cbf6ad7-1c42-4296-97ef-db6d75f6ccc1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_9%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="KI8xJ">服务卡片约束和开发</h1>
:::color2
<font style="color:rgba(0, 0, 0, 0.9);">Form Kit（卡片开发服务）提供一种界面展示形式，可以将应用的重要信息或操作前置到服务卡片（以下简称“卡片”），以达到服务直达、减少跳转层级的体验效果。卡片常用于嵌入到其他应用（当前被嵌入方即卡片使用方只支持系统应用，例如桌面）中作为其界面显示的一部分，并支持拉起页面、发送消息等基础的交互能力。</font>

:::

+ <font style="color:rgba(0, 0, 0, 0.9);">ArkTS卡片实现原理</font>

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713768986989-f19b482c-8915-4457-b45e-2fbc6bf352df.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_25%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ <font style="color:rgb(36, 39, 40);">ArkTS卡片渲染服务运行原理</font>

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713769017636-41874dcc-108b-4d48-8ed0-b8d168f93d4c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



从编写的代码来看，和之前应用开发中的基本一致，但是支持的能力并没有应用中多，这里附上官方说明链接：

1. [卡片页面能力说明](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/arkts-ui-widget-page-overview-0000001553173049-V2)
2. [卡片使用动效能力](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides-V2/arkts-ui-widget-page-animation-0000001553297285-V2)

:::color3
卡片约束

<font style="color:rgba(0, 0, 0, 0.9);">ArkTS卡片相较于JS卡片具备了更加丰富的能力，但也增加了使用卡片进行恶意行为的风险。由于ArkTS卡片显示在使用方应用中，使用方应用一般为桌面应用，为确保桌面的使用体验以及功耗相关考虑，对ArkTS卡片的能力做了以下约束：</font>

+ <font style="color:rgb(36, 39, 40);">当导入模块时，仅支持导入标识“支持在ArkTS卡片中使用”的模块。</font>
+ <font style="color:rgb(36, 39, 40);">不支持导入共享包。</font>
+ <font style="color:rgb(36, 39, 40);">不支持使用native语言开发。</font>
+ <font style="color:rgb(36, 39, 40);">仅支持</font>[声明式范式](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/ts-components-summary-0000001774121154)<font style="color:rgb(36, 39, 40);">的部分组件、事件、动效、数据管理、状态管理和API能力。</font>
+ <font style="color:rgb(36, 39, 40);">卡片的事件处理和使用方的事件处理是独立的，建议在使用方支持左右滑动的场景下卡片内容不要使用左右滑动功能的组件，以防手势冲突影响交互体验。</font>

<font style="color:rgba(0, 0, 0, 0.9);">除此之外，当前ArkTS卡片还存在如下约束：</font>

+ <font style="color:rgb(36, 39, 40);">暂不支持极速预览。</font>
+ <font style="color:rgb(36, 39, 40);">暂不支持断点调试能力。</font>
+ <font style="color:rgb(36, 39, 40);">暂不支持热重载。</font>
+ <font style="color:rgb(36, 39, 40);">暂不支持设置超时任务。 setTimeout</font>

:::

<font style="color:rgba(0, 0, 0, 0.9);"> 归根到底： 卡片能做基本数据展示- 传递一些参数-唤起应用操作</font>

+ <font style="color:rgba(0, 0, 0, 0.9);">ArkTS卡片相关模块</font>

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713769155401-610acd3e-87e8-4e73-9ead-5cd8ee62991c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
+ [FormExtensionAbility](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formextensionability-0000001774281498)<font style="color:rgb(36, 39, 40);">：卡片扩展模块，提供卡片创建、销毁、刷新等生命周期回调。</font>
+ <font style="color:rgb(36, 39, 40);">FormExtensionContext：FormExtensionAbility的上下文环境，提供FormExtensionAbility具有的接口和能力。</font>
+ [formProvider](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formprovider-0000001821001449)<font style="color:rgb(36, 39, 40);">：提供卡片提供方相关的接口能力，可通过该模块提供接口实现更新卡片、设置卡片更新时间、获取卡片信息、请求发布卡片等。</font>
+ [formInfo](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-forminfo-0000001774121826)<font style="color:rgb(36, 39, 40);">：提供了卡片信息和状态等相关类型和枚举。</font>
+ [formBindingData](https://developer.huawei.com/consumer/cn/doc/harmonyos-references/js-apis-app-form-formbindingdata-0000001820881465)<font style="color:rgb(36, 39, 40);">：提供卡片数据绑定的能力，包括FormBindingData对象的创建、相关信息的描述。</font>
+ [页面布局（WidgetCard.ets）](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-page-overview-0000001820880173)<font style="color:rgb(36, 39, 40);">：提供声明式范式的UI接口能力。</font>
    - [ArkTS卡片特有能力](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-event-overview-0000001820880177)<font style="color:rgb(36, 39, 40);">：postCardAction用于卡片内部和提供方应用间的交互，仅在卡片中可以调用。</font>
    - [ArkTS卡片能力列表](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-page-overview-0000001820880173#ZH-CN_TOPIC_0000001857917393__arkts%E5%8D%A1%E7%89%87%E6%94%AF%E6%8C%81%E7%9A%84%E9%A1%B5%E9%9D%A2%E8%83%BD%E5%8A%9B)<font style="color:rgb(36, 39, 40);">：列举了能在ArkTS卡片中使用的API、组件、事件、属性和生命周期调度。</font>
+ [卡片配置](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-configuration-0000001774280198)<font style="color:rgb(36, 39, 40);">：包含FormExtensionAbility的配置和卡片的配置</font>
    - <font style="color:rgb(36, 39, 40);">在</font>[module.json5配置文件](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/module-configuration-file-0000001820879553)<font style="color:rgb(36, 39, 40);">中的extensionAbilities标签下，配置FormExtensionAbility相关信息。</font>
    - <font style="color:rgb(36, 39, 40);">在resources/base/profile/目录下的</font>[form_config.json配置文件](https://developer.huawei.com/consumer/cn/doc/harmonyos-guides/arkts-ui-widget-configuration-0000001774280198)<font style="color:rgb(36, 39, 40);">中，配置卡片（WidgetCard.ets）相关信息。</font>

:::

<h2 id="2b9de3dd">5.3 服务卡片-应用双向通信</h2>
:::color2
1. **<font style="color:#DF2A3F;">卡片 => 应用</font>**

:::

+ 使用postCardAction方法

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713773599110-8f94a95c-3e8c-4558-b90b-388f90fb13aa.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713773615462-da7f32aa-aace-4c64-985d-67695958485a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713773626432-236637f7-de69-4872-8d53-f2a78474940b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 完成如图的一个布局

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716193715736-d8ac6615-3c52-4acf-b327-c57cf8232e5c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_9%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

```typescript
@Entry
@Component
struct MainPic {
  @State
  num: number = 0
  build() {
    Column({ space: 10 }) {
      Row({ space: 10 }) {
        Button("-")
          .onClick(() => {
            this.num && this.num--
          })
        Text(this.num.toString())
          .fontSize(20)
        Button("+")
          .onClick(() => {
            this.num++
          })
      }
      .width('100%')
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height("100%")
    .justifyContent(FlexAlign.Center)

  }
}
```

+ 点击卡片唤起应用

```typescript
.onClick(() => {
      postCardAction(this, {
        action: 'router',
        abilityName: 'EntryAbility',
      })
    })
```

:::color2
此时会唤起ability

:::

+ 加1减1传递当前的数字

```typescript
@Entry
@Component
struct Count {
  @State
  num: number = 0

  build() {
    Row({ space: 10 }) {
      Button("-")
        .onClick(() => {
          if(this.num)
              this.num--
          postCardAction(this, {
            action: 'call',
            abilityName: 'EntryAbility', // 只能跳转到当前应用下的UIAbility
            params: {
              // 使用call方式 需要第二个参数
              method: 'updateNum', // 名字必须叫method method的值是在ability中监听的方法名
              num: this.num
            }
          })
        })
      Text(this.num.toString())
        .fontSize(20)
      Button("+")
        .onClick(() => {
          this.num++
          postCardAction(this, {
            action: 'call',
            abilityName: 'EntryAbility', // 只能跳转到当前应用下的UIAbility
            params: {
              method: 'updateNum', // 名字必须叫method method的值是在ability中监听的方法名
              num: this.num
            }
          })
        })
    }
    .width("100%")
    .height("100%")
    .justifyContent(FlexAlign.Center)
    .alignItems(VerticalAlign.Center)
    .onClick(() => {
      postCardAction(this, {
        action: 'router',
        abilityName: 'EntryAbility'
      })
    })
  }
}
```

+ 请注意，如果使用call方式传递调用，需要开启一个后台权限-保持应用在后台

```typescript
 "requestPermissions": [{
      "name": "ohos.permission.KEEP_BACKGROUND_RUNNING"
    }],
```

+ 在ability的onCreate采用callee接收调用方法

:::color1
callee方法的第一个参数为调用方法名，第二个参数必须返回一个实现rpc.Parcelable的实现类对象

:::

+ 定义一个Params的参数对象

```typescript
import rpc from '@ohos.rpc';
class Params implements rpc.Parcelable {
  marshalling(messageSequence: rpc.MessageSequence): boolean {
    return true;
  }
  unmarshalling(messageSequence: rpc.MessageSequence): boolean {
    return true;
  }
}
```

+ 在ability中监听callee调用的方法

```typescript
// 声明一个接收参数的对象
class CardParams {
  num: number = 0
}
onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): void {
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onCreate');
    this.callee.on("updateNum", (data) => {
      const res = JSON.parse(data.readString()) as CardParams
      AppStorage.setOrCreate("num", res.num)
      return new Params()
    })
  }
```

+ 在应用销毁处进行解除监听

```typescript
 onDestroy(): void {
    this.callee.off("updateNum")
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onDestroy');
  }
```

+ 主页Index

```typescript
@Entry
@Component
struct Operate {
  @StorageLink("num")
  num: number = 0

  build() {
    Column() {
      Row({ space: 10 }) {
        Button("-")
          .onClick(() => {
            if(this.num) this.num--
          })
        Text(this.num.toString())
          .fontSize(20)
        Button("+")
          .onClick(() => {
            this.num++
          })
      }

    }
    .width('100%')
    .height("100%")
    .justifyContent(FlexAlign.Center)
  }
}
```



:::color2
2. **<font style="color:#DF2A3F;">应用 => 卡片</font>**

:::

:::color1
使用formProvider.updateForm(formId, formBingingData)

:::

+ 添加卡片事件中，获取卡片id推送到卡片半身

```typescript
onAddForm(want: Want) {
    // Called to return a FormBindingData object.
    return formBindingData.createFormBindingData({
      formId: want.parameters!["ohos.extra.param.key.form_identity"] as string
    });
  }
```

+ 在卡片使用LocalStorage进行接收

:::color1
**<font style="color:#DF2A3F;">此LocalStorage非彼LocalStorage,  基础阶段讲的LocalStorage是页面间共享，这里是对卡片共享数据，虽然名字一样，但是作用不一样，请注意</font>**

:::

```arkts
 @LocalStorageProp("formId")
  @Watch("updateFormId")
  formId: string = ""

  updateFormId () {
    postCardAction(this, {
      action: 'call',
      abilityName: 'EntryAbility', // 只能跳转到当前应用下的UIAbility
      params: {
        method: 'updateFormId',
        formId: this.formId
      }
    })
  }
```

+ 在ability中通过callee监听方法，将formId存入持久化

```typescript
 this.callee.on("updateFormId", (data) => {
      const res = JSON.parse(data.readString()) as CardParams
      const store = preferences.getPreferencesSync(this.context, {
        name: 'formIdList'
      })
      const list = JSON.parse(store.getSync("formIdList", "[]") as string) as string[]
      if(!list.includes(res.formId)) {
        list.push(res.formId)
      }
      store.putSync("formIdList", JSON.stringify(list))
      store.flush()
      formProvider.updateForm(res.formId, formBindingData.createFormBindingData({
        num: AppStorage.get("num")
      }))
      return new Params()
    })
```

+ 卸载时解除

```typescript
  onDestroy(): void {
    this.callee.off("updateNum")
    this.callee.off("updateFormId")
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onDestroy');
  }
```

+ 在加减时进行推送到卡片

```typescript
@StorageLink("num")
  @Watch("pushCard")
  num: number = 0

  pushCard() {
    const store = preferences.getPreferencesSync(getContext(), {
      name: 'formIdList'
    })
    const formIdList = JSON.parse(store.getSync("formIdList", "[]") as string) as string[]
    if (formIdList && formIdList.length) {
      formIdList.forEach((formId) => {
        formProvider.updateForm(formId, formBindingData.createFormBindingData({
          num: this.num
        }))
      })

    }
  }
```



:::color1
**<font style="color:#DF2A3F;">注意：目前卡片写入首选项有时存在莫名的无法实时读取数据的问题，有时可以，有时不可以，所以当遇到无法多个卡片无法存储formId的时候，建议重启编辑器，模拟器 </font>**

:::

<h1 id="TNUx3">端云一体开发</h1>
:::info
<font style="color:rgba(0, 0, 0, 0.9);">为丰富HarmonyOS对云端开发的支持、实现端云联动，DevEco Studio以AppGallery Connect（简称AGC）</font>[Serverless服务](https://developer.huawei.com/consumer/cn/doc/development/AppGallery-connect-Guides/agc-serverless-overview-0000001509965245)<font style="color:rgba(0, 0, 0, 0.9);">为底座、在传统的“端开发”基础上新增“云开发”能力，开发者在创建工程时选择合适的云开发工程模板，即可在DevEco Studio内同时完成HarmonyOS应用的端侧与云侧开发，体验端云一体化协同开发。</font>

:::

:::success
**端侧开发：**开发应用 -**<font style="color:#DF2A3F;">元服务目前不支持端云开发</font>**

:::

:::success
**云测开发：**目前Dev Studio包含 [**云函数**](https://developer.huawei.com/consumer/cn/doc/AppGallery-connect-Guides/agc-cloudfunction-introduction-0000001059279544) 和 [**云数据库**](https://developer.huawei.com/consumer/cn/doc/AppGallery-connect-Guides/agc-clouddb-introduction-0000001054212760) 的开发

:::

:::success
**特点：**

+ DevEco Studio一套开发工具即可支撑端侧与云侧同时开发，无需搭建服务器；
+ 依托AGC中Serverless云服务开放的接口，端侧开发人员能轻松操作云函数以及云数据库中的数据；
+ 直接接入AGC Serverless云服务，实现免运维，无运维成本或资源浪费。

:::



:::color2
<h2 id="jaAOm"><font style="color:rgba(0, 0, 0, 0.9);">工作原理</font></h2>
<font style="color:rgba(0, 0, 0, 0.9);">DevEco Studio支持开发者在本地完成云侧服务资源的开发与部署，并可在端侧工程中调用您开发的云侧代码，真正实现端云一体化开发。</font>

1. <font style="color:rgb(36, 39, 40);">选择合适的云开发模板，根据工程向导创建端云一体化开发工程。</font>
2. <font style="color:rgb(36, 39, 40);">分别进行云侧工程与端侧工程的代码开发与调试。</font>**<font style="color:rgb(36, 39, 40);">说明</font>**<font style="color:rgb(36, 39, 40);">云侧与端侧工程的代码可并行开发，一般无先后顺序。但若需在端侧代码中调用云侧Serverless服务，云侧Serverless服务代码必须先部署到AGC云端，因此建议您先完成云侧代码的开发、调试与部署，再进行端侧代码开发与调试。</font>
    1. <font style="color:rgb(36, 39, 40);">开发云侧工程：在云侧工程开发AGC Serverless服务，目前包括云函数和云数据库资源开发。</font>
        * <font style="color:rgb(36, 39, 40);">开发云函数：在DevEco Studio中创建并配置函数、开发函数代码、调试函数、部署函数到AGC云端。</font>
        * <font style="color:rgb(36, 39, 40);">开发云数据库：在DevEco Studio中创建对象类型、在对象类型中添加数据条目、部署云数据库到AGC云端。</font>
    2. <font style="color:rgb(36, 39, 40);">部署云侧工程：云侧工程代码全部开发调试完毕后，一键部署云侧工程到AGC云端。</font>
    3. <font style="color:rgb(36, 39, 40);">开发端侧工程：在端侧工程下开发您应用的业务代码。其中，端云一体化特性支持您：</font>
        * <font style="color:rgb(36, 39, 40);">在端侧调用您开发的云侧代码。</font>
        * <font style="color:rgb(36, 39, 40);">在端侧集成多种端云一体化组件，借助组件内置的云侧逻辑快速实现登录等特定场景的功能。</font>
3. <font style="color:rgb(36, 39, 40);">端云两侧工程代码全部开发完成后，将端云一体化工程打包成APP，提交至AGC申请上架。</font>

:::

+ 优势

![](https://secure2.wostatic.cn/static/hixbLn93KGFjL7UzS4PH54/image.png?auth_key=1708273890-xukEQX8fmv2yuCY391LYTH-0-a952b716f69acefa1ead8baf72d8ccca&x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 开发流程

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708658138262-3c38405f-2a94-41ba-bb99-02542703f5ee.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_56%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ AGC创建项目和应用

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942450641-30fbf061-9a0c-458c-8107-53bfcc20c160.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942463013-d2824cda-254a-4ede-949b-cffee321f294.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_44%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 添加应用

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942506754-91ab4c9d-f30a-486f-9108-4ff8125196b7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942534436-fc3fa963-0c3d-4bc5-86bd-e52a8c4b922a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 开启云数据库-云存储-认证服务的开关
+ 认证服务

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942808287-b9254c9c-baaf-46c7-9212-ead85862123e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_76%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 启用手机号认证

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942846597-7ee38fc2-2b6a-46ae-aa4f-2cb55544664a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_62%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 开启云存储

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942877504-7c7f4abe-ef19-4a3e-942a-391ad0a5501f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_46%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 填写存储实例

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942906563-bfac686c-48a9-4ad2-be26-f80c3730128e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942931816-c048cf97-6c47-48f8-be15-d1fbb64666d8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713942953977-4cdb5c6f-b7dd-4c15-9f7b-8ca651a134bf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_86%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
**<font style="color:#DF2A3F;">请注意：当前的用户只能有一个项目可以开启云存储，如果你建了两个项目，需要关闭其中一个项目的云存储才可以</font>**

:::

+ 开启云数据库

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713943149704-d1e83e84-93bf-4774-8da8-bb89a25cdd00.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



<h1 id="AawBs"> 创建项目 </h1>
:::color1
**<font style="color:#DF2A3F;">注意：Next版本元服务目前暂不支持端云化开发</font>**

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709284583339-4572b64d-d547-4e11-9469-272989adea7e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713949470803-59eb1dac-2a22-4373-bd6f-f51ee99b6ae7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713949493547-4a9ac145-e4fa-4823-8fcf-b8a0c908e893.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713949556612-0b35ad53-c413-4935-a3b4-409fd91f4279.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
**<font style="color:#DF2A3F;">注意： 同样需要使用提供的工具对项目进行依赖更新</font>**

:::

+ 运行项目

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1713949680763-0251e06a-3e49-4c3e-99af-2a6c33310bb9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
云模板已经帮我注册好了 用户认证-云存储-云数据库

:::

<h1 id="nXZUH">静态页面准备</h1>
:::color2
已经提供给大家一套写好的基本模板，大家直接将这套模板覆盖原有entry/src/main目录就可以

[main.zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727513328020-ec0bef68-73fb-4d8c-b063-2f4d843de8f9.zip)

:::

:::color2
**<font style="color:#DF2A3F;">页面中包含了基本的页面渲染和路由跳转还有一些弹窗的交互</font>**

:::

+ 解压后，覆盖项目中的 main文件夹 打开模拟器或者预览器

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1714122149521-a1a486f4-940b-40e7-ad60-48c66a06c0d8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="GqCon">初始化云db表结构和表数据</h1>
+ 打开AGC项目的云数据库

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715139306922-f28e7915-2ca8-4704-a14d-7035c507a17e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
+ 将表结构导入到云数据库中

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709280470169-616ca392-c9aa-46ef-89c1-afa0d4c7a049.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_17%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
云数据库结构

[schema.json](https://weiqi123.yuque.com/attachments/yuque/0/2024/json/32778948/1727513328026-ad314799-eebf-416a-975d-5ace28680d63.json)

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709280660567-5ef87cca-fc25-4b23-9df8-fee627612e73.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_33%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 导入后再导出一份项目可用的schema到对应的目录下

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715247840450-ca37c53b-2075-4158-85b5-5367321a53f4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ **<font style="color:#DF2A3F;">将导出的文件改名为schema.json</font>**放入到resources/rawfile目录下

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715224791798-5de17642-2771-4560-a0f9-fb9ee17bd9ee.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ 新增question存储区

:::color1
1. <font style="color:rgb(36, 39, 40);">登录</font>[AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)<font style="color:rgb(36, 39, 40);">网站，选择“我的项目”。</font>
2. <font style="color:rgb(36, 39, 40);">在项目列表页面中选择项目，点击项目下对应应用。</font>
3. <font style="color:rgb(36, 39, 40);">在导航树上选择“Serverless > 云数据库”。</font>
4. <font style="color:rgb(36, 39, 40);">点击“存储区”页签，点击“新增”，进入创建存储区页面。</font>

:::



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709281141650-98e706d2-f120-405b-bf92-657fa86fdb46.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 导入数据库数据

:::color2
[导入数据.zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727513328024-d4d98722-c401-4725-8e2b-1fdb4e4a75dc.zip)

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715154903959-e93959d9-7816-4691-b753-97755f97c240.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_48%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715154917619-233cb184-22eb-4547-a87c-dd9edf10d73f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_9%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715154938939-81ffa194-663a-4b43-8ef6-f2c8e806fdc4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715154964109-00d8dee1-eeec-4e47-ae86-ff23b7356d75.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715154983512-bf4fd6b4-9283-4402-829e-1fa8fff1f88d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_45%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
完成三个基本表的结构导入

:::

<h1 id="zKqru">下载对应的云端json到项目</h1>
+ 下载agconnect-services.json文件

:::color1
1. <font style="color:rgb(36, 39, 40);">登录</font>[AppGallery Connect](https://developer.huawei.com/consumer/cn/service/josp/agc/index.html)<font style="color:rgb(36, 39, 40);">网站，选择“我的项目”。</font>
2. <font style="color:rgb(36, 39, 40);">在项目列表页面中选择项目，点击项目下需要下载配置文件的应用。</font>
3. <font style="color:rgb(36, 39, 40);">在“项目设置 > 常规”页签中，下载</font>**<font style="color:rgb(36, 39, 40);">agconnect-services.json</font>**<font style="color:rgb(36, 39, 40);">文件。</font>

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709281221426-05187fff-ff72-4a4c-960d-23b1740297f5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
<font style="color:rgb(36, 39, 40);">将下载的</font>**<font style="color:rgb(36, 39, 40);">agconnect-services.json</font>**<font style="color:rgb(36, 39, 40);">文件拷贝到DevEco Studio项目的“AppScope/resources/rawfile”目录下。</font>

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709281441831-982c0d7a-97f5-4ac0-a2ed-3325aab37289.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="dPVXH">准备表的类型文件</h1>
:::color1
+ 将准备好的类型文件新建文件在models/question.ets中

:::

```typescript

// 试卷分类
export class  QuestionClassify {
  static className: string = "question_classify" // 表名
  id: number | null = null
  title: string = ""
  num: number  = 0
  image_url: string = ""
  remark: string = ""
  is_del: boolean = false
}
// 试卷
export class  QuestionPaper {
  static className: string = "question_paper"
  id: number | null = null
  classify_id: number = 0
  title: string = ""
  level: string  = ""
  order: number = 0
  remark: string = ""
}

// 试卷详情
export class  QuestionInfo {
  static className: string = "question_info"
  id: number | null = null
  classify_id: number = 0
  paper_id: number = 0
  title: string = ""
  order: number = 0
  question_type: string = ""
  answer_letter: string = ""
  right_answer_letter: string = ""
  answer_text: string = ""
  answer_solution: string = ""
}

// 试卷用户回答
export class  QuestionUserAll {
  static className: string = "question_user_all"
  id: number | null = null
  classify_id: number = 0
  paper_id: number = 0
  is_done: boolean = false
  score: number = 0
  start_time: Date = new Date()
  end_time: Date = new Date()
  user_id: string = ""
  remark: string = ""
}

// 用户回答的每个题目的详情
export class  QuestionUserAnswer {
  static className: string = "question_user_answer"
  id: number | null = null
  classify_id: number = 0
  question_info_id: number = 0
  paper_id: number = 0
  is_right: boolean = false
  answer_time: Date = new Date()
  user_id: string = ""
  user_answer: string = ""
}

// 用户信息
export class  UserInfo {
  static className: string = "user_info"
  id: number | null = null
  avatar: string = ""
  nick_name: string = ""
  user_id: string = ""
}
//
export enum QuestionTypeEnum {
  Judge = "1", // 判断
  Single = "2", // 单选
  Multi =  "3" // 多选
}

export class QuestionScoreDisplay extends QuestionUserAll {
  avatar: string = ""
  nick_name: string = ""
  constructor(obj: QuestionUserAll, avatar: string, nick_name: string) {
    super()
    this.avatar = avatar
    this.nick_name = nick_name
    this.id = obj.id
    this.classify_id = obj.classify_id
    this.paper_id = obj.paper_id
    this.user_id = obj.user_id
    this.is_done = obj.is_done
    this.start_time = obj.start_time
    this.end_time = obj.end_time
    this.remark = obj.remark
    this.score = obj.score
  }
}

export class UserCollect {
  all_people: number = 0
  all_wrong: number = 0
}


export interface AnswerItem {
  letter: string  // 选项的标识
  select: boolean  // 是否被选择
  letter_text: string  // 选项和标识的组合
}
@Observed
export class AnswerItemModel implements AnswerItem {
  letter: string = ''
  select: boolean = false
  letter_text: string = ''

  constructor(model: AnswerItem) {
    this.letter = model.letter
    this.select = model.select
    this.letter_text = model.letter_text
  }
}

```

+ 在models/index.ets中统一导出

```typescript
export * from './question'
```

:::color1
使用git进行托管

:::



<h1 id="r4GxR">判断当前用户是否已经登录</h1>
+ 打开AGC认证服务
+ ![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715156814924-b2ff638e-e25e-4d4e-927b-3937cb4f7132.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_52%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
+ 利用AGC的API监测当前用户的登录状态

:::

+ 使用一个key在常量文件中（common/index）

```typescript
  static readonly USER_AUTH_KEY = "user_auth_key" // 用户首选项的key

```

+ 新建一个首选项的类用来监测用户的登录状态

```typescript
import preferences from '@ohos.data.preferences'
import { Constants } from '../common'

export class UserSetting {
  static context?: Context

  // 获取用户首选项的仓库
  static getUserStore() {
    return preferences.getPreferencesSync(UserSetting.context || getContext(), {
      name: Constants.USER_STORE_KEY
    })
  }

  // 获取用户是否认证  布尔值
  static getUserAuth() {
    const store = UserSetting.getUserStore()
    const key = store.getSync(Constants.USER_AUTH_KEY, "") as string
    return !!key
  }
  // 设置用户auth
  static async setUserAuth (authValue: string) {
    const store = UserSetting.getUserStore()
    store.putSync(Constants.USER_AUTH_KEY, authValue)
    await store.flush()
  }
}
```

+ 在Ability中判断当前是否已经登录，登录跳转主页，否则跳转登录页

```typescript
async onWindowStageCreate(windowStage: Window.WindowStage) {
    // Main window is created, set main page for this ability
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageCreate');

    await this.initAgc()
    const win = windowStage.getMainWindowSync()
    win.setWindowLayoutFullScreen(true) // 设置全屏
     const topHeight = win.getWindowAvoidArea(Window.AvoidAreaType.TYPE_SYSTEM).topRect.height
     const bottomHeight = win.getWindowAvoidArea(Window.AvoidAreaType.TYPE_NAVIGATION_INDICATOR).bottomRect.height
    AppStorage.setOrCreate("topHeight", px2vp(topHeight))
    AppStorage.setOrCreate("bottomHeight", px2vp(bottomHeight))
    let toPath = Constants.PAGE_LOGIN
    UserSetting.context = this.context // 赋值上下文
    if(UserSetting.getUserAuth()) {
      // 已经登录过了
      toPath = Constants.PAGE_INDEX // 换成主页
    }
    windowStage.loadContent(toPath, (err, data) => {
      if (err.code) {
        hilog.error(0x0000, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '');
        return;
      }
      hilog.info(0x0000, 'testTag', 'Succeeded in loading the content. Data: %{public}s', JSON.stringify(data) ?? '');
    });
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709525686497-5a8f48ce-1045-4b7b-85d2-874e44b65cbd.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
提交代码

:::

<h1 id="cebVt">发送验证码逻辑</h1>
:::color1
当没有AGC登录时，我们需要实现手机号 

:::

+ 声明手机号和验证码字段

```typescript
  @State
  mobile: string = "13912345678"
  @State
  code: string = ""
```

+ 双向绑定字段

```typescript
  TextInput({ placeholder: '请输入手机号', text: $$this.mobile })
          .commonStyle()
          .height(48)

        Stack({ alignContent: Alignment.End }) {
          TextInput({ placeholder: '请输入验证码', text: $$this.code })
            .commonStyle()
            .height(48)
          Text('获取验证码')
            .fontSize(13)
            .fontColor( $r("app.color.send_disable_color"))
        }
```

+ 获取验证码校验手机号

```typescript
sendCode () {
    if(this.checkMobile()) {
    }else {
      promptAction.showToast({ message: '手机号不存在或格式真正确' })
    }
  }
```

+ 手机号合法控制发送验证码可点

```typescript
// 检查手机号合法
  checkMobile () {
    return !!(this.mobile && new RegExp('^1[3-9]\\d{9}$').test(this.mobile))
  }
```

+ 根据状态控制

```typescript
 Text('获取验证码')
            .fontSize(13)
            .fontColor(this.checkMobile() ? $r("app.color.send_code_color") : $r("app.color.send_disable_color"))
            .enabled(this.checkMobile())
            .onClick(() => {
               this.sendCode()
            })
```

+ 引入cloud包

```typescript
import cloud, { VerifyCodeAction } from '@hw-agconnect/cloud'

```

+ 使用cloud云发送验证码到手机

```typescript
sendCode () {
    cloud.auth().requestVerifyCode({
      action: VerifyCodeAction.REGISTER_LOGIN,
      lang: 'zh_CN',
      sendInterval: 60,
      verifyCodeType: {
        phoneNumber: this.mobile,
        countryCode: '86',
        kind: "phone"
      }
    })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709536282618-c37397cd-794c-4099-90c3-4b81d268d0f2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 实现发送倒计时

```typescript
@State
timeCount: number = 60 // 倒计时
timer: number = -1
async sendCode () {
    if(this.checkMobile()) {
      if(this.timeCount < 60) return
     await cloud.auth().requestVerifyCode({
        action: VerifyCodeAction.REGISTER_LOGIN,
        lang: 'zh_CN',
        sendInterval: 60,
        verifyCodeType: {
          phoneNumber: this.mobile,
          countryCode: '86',
          kind: "phone"
        }
      })
      this.beginRunCount()
    }else {
      promptAction.showToast({ message: '手机号不存在或格式真正确' })
    }
  }
   beginRunCount () {
   this.timer = setInterval(() => {
      if(this.timeCount === 0) {
        clearInterval(this.timer) // 清理定时器
        this.timeCount = 60 // 恢复60 回到当初
        return
      }
      this.timeCount--
    }, 1000)
  }
```

+ 发送按钮进行显示和控制

```typescript
  Text(this.timeCount < 60 ? `还剩${this.timeCount}秒`  : '获取验证码')
            .fontSize(13)
            .fontColor(this.timeCount < 60 ? $r("app.color.send_disable_color") : $r("app.color.send_code_color") )
            .margin({
              right: 10
            })
            .enabled(this.checkMobile() && this.timeCount === 60)
            .onClick(() => {
              this.sendCode()
            })
```





:::color1
提交代码

:::



<h1 id="G3hUH">AGC登录逻辑</h1>
:::color1
+ 检查手机号和验证码
+ 发起登录请求-华为云登录

:::

+ 检查验证码合法性

```typescript
// 检查验证码合法性
  checkCode () {
    return !!(this.code && new RegExp('^\\d{6}$').test(this.code))
  }
```

+ 控制登录按钮状态

```typescript
  Button('登录')
          .enabled(true)
          .commonButtonStyle()
          .enabled(this.checkCode() && this.checkMobile())
          .onClick(() => {
            this.login()
          })
```

+ 实现登录

```typescript
async login () {
    await cloud.auth().signIn({
      credentialInfo: {
        kind: 'phone',
        phoneNumber: this.mobile,
        countryCode: '86',
        verifyCode: this.code
      }
    })
    promptAction.showToast({ message: '登录成功' })

  }
```

+ 登录成功后获取用户信息

```typescript
async login() {
    try {
      await cloud.auth().signIn({
        credentialInfo: {
          kind: 'phone',
          phoneNumber: this.mobile,
          countryCode: '86',
          verifyCode: this.code
        }
      })
      promptAction.showToast({ message: '登录成功' })
      const user = await cloud.auth().getCurrentUser()
      AlertDialog.show({ message: JSON.stringify(user) })
    } catch (error) {
      promptAction.showToast({ message: error.message })
    }

  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709538353347-32f6a851-9a81-4ff4-8c18-1f3cb8730115.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 存入首选项和全局状态

```typescript
 async login() {
    try {
      // 实现云登录
      const result = await cloud.auth().signIn({
        credentialInfo: {
          kind: "phone",
          countryCode: '86',
          phoneNumber: this.mobile,
          verifyCode: this.code
        }
      })
      // 说明此时登录成功
      // AlertDialog.show({ message: JSON.stringify(result) })
      // 拿到用户的信息
      const currentUser = result.getUser()
      UserSetting.setUserAuth(JSON.stringify(currentUser)) // 写入首选项
      // 写入全局状态
      AppStorage.setOrCreate<AuthUser>(Constants.USER_AUTH_KEY, currentUser)
      promptAction.showToast({ message: '登录成功' })
      router.pushUrl({
        url: Constants.PAGE_INDEX
      })
    } catch (error) {
      promptAction.showToast({ message: error.message })
    }
  }
```

+ 为了能够在进入应用之后可以获取当前用户状态

```typescript
 if (await UserSetting.getUserAuth()) {
      toPath = Constants.PAGE_INDEX
      AppStorage.setOrCreate<AuthUser>(Constants.USER_AUTH_KEY,  await cloud.auth().getCurrentUser())
    }
```

+ 登录成功跳转到主页

```typescript
  router.pushUrl({
        url: Constants.PAGE_INDEX
      })
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709538620536-6bf821ab-fc64-4b82-9619-19559f4615e3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 离开时清除定时器

```typescript
aboutToDisappear(): void {
    clearInterval(this.timer)
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709538765169-d20efa48-684b-4573-ab64-b6a3ede0366f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
提交代码

:::



<h1 id="sS22s">个人中心信息获取和登出操作</h1>
:::success
通过AppStorage进行获取用户信息

显示用户信息内容

:::

+ 在UserCenter页面进行初始化

```typescript
  @StorageProp(Constants.USER_AUTH_KEY)
  currentUser: AuthUser = new AuthDefaultUser()
```

+ 初始化后获取上次登录时间

```typescript
 @State
  lastLoginTime: string = ""
  aboutToAppear(): void {
    this.getLastLoginTime()
  }
  async getLastLoginTime() {
    this.lastLoginTime = this.timestampToDateTime(parseInt((await this.currentUser.getUserExtra()).getLastSignInTime()))
  }
 transDate(timeStamp: number) {
    const date = new Date(timeStamp)
    return date.toLocaleDateString() + " " + date.toLocaleTimeString()
  }
```

+ 替换手机和登录时间

```typescript
 Column() {
          Column() {
            this.getCardItem({ leftTitle: '手机号码', rightValue: this.currentUser.getPhone() })
            this.getCardItem({ leftTitle: '上次登录时间', rightValue: this.lastLoginTime })
          }
          .borderRadius(8)
          .clip(true)
        }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1710215966318-a4350654-c253-4dff-a19a-260c858256d1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 登出操作

```typescript

 // 登出方法
  async logout() {
    await cloud.auth().signOut()
    await UserSetting.setUserAuth("")
    AppStorage.set(Constants.USER_AUTH_KEY, new AuthDefaultUser())
    // 跳回login页面
    router.replaceUrl({
      url: Constants.PAGE_LOGIN
    })
  }
```

:::success
提交代码

:::

<h1 id="KxfaT">更新用户昵称</h1>
:::success
获取昵称

:::

+ 声明数据

```typescript
 @State
  avatar: string = ""
  @State
  displayName: string = ""
```

+ 初始化获取资料

```typescript
aboutToAppear(): void {
    this.getLastLoginTime()
    this.getUserProfile()
}
 async getUserProfile () {
    this.displayName =  this.currentUser.getDisplayName()
    this.avatar =  this.currentUser.getPhotoUrl()
  }
```

+ 更新字段

```typescript
Text(this.displayName || "未命名")
                .fontSize(16)
                .fontWeight(400)
                .fontColor($r("app.color.text_main_color"))
                .margin({ top: 12 })
                .onClick(() => {
                  this.showSheet = true
                })
```

:::success
更新昵称

:::

+ 绑定bindSheet

```typescript
.bindSheet($$this.showSheet, this.getSheetContent, {
      height: '40%'
    })
```

+ 定义一个存储的字段

```typescript
  @State
  copyDisplayName: string = ""
```

+ 渲染sheet

```typescript
@Builder
  getSheetContent() {
    Column({ space: 20 }) {
      TextInput({
        text: $$this.copyDisplayName,
        placeholder: '请输入您的昵称'
      })
        .width('100%')
      Button("修改昵称")
        .backgroundColor($r("app.color.blue_light_color"))
        .width("100%")
        .onClick(() => {
          this.updateDisplayName()
        })

    }
    .height('100%')
    .padding(20)
  }
```

+ 实现更新的方法

```typescript
  async updateDisplayName() {
    if (this.copyDisplayName) {
      try {
        await this.currentUser.updateProfile({
          displayName: this.copyDisplayName,
          photoUrl: this.avatar.trim() || "https://q1.itc.cn/q_70/images03/20240304/b00ebfdfb3ba40b989185a5ae90496e7.jpeg" // 头像如果为空是更新不上去的
        })
        this.copyDisplayName = "" // 清空输入的值
        this.getUserProfile() // 重新获取用户的资料
        promptAction.showToast({ message: '更新成功' })
        this.showSheet = false // 关闭弹层
      } catch (error) {
        promptAction.showToast({ message: error.message })
      }
    }

  }
```

:::success
提交代码

:::



<h1 id="KzHmR">更新用户头像</h1>
:::success
点击头像选择图片

:::

```typescript
 Image(this.avatar || $r('app.media.user_dark'))
                .width(64)
                .aspectRatio(1)
                .borderRadius(32)
                .interpolation(ImageInterpolation.High)//减轻低清晰度图片在放大显示时出现的锯齿问题
                .onError(() => {
                  this.avatar = "http://img1.baidu.com/it/u=3697703651,4111071712&fm=253&app=138&f=JPEG?w=683&h=707"
                })
                .onClick(() => {
                   this.selectImg()
                })
```

+ 选择头像方法

```typescript
async selectImg() {
    try {
      let selectPhoto = new picker.PhotoViewPicker()
      const result = await selectPhoto.select({
        maxSelectNumber: 1,
        MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE
      })
      if (result.photoUris.length) {
        let fileName =  util.generateRandomUUID() + '.jpg'
        await cloud.storage().upload({
          localPath: result.photoUris[0],
          cloudPath: fileName
        })
        this.avatar = await cloud.storage().getDownloadURL(fileName)
        this.copyDisplayName = this.displayName
        this.updateDisplayName()
      }
    } catch (error) {
      promptAction.showToast({ message: error.message })
    }
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1710298880493-5fbfc168-ff40-4c61-9ae3-e6d24ded4c71.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
提交代码

:::



<h1 id="SA7aH">建立对数据库的访问基础类</h1>
:::color1
数据库访问文档： [https://developer.huawei.com/consumer/cn/doc/AppGallery-connect-Guides/agc-clouddb-sdk-integration-harmonyosts-0000001626112738](https://developer.huawei.com/consumer/cn/doc/AppGallery-connect-Guides/agc-clouddb-sdk-integration-harmonyosts-0000001626112738)

:::

:::color1
新建一个services目录，index.ets统一导出

:::

+ 新建services/common.ets

:::color1
统一导出的数据库的管理对象

:::

```typescript
import buffer from '@ohos.buffer';
import cloud, { Database, ObjectTypeInfo } from '@hw-agconnect/cloud';
import promptAction from '@ohos.promptAction';

export class CloudDataBase {
  static currentDataBase: Database | null

  static async getCloudDataBase() {
    if (!CloudDataBase.currentDataBase) {
      try {
        const context = getContext()
        const value = await context.resourceManager.getRawFileContent('schema.json');
        let json: string = buffer.from(value as ArrayBufferLike).toString("utf8");
        CloudDataBase.currentDataBase = cloud.database({
          objectTypeInfo: JSON.parse(json) as ObjectTypeInfo,
          zoneName: "question"
        })
      }catch (error) {
        promptAction.showToast({ message: error.message })
      }

    }
    return CloudDataBase.currentDataBase
  }
}
```

<h1 id="tzJ9T">更新昵称和头像到自己的用户表</h1>
:::success
因为认证用户的昵称和头像我们无法管控，所以我们需要在更新头像或者昵称之后，进行一些处理存入自己的数据库

:::

+ 封装更新用户头像service-services/user.ets

```typescript
// UserInfo 增删改查
import { CloudDataBase } from '.'
import { UserInfo } from '../models'

export class UserService {
  // 获取用户的信息
  static async getUserInfoUserId(userId: string) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await dataBase?.collection<UserInfo>(UserInfo)
      .query()
      .limit(1)
      .equalTo("user_id", userId)
      .get()
    return result // 返回拿到的结果
    // 拿到了用户的这张表
  }

  // 更新用户的信息
  static async updateUserInfo(user: UserInfo) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await dataBase?.collection<UserInfo>(UserInfo)
      .upsert(user)
    return result
  }
}
```

+ 在用户中心定义用户对象

```typescript
  @State
  user: UserInfo = new UserInfo()
```

+ 在初始化后获取数据

```typescript
 aboutToAppear(): void {
    ...
    this.getOwnUserInfo()
  }
async getOwnUserInfo () {
    const result = await UserServices.getUserInfoByUserId(this.currentUser.getUid())
    if(result && result.length) {
      this.user = result[0]
    }
  }
```

+ 更新昵称或头像后 更新自己信息

```typescript
 async updateDisplayName() {
    if (this.copyDisplayName) {
      try {
        // 云认证更新
        await this.currentUser.updateProfile({
          displayName: this.copyDisplayName,
          photoUrl: this.avatar.trim() ||
            "https://q1.itc.cn/q_70/images03/20240304/b00ebfdfb3ba40b989185a5ae90496e7.jpeg" // 头像如果为空是更新不上去的
        })
        this.user.avatar = this.avatar
        this.user.nick_name = this.copyDisplayName
        this.user.user_id = this.currentUser.getUid()
        // 更新云数据库
        await UserService.updateUserInfo(this.user) // 有id就是更新没有id就是新增
        this.getOwnUserInfo() // 重新拉一下
        // 重新拉取一下数据库的用户信息
        this.copyDisplayName = "" // 清空输入的值
        this.getUserProfile() // 重新获取用户的资料
        promptAction.showToast({ message: '更新成功' })
        this.showSheet = false // 关闭弹层
      } catch (error) {
        promptAction.showToast({ message: error.message })
      }
    }

  }
```

:::success
提交代码

:::

<h1 id="nbbla">试题大类获取</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709539278384-0baee91e-03c4-4be1-b585-413be94f17b1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ 获取问题分类

:::color1
按照顺序查找没有被删除的试题分类

:::

```typescript
import { CloudDataBase } from './common'
import { QuestionClassify } from '../models'

export class QuestionClassifyService {
  // 获取数据分类
  static async getQuestionClassify() {
    const database = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionClassify>(QuestionClassify).query().equalTo("is_del", false).orderByAsc("id").get()
  }
}
```

+ 在QList中初始化后获取数据

```typescript
aboutToAppear(): void {
    this.getQuestionClassify()
  } 
async getQuestionClassify() {
    const result = await QuestionClassifyService.getQuestionClassify()
    AlertDialog.show({ message: JSON.stringify(result) })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709543068796-f13beb3d-74e9-4227-b8bf-73dcaeafaf5e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)





:::color1
根据试题分类渲染对应的数据

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709543368545-4768dd3a-b55e-4d8a-938b-dedb94980931.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 声明数据

```typescript
 @State
  classifyList: QuestionClassify[] = []
```

+ 获取数据赋值

```typescript
 async getQuestionClassify() {
    this.classifyList = await QuestionClassifyService.getQuestionClassify()
  }
```

+ 循环渲染

```typescript
  ForEach(this.classifyList, (item:  QuestionClassify, index: number) => {
          ClassifyItem({ item })
        })
```

+ 子组件接收item数据

```typescript
import { QuestionClassify } from '../../models'

@Component
export struct ClassifyItem {
  item: QuestionClassify = new QuestionClassify()

  build() {
    Flex() {
      Image(this.item.image_url || $r('app.media.ic_cover1'))
        .alignSelf(ItemAlign.Center)
        .height(80)
        .width(60)
        .borderRadius(10)

      Column() {
        Column() {
          Text(this.item.title)
            .fontSize(14)
            .fontWeight(500)
            .textAlign(TextAlign.Start)
        }
        .alignSelf(ItemAlign.Start)
        .margin({ left: 10, top: 8 })

        Row() {
          Text('0')
            .fontColor('#3266EE')
            .fontSize(12)
            .fontWeight(400)
          Text(`/${this.item.num}节 | 已学进度：10%`)
            .fontColor($r("app.color.gray_color"))
            .fontSize(12)
            .fontWeight(400)
        }
        .width(137)
        .alignSelf(ItemAlign.Start)
        .margin({ top: 24, left: 10 })

        Divider()
          .alignSelf(ItemAlign.Start)
          .margin({ left: 10, top: 6 })
      }
    }
    .height(96)
    .backgroundColor(Color.White)
    .borderRadius(9)
    .padding(10)

  }
}
```

:::color1
提交代码

:::

<h1 id="gB67b">大类分类章节读取数据</h1>
:::color1
点击一个试题大类，进入大类的章节

:::

+ 注册点击事件跳转

```typescript
  ClassifyItem({ item })
            .onClick(() => {
              router.pushUrl({ url: Constants.PAGE_PAPER_LIST, params: { classifyId: item.id } })
            })
```

+ 在models/common.ets中添加一个公共的路由参数类型

```typescript
export interface CommonRouterParams {
  classifyId?: number
}
```

+ 在Classify/PaperList.ets中读取对应的id

```typescript
aboutToAppear(): void {
    this.getChapterList()
  }
  async getChapterList () {
   const params = router.getParams() as CommonRouterParams
    AlertDialog.show({  message: params.classifyId!.toString() })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709546507549-502ec4bb-999e-4beb-9c2b-1eeac7c0d97c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
+ 封装读取分类章节的service
+ 在初始化调用赋值
+ 循环渲染对应的数据

:::

+ 封装读取分类章节的service-根据order正序排列

```typescript
import { QuestionPaper } from '../models'
import { CloudDataBase } from './common'

export class QuestionPaperService {
  static async getQuestionPaperList (classifyId: number) {
    const database  = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionPaper>(QuestionPaper)
      .query()
      .orderByAsc("order")
      .equalTo("classify_id", classifyId)
      .get()
  }
}
```

+ 在试卷页面读取

```typescript
 @State
  list: QuestionPaper[] = []

  aboutToAppear(): void {
    this.getPaperList()
  }

  async getPaperList() {
    const params = router.getParams() as CommonRouterParams
    if (params && params.classifyId) {
      this.list = await QuestionPaperService.getQuestionPaperList(params.classifyId)
    }
  }

```

+ 循环渲染数据

```typescript
   List() {
          ForEach(this.list, (item: QuestionPaper) => {
            ListItem() {
              PaperItem({ item })
                .onClick(async () => {
                  router.pushUrl({
                    url: Constants.PAGE_ANSWER_DETAIL
                  })
                })
            }
          })
        }
```

+ 在PaperItem组件中使用item

```typescript

  item: QuestionPaper = new QuestionPaper()
```

+ 替换对应内容

```typescript
import { QuestionPaper } from '../../models'
@Preview
@Component
struct PaperItem {

  item: QuestionPaper = new QuestionPaper()
  build() {
    Column({ space: 20 }) {
      Text(this.item.title)
        .alignSelf(ItemAlign.Start)
      Row() {
        this.tagBuilder(this.item.level)
        Blank()
        Row() {
          Text('暂未做题').fontSize(13)
            .fontColor($r("app.color.gray_color"))
        }
      }
      .width('100%')
    }
    .width('100%')
    .padding({ top: 20, left: 15, right: 15, bottom: 20 })
  }

  @Builder
  tagBuilder(title: string) {
    Text(title)
      .fontColor($r("app.color.right_full_color"))
      .backgroundColor($r("app.color.right_half_color"))
      .fontSize(12)
      .padding({ top: 3, left: 8, right: 8, bottom: 3 })
  }
}

export default PaperItem
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709551829900-4ba07570-b487-4f27-9b5a-ab9785dbf66b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
提交代码

:::



<h1 id="eeZwB">点击试卷进入试题列表</h1>
+ 点击试卷进入试题列表

```typescript
              PaperItem({ item })
                .onClick(async () => {
                  router.pushUrl({
                    url: Constants.PAGE_ANSWER_DETAIL,
                    params: {
                      classifyId: item.classify_id,
                      paperId: item.id
                    }
                  })
                })
```

+ 定义参数

```typescript
export interface CommonRouterParams {
  classifyId?: number
  paperId?: number
}
```

+ 在答题页面接收参数

```typescript
aboutToAppear(): void {
    this.getQuestionList()
  }

  // 获取答题题目
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    AlertDialog.show({ message: JSON.stringify(params) })
  }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709619495766-d1006dbc-968c-4aec-8bc0-e04c92d406f1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ 封装获取题目的service-services/question_info.ets

```typescript
import { QuestionInfo } from '../models'
import { CloudDataBase } from './common'

export class QuestionInfoService {
  static async getQuestionInfoList(classifyId: number, paperId: number) {
    const database = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionInfo>(QuestionInfo)
      .query()
      .equalTo("classify_id", classifyId)
      .equalTo("paper_id", paperId)
      .orderByAsc("order")
      .get()
  }
}
```

+ 在初始化后调用

```typescript
 @State
  list: QuestionInfo[] = []

  aboutToAppear(): void {
    this.getQuestionList()
  }

  // 获取答题题目
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.list = await QuestionInfoService.getQuestionInfoList(params.classifyId, params.paperId)
      AlertDialog.show({
        message: JSON.stringify(this.list)
      })
    }
  }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715247885547-aeee5949-fc45-4edb-ac8d-de8a37ece38e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
提交代码

:::

<h1 id="QHe9d">试卷题目渲染</h1>
+ 定义当前题目索引

```typescript
 @State
 currentIndex: number  = 0 // 当前在做题目
```

+ 封装获取当前题目的方法

```typescript
// 获取当前题目
  getCurrentQuestion () {
    if(this.list.length && this.currentIndex > -1 && this.currentIndex < this.list.length) {
      return this.list[this.currentIndex]
    } 
    return null
  }
```

+ 渲染题目内容

```typescript
 if (this.getCurrentQuestion()) {
            // 题目类型
            Row() {
              Text(this.getQuestionTypeText(this.getCurrentQuestion()!.question_type as QuestionTypeEnum))
                .fontSize(12)
                .fontColor(Color.Gray)
                .padding({ top: 2, bottom: 2, left: 10, right: 10 })
                .backgroundColor(Color.White)
            }
            .width('100%')

            // 题目内容
            Column({ space: 16 }) {
              Text(`${this.currentIndex + 1}. ${this.getCurrentQuestion()!.title}` )
                .width('100%')
              Column({ space: 8 }) {
                ForEach(JSON.parse(this.getCurrentQuestion()!.answer_text) as string[], (label: string) => {
                  AnswerItem({ label, isSelected: false })
                })
              }
            }
            .width('100%')
            .margin({ top: 10 })
          }
```

+ 根据类型渲染不同的文本

```typescript
 // 判断类型获取内容
  getQuestionTypeText(value: QuestionTypeEnum) {
    switch (value) {
      case QuestionTypeEnum.Judge:
        return "判断"
      case QuestionTypeEnum.Single:
        return "单选"
      case QuestionTypeEnum.Multi:
        return "多选"
    }
  }
```

+ 渲染当前进度和数量

```typescript
   Row() {
            Progress({ value: (this.currentIndex + 1), total: 10 })
              .margin({ right: 10 })
              .layoutWeight(1)
            Text() {
              Span((this.currentIndex + 1).toString())
                .fontWeight(900)
                .fontColor(Color.Gray)
              Span(`/${this.list.length}`)
                .fontWeight(900)
                .fontColor('#c4c4c4')
            }
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceBetween)
          .alignItems(VerticalAlign.Center)
```

+ AnswerItem渲染选项结构

```typescript
import { AnswerItemModel } from '../../models'

@Preview
@Component
export default struct AnswerItem {
  label: string = ""
  isSelected: boolean = false

  build() {
    Stack() {
      if(this.isSelected) {
        Row()
          .width('100%')
          .height('100%')
          .linearGradient({ colors: [['#00bffa', 0], ['#0074f4', 1]] })
          .borderRadius(10)
      }
      Row() {
        Text() {
          Span(this.label)
        }
        .fontColor(this.isSelected ? $r('app.color.white') : $r('app.color.black'))
      }
      .width('100%')
      .height('100%')
      .padding(15)
    }
    .width('100%')
    .height(50)
    .backgroundColor($r('app.color.option_item_color'))
    .borderRadius(10)
  }
}
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715248817322-5fd0fb00-8dc8-4f4a-a275-86dab98e47ce.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
提交代码

:::

<h1 id="XlVYP">上一题和下一题</h1>
+ 封装上一题和下一题的两个方法

```typescript
 // 上一题
  lastQuestion () {
    if(this.currentIndex > 0) {
      this.currentIndex--
    }
  }
  // 下一题
  nextQuestion () {
    if(this.currentIndex < this.list.length - 1) {
      this.currentIndex++
    }
  }
```

+ 绑定点击事件

```typescript
  Row() {
            Row() {
              Image($r('app.media.ic_left'))
                .width(18)
                .aspectRatio(1)
                .margin({ right: 15 })
              Text('上一题')

            }
            .layoutWeight(1)
            .onClick(() => {
              this.lastQuestion()
            })


            Row() {
              Text('下一题')
                .margin({ right: 15 })
              Image($r('app.media.ic_right'))
                .width(18)
                .aspectRatio(1)
            }
            .justifyContent(FlexAlign.End)
            .layoutWeight(1)
            .onClick(() => {
              this.nextQuestion()
            })

          }
          .height(50)
          .width('100%')
```

+ 控制按钮的状态

```typescript
 // 上一题
  lastQuestion () {
    if(this.getLastEnable()) {
      this.currentIndex--
    }
  }
  // 下一题
  nextQuestion () {
    if(this.getNextEnable()) {
      this.currentIndex++
    }
  }
  // 获取上一个的状态
  getLastEnable () {
    return this.currentIndex > 0
  }
  // 获取下一个的状态
  getNextEnable () {
    return this.currentIndex < this.list.length - 1
  }
```

+ 控制颜色

```typescript
 Row() {
            Row() {
              Image($r('app.media.ic_left'))
                .fillColor(this.getLastEnable() ? $r("app.color.text_main_color") : $r("app.color.gray_color"))
                .width(18)
                .aspectRatio(1)
                .margin({ right: 15 })
              Text('上一题')
                .fontColor(this.getLastEnable() ? $r("app.color.text_main_color") : $r("app.color.gray_color"))

            }
            .layoutWeight(1)
            .onClick(() => {
              this.lastQuestion()
            })


            Row() {
              Text('下一题')
                .fontColor(this.getNextEnable() ? $r("app.color.text_main_color") : $r("app.color.gray_color"))
                .margin({ right: 15 })
              Image($r('app.media.ic_right'))
                .fillColor(this.getNextEnable() ? $r("app.color.text_main_color") : $r("app.color.gray_color"))
                .width(18)
                .aspectRatio(1)
            }
            .justifyContent(FlexAlign.End)
            .layoutWeight(1)
            .onClick(() => {
              this.nextQuestion()
            })

          }
          .height(50)
          .width('100%')
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709623828684-9eb8b56e-56c2-4d9b-a1cd-2683cb74075d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
提交代码

:::



<h1 id="pr8F1">答题选择选项</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709700550232-dc064106-045e-4c23-9144-5ebf82472c25.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)‘

:::success
当点击选项时，选中当前选项，此时该数据应该进行响应式驱动

:::

+ 在models/question.ts声明一个答案选项的类型

```typescript

export interface AnswerItem {
   letter: string  // 选项的标识
   select: boolean  // 是否被选择
   letter_text: string  // 选项和标识的组合
}
@Observed
export class AnswerItemModel implements AnswerItem {
  letter: string = ''
  select: boolean = false
  letter_text: string = ''

  constructor(model: AnswerItem) {
    this.letter = model.letter
    this.select = model.select
    this.letter_text = model.letter_text
  }
}

```

+ 声明一个变量存储当前题目的选项

```typescript
  @State
  currentOptions: AnswerItemModel[] = []
```

+ 封装一个方法获取当前题目的选项

```typescript
// 获取当前选项的一个方法
  getCurrentOptions() {
    // 拿当前题目
    const question = this.getCurrentQuestion()
    if (question) {
      this.currentOptions = [] // 先设置为空
      const labelList = JSON.parse(question.answer_text) as string[]
      const letterList = JSON.parse(question.answer_letter) as string[]
      labelList.forEach((item: string, index: number) => {
        this.currentOptions.push(new AnswerItemModel({
          letter: letterList[index],
          letter_text: labelList[index],
          select: false
        }))
      })
    }
  }
```

+ 在初始化后调用和切题后调用

```typescript
 // 获取答题题目
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.list = await QuestionInfoService.getQuestionInfoList(params.classifyId, params.paperId)
      this.getCurrentOptions() // 获取当前选项
    }
  }
 // 上一题
  lastQuestion() {
    if (this.getLastEnable()) {
      this.currentIndex--
      this.getCurrentOptions() // 获取当前选项
    }
  }

  // 下一题
  nextQuestion() {
    if (this.getNextEnable()) {
      this.currentIndex++
      this.getCurrentOptions() // 获取当前选项
    }
  }
```

+ 在子组件AnswerItem中使用该属性

```typescript
import { AnswerItemModel } from '../../models'

@Preview
@Component
export default struct OptionItem {
  @ObjectLink
  item: AnswerItemModel
  build() {
    Stack() {
      if (this.item.select) {
        Row()
          .width('100%')
          .height('100%')
          .linearGradient({ colors: [['#00bffa', 0], ['#0074f4', 1]] })
          .borderRadius(10)
      }
      Row() {
        Text() {
          Span(this.item.letter_text)
        }
        .fontColor(this.item.select ? $r('app.color.white') : $r('app.color.black'))
      }
      .width('100%')
      .height('100%')
      .padding(15)
    }
    .width('100%')
    .height(50)
    .backgroundColor($r('app.color.option_item_color'))
    .borderRadius(10)
  }
}
```

+ 在点击选项后切换状态

```typescript

                  AnswerItem({ item: item })
                    .onClick(() => {
                      item.select = !item.select
                    })
                }, (item: AnswerItemModel, index: number) =>  this.currentIndex + "_" + index + "_" + JSON.stringify(item) )
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709709708842-de846e9c-e77b-4285-85ba-fcbb45713be8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
提交代码

:::



<h1 id="LNtKj">根据题目类型进行互斥处理</h1>
:::success
+ 判断题只能有一个选项
+ 单选题只能有一个选项
+ 多选题可以有多个选项

:::

+ 封装一个选择选项的方法

```typescript
 // 根据不同的题目类型进行不同的互斥处理
  selectAnswer (item: AnswerItemModel) {
    const question = this.getCurrentQuestion()
    if(question) {
      // 单选和判断场景下 有互斥
      if(question.question_type === QuestionTypeEnum.Judge || question.question_type === QuestionTypeEnum.Single) {
        // 互斥处理
        // 根据当前选中状态来判断
        if(!item.select) {
          // 这种情况下需要互斥
          this.currentOptions.forEach(obj => {
            obj.select = false // 全部关闭
          })
          item.select = true // 只让当前点击的选中
        }
      }else {
        item.select = !item.select // 该怎么样还怎么样
      }
    }

  }

```

+ 在点击选项时调用

```typescript
 ForEach(this.currentOptions, (item: AnswerItemModel) => {
                  // 槽点 如果子组件的类型是ObjectLink 那么不能使用es6的省略属性写法
                  AnswerItem({ item: item })
                    .onClick(() => {
                      // item.select = !item.select
                      this.selectAnswer(item) // 选择某个题目
                    })
                }, (item: AnswerItemModel, index: number) => this.currentIndex + "_" + index + "_" +
                JSON.stringify(item))
```

:::success
注意，这里使用了key,因为在循环时 选项存在重复，需要加上试题的唯一性id才可以避免完全性重复

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709711126833-8133beb4-3f96-4703-9e30-97d0042586c0.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
提交

:::

<h1 id="jKwEa">答案入库</h1>


:::success
当点击完成题目之后

+ 判断是否满足入库条件
+ 入库
+ 下次进入直接读取答案
+ 反馈到选项上

:::

+ 封装services/question_user_answer.ets

```typescript
// 导出类
import { CloudDataBase } from '.'
import { QuestionUserAnswer } from '../models'

export class QuestionUserAnswerService {
  // 获取所有答案的题目列表
  static async getAnswerList(classifyId: number, paperId: number, userId: string) {
    const database = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionUserAnswer>(QuestionUserAnswer)
      .query()
      .equalTo("classify_id", classifyId)
      .equalTo("paper_id", paperId)
      .equalTo("user_id", userId)
      .orderByAsc("answer_time")// 回答时间
      .get()
  }

  // 增加或者更新某个题目的答案
  static async upsertQuestionAnswer(answer: QuestionUserAnswer) {
    const database = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionUserAnswer>(QuestionUserAnswer)
      .upsert(answer)
  }
}
```

+ 声明所有答案-当前用户-用户当前答案的变量

```typescript
@State
  allAnswer: QuestionUserAnswer[] = [] // 存储用户对于这个试卷的所有题目的答案
  @StorageProp(Constants.USER_AUTH_KEY)
  currentUser: AuthUser = new AuthDefaultUser()
  @State
  userAnswer: QuestionUserAnswer = new QuestionUserAnswer() // 用来入库的对象

```

+ 进入题目获取当前的答案

```typescript
 // 获取所有的答案
  async getAllAnswer() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      // 拿到所有的答案
      this.allAnswer =
        await QuestionUserAnswerService.getAnswerList(params.classifyId, params.paperId, this.currentUser.getUid())
      await this.initCurrentAnswer() // 初始化答案
    }
  }
```



+ 初始化当前回答的选择

```typescript
  // 初始化当前问题的选项 目的是 当选择完毕之后 直接去入库
  initCurrentAnswer() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.userAnswer = new QuestionUserAnswer() // 每次初始化时 重新new一下
      this.userAnswer.classify_id = params.classifyId // 大类id
      this.userAnswer.paper_id = params.paperId // 试卷id
      this.userAnswer.question_info_id = this.getCurrentQuestion()!.id! // 当前题目的id
      this.userAnswer.user_id = this.currentUser.getUid() // 用户id
      // 此时还需要从答案中找出 我是否已经入库了答案 如果入库了 把答案反选上去
      if (this.allAnswer.length) {
        const item = this.allAnswer.find(item => item.question_info_id === this.userAnswer.question_info_id)
        // 找答案 如果能够找到
        if (item) {
          this.userAnswer = item // 直接赋值item
          // 入库就是更新
          const res = JSON.parse(item.user_answer) as string[] // 用户的答案 还是数组 "['A', 'B']"
          res.forEach(letter => {
            this.currentOptions.find(item => item.letter === letter)!.select = true
          })
        }
        // 如果找不到 入库就是新增

      }

    }

  }
```

+ 在获取题目-切题时调用该方法

```typescript

// 获取题目的列表
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.list = await QuestionInfoService.getQuestionList(params.classifyId, params.paperId)
      this.getCurrentOptions()
      this.getAllAnswer() // 获取所有答案
    }
  }
 // 上一题
  lastQuestion() {
    if (this.getLastEnable()) {
      this.currentIndex--
      this.getCurrentOptions() // 获取当前选项
      this.initCurrentAnswer() // 初始化用户答案
    }
  }

  // 下一题
  async nextQuestion() {
    if (this.getNextEnable()) {
      this.currentIndex++
      this.getCurrentOptions() // 获取当前选项
      this.initCurrentAnswer() // 初始化用户答案
    }
  }
```

+ 当选择题目之后入库

```typescript
  // 入库
  async writeUserAnswer() {
    // 当前的选项都得至少有一个选项被选中才可以入库
    const values = this.currentOptions.filter(item => item.select === true) // 拿到当前选项为true的集合
    if (values.length) {
      try {
        // 可以提交了
        const question = this.getCurrentQuestion()
        this.userAnswer.user_answer = JSON.stringify(values.map(item => item.letter).sort()) // 答案是什么 ["A"]
        this.userAnswer.answer_time = new Date() // 回答时间
        this.userAnswer.is_right = question?.right_answer_letter === this.userAnswer.user_answer // 这个题答没答对
        // 自己的答案和题目的答案进行一下对比
        await QuestionUserAnswerService.upsertQuestionAnswer(this.userAnswer) // 答案入库
      } catch (error) {
        AlertDialog.show({ message: "答案写入异常," + error.message })
      }

    }
  }
```

+ 在选择题目之后执行

```typescript
// 根据不同的题目类型进行不同的互斥处理
  async selectAnswer(item: AnswerItemModel) {
    const question = this.getCurrentQuestion()
    if (question) {
      // 单选和判断场景下 有互斥
      if (question.question_type === QuestionTypeEnum.Judge || question.question_type === QuestionTypeEnum.Single) {
        // 互斥处理
        // 根据当前选中状态来判断
        if (!item.select) {
          // 这种情况下需要互斥
          this.currentOptions.forEach(obj => {
            obj.select = false // 全部关闭
          })
          item.select = true // 只让当前点击的选中
        }
      } else {
        item.select = !item.select // 该怎么样还怎么样
      }
    }
    // 主要选择完了答案 不论选择的对不对 都要去检查能不能入库
    await this.writeUserAnswer()
    await this.getAllAnswer() // 重新获取一下所有的答案

  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709716380945-de7281ac-8946-4d11-9b12-c398bb6fbf54.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::success
提交代码

:::

<h1 id="kztkk">交卷状态控制</h1>
:::success
当进行到最后一题时，

+ 检查是否所有题目都进行了作答
+ 显示提交答案按钮
+ 写入最终结算表

:::

+ 在services/question_user_answer.ets中实现获取所有题目答案的方法

```typescript
// 是否所有答案都有结果
  static async getIsAllAnswer(classifyId: number, paperId: number, userId: string) {
    const questionList = await QuestionInfoService.getQuestionList(classifyId, paperId)
    // 查入库的答案
    const database = await CloudDataBase.getCloudDataBase()
    const result = await database!.collection<QuestionUserAnswer>(QuestionUserAnswer)
      .query()
      .equalTo("classify_id", classifyId)
      .equalTo("paper_id", paperId)
      .equalTo("user_id", userId)
      .In("question_info_id", questionList.map(item => item.id))
      .get()
    return result.length === questionList.length
  }
```

+ 定义状态控制交卷按钮

```typescript
  @State
  showSubmit: boolean  = false // 控制交卷按钮
```

+ 封装检查可交卷的方法

```typescript
// 检查可交卷
  async checkCanSubmit() {
    const params = router.getParams() as CommonRouterParams
    // 最后一
    this.showSubmit = await QuestionUserAnswerService.getIsAllAnswer(params.classifyId!, params.paperId!, this.currentUser!.getUid())
  }
```

+ 获取完题目进行检查

```typescript
// 获取答题题目
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.list = await QuestionInfoService.getQuestionInfoList(params.classifyId, params.paperId)
      this.getCurrentOptions() // 获取当前选项
      await this.getAllAnswer()
      this.initCurrentAnswer()
      this.checkCanSubmit()
    }
  }
```

+ 答完题后检查状态

```typescript
 // 选择选项
  async selectAnswer(item: AnswerItemModel) {
    const question = this.getCurrentQuestion()
    if (question) {
      if (question.question_type === QuestionTypeEnum.Judge || question.question_type === QuestionTypeEnum.Single) {
        // 需要互斥
        if (!item.select) {
          this.currentOptions.forEach(item => {
            item.select = false
          })
          item.select = true
        }
      } else {
        item.select = !item.select
      }
    }
    // 写入用户答案
    await this.writeUserAnswer()
    await this.getAllAnswer() // 重新获取所有答案
    this.checkCanSubmit()

  }

```

+ 根据状态控制交卷按钮显示

```typescript
 if (this.showSubmit) {
            Row() {
              Button("交卷查看结果", {
                type: ButtonType.Normal
              })
                .borderRadius(48)
                .width(200)
                .height(48)
                .backgroundColor($r("app.color.send_code_color"))

            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({
              top: 20
            })
          }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709718940043-cd1897ca-fe41-49c0-9c5c-43abd1de473b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
检查交卷状态

:::



<h1 id="iQxPv">交卷提交跳转</h1>
:::success
交卷

+ 添加交卷记录
+ 跳转到结果页面

:::

+ 封装用户答题记录的services/question_user_all.ets

```typescript
import { QuestionUserAll } from '../models/question'
import { CloudDataBase } from './common'

export class QuestionUserAllService {
  static async upsertQuestionUserAll(item: QuestionUserAll) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = dataBase!.collection<QuestionUserAll>(QuestionUserAll)
      .upsert(item)
    return result
  }
}
```

+ 交卷逻辑

```typescript
  // 交卷
  async submitPaper() {
    // 写入结构
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      const userResult = new QuestionUserAll()
      userResult.classify_id = params.classifyId
      userResult.paper_id = params.paperId
      userResult.user_id = this.currentUser.getUid()
      userResult.start_time = this.allAnswer[0].answer_time
      userResult.end_time = new Date()
      userResult.is_done = true // 是否做完了
      userResult.score =
        parseFloat(((this.allAnswer.filter(item => item.is_right).length / this.list.length) * 100).toFixed(2))

      await QuestionUserAllService.upsertQuestionUserAll(userResult)
      promptAction.showToast({ message: '交卷成功' })
      //  this.allAnswer // 所有的答案
      router.replaceUrl({
        url: Constants.PAGE_ANSWER_RESULT,
        params
      })
    }


  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709723210433-3f54d31a-b1cc-4a09-9fd7-c87f5d808123.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
提交代码

:::

<h1 id="GCQbK">获取答题结果</h1>
:::success
如果之前已经交过卷，此时应该直接进入答题结果页面

:::

+ 在获取用户信息之后，检查交卷状态

```typescript
  PaperItem({ item })
                .onClick(async () => {
                  const result = await QuestionUserAllService.getQuestionUserDetail(item.classify_id, item.id!, this.currentUser!.getUid())
                  if(result && result.length) {
                    router.pushUrl({
                      url: Constants.PAGE_ANSWER_RESULT,
                      params: {
                        classifyId: item.classify_id,
                        paperId: item.id
                      }
                    })
                  }else {
                    router.pushUrl({
                      url: Constants.PAGE_ANSWER_DETAIL,
                      params: {
                        classifyId: item.classify_id,
                        paperId: item.id
                      }
                    })
                  }
                })
```



:::success
+ 根据分类id，试卷id, 用户id获取答题结果
+ 渲染内容

:::

+ 封装获取答题结果的services/question_user_all.ets

```typescript
static async getQuestionUserDetail(classifyId: number, paperId: number, userId: string) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = dataBase!.collection<QuestionUserAll>(QuestionUserAll)
      .query()
      .equalTo("classify_id", classifyId)
      .equalTo("paper_id", paperId)
      .equalTo("user_id", userId)
      .get()
    return result
  }
```

+ 封装读取分类详情的services/question_classify.ets

```typescript
// 获取数据分类详细的id
  static async getQuestionClassifyDetail(classifyId: number) {
    const database = await CloudDataBase.getCloudDataBase()
    return database!.collection<QuestionClassify>(QuestionClassify).query()
      .equalTo("is_del", false)
      .equalTo("id", classifyId)
      .get()
  }
```

+ 引入相关依赖

```typescript
import { AuthDefaultUser } from '@hw-agconnect/cloud/src/main/ets/auth/user/AuthDefaultUser'
import { AuthUser } from '@hw-agconnect/cloud'
import { QuestionUserAllService, QuestionClassifyService, QuestionUserAnswerService } from '../../services'
import { CommonRouterParams, QuestionUserAll, QuestionClassify, QuestionUserAnswer } from '../../models'
```

+ 在答题结果初始化中获取

```typescript
  @StorageProp(Constants.USER_AUTH_KEY)
  currentUser: AuthUser = new AuthDefaultUser()
  @State
  allAnswer: QuestionUserAnswer[] = [] // 存储用户对于这个试卷的所有题目的答案
  @State
  questionUserAll: QuestionUserAll = new QuestionUserAll()
  @State
  questionClassify: QuestionClassify = new QuestionClassify()

  aboutToAppear(): void {
    this.getAllAnswer()
  }

  // 获取所有的答案
  async getAllAnswer() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      const res = await QuestionClassifyService.getQuestionClassifyDetail(params.classifyId)
      if (res.length) {
        this.questionClassify = res[0]
      }
      const list =
        await QuestionUserAllService.getQuestionUserDetail(params.classifyId, params.paperId, this.currentUser.getUid())
      if (list.length) {
        this.questionUserAll = list[0] // 拿结果
      }
      // 拿到所有的答案
      this.allAnswer =
        await QuestionUserAnswerService.getAnswerList(params.classifyId, params.paperId, this.currentUser.getUid())
    }
  }
```

+ 渲染数据

```typescript
  getTimeRange () {
    if(this.answerList.length > 0) {
      return (((this.answerList[this.answerList.length- 1].answer_time).getTime() -
      (this.answerList[0].answer_time).getTime()) / (1000 * 60))
        .toFixed(0)
    }
    return  ""
  }
   build() {
    Navigation() {
      Column() {
        Scroll() {
          Column() {
            // 得分
            Column() {
              Stack({ alignContent: Alignment.Bottom }) {
                Gauge({ value: this.questionUser.score, min: 0, max: 100 })
                  .startAngle(-90)
                  .endAngle(90)
                  .colors([[$r("app.color.blue_light_color"),  this.questionUser.score ], [$r("app.color.gray_full_color"), 100 - this.questionUser.score]])
                  .strokeWidth(10)
                  .width(200)
                Column() {
                  this.smallText('得分')
                  Text(this.questionUser.score.toString())
                    .fontSize(35)
                    .fontWeight(900)
                  this.smallText('/100')
                  Row() {
                    this.smallText('练习类型:')
                    Text(this.questionClassify.title)
                      .fontSize(12)
                      .fontColor(Color.Gray)
                  }
                  .width('100%')
                  .padding({ top: 50, bottom: 10 })
                  .justifyContent(FlexAlign.SpaceBetween)

                  Row() {
                    this.smallText('交卷时间:')
                    Text(this.questionUser.end_time.toLocaleString())
                      .fontSize(12)
                      .fontColor(Color.Gray)
                  }
                  .width('100%')
                  .justifyContent(FlexAlign.SpaceBetween)
                }
              }
            }
            .padding(20)
            .width('100%')
            .backgroundColor(Color.White)
            .borderRadius(10)
            .margin({
              top: 20
            })

            // 考试情况
            Column() {
              Text('考试情况')
                .width('100%')
                .fontWeight(600)
                .padding({ top: 20, bottom: 10 })
              Row() {
                this.examItem({ title: '总题数', num: this.answerList.length.toString(), unit: "题" ,fontColor: $r("app.color.blue_light_color")})
                this.examItem({ title: '答对', num: this.answerList.filter(item => item.is_right).length.toString(), unit: '题', fontColor: $r("app.color.right_full_color")  }  )
                this.examItem({ title: '答错', num: this.answerList.filter(item => !item.is_right).length.toString(), unit: '题', fontColor: $r("app.color.error_full_color") })
                this.examItem({ title: '总用时', num: this.getTimeRange(), unit: 'min', fontColor: $r("app.color.error_full_color") } )
              }
              .width('100%')
              .justifyContent(FlexAlign.SpaceBetween)
              .backgroundColor(Color.White)
              .padding(20)
              .borderRadius(10)
            }


            // 答题卡
            Column() {
              Text('答题卡')
                .width('100%')
                .fontWeight(600)
                .padding({ top: 30, bottom: 10 })
              Column() {
                Row({ space: 15 }) {
                  Text('题目')
                    .layoutWeight(1)
                    .fontSize(14)
                  Row({ space: 8 }) {
                    Text()
                      .size({ width: 12, height: 12 })
                      .borderRadius(8)
                      .backgroundColor($r("app.color.gray_full_color"))
                    Text('未答')
                      .fontSize(12)
                  }

                  Row({ space: 8 }) {
                    Text()
                      .size({ width: 12, height: 12 })
                      .borderRadius(8)
                      .backgroundColor($r("app.color.right_full_color"))
                    Text('答对')
                      .fontSize(12)
                  }

                  Row({ space: 8 }) {
                    Text()
                      .size({ width: 12, height: 12 })
                      .borderRadius(8)
                      .backgroundColor($r("app.color.error_full_color"))
                    Text('答错')
                      .fontSize(12)
                  }
                }
                .width('100%')
                .padding(15)

                // 答题卡选项
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.answerList, (item: QuestionUserAnswer, index: number) => {
                    Row() {
                      Text((index + 1).toString())
                        .textAlign(TextAlign.Center)
                        .fontColor(Color.White)
                        .size({ width: 40, height: 40 })
                        .borderRadius(20)
                        .backgroundColor(this.getOptionColor(item.is_right))
                    }
                    .justifyContent(FlexAlign.Center)
                    .width('20%')
                    .aspectRatio(1)
                    .onClick(() => {
                      router.pushUrl({
                        url: Constants.PAGE_ANSWER_DETAIL
                      })
                    })
                  })
                }
              }
              .backgroundColor(Color.White)
              .borderRadius(10)
            }
          }
          .padding({ left: 15, right: 15, bottom: 50 })
          .width('100%')

        }
        .layoutWeight(1)
        Row() {
          Button("重新刷题")
            .width('60%')
            .onClick(async () => {
              router.replaceUrl({
                url: Constants.PAGE_ANSWER_DETAIL
              })
            })
            .backgroundColor($r("app.color.send_code_color"))
        }
        .justifyContent(FlexAlign.Center)
        .width('100%')
        .height(70)
        .backgroundColor($r("app.color.white"))
      }
      .height('100%')
    }
    .titleMode(NavigationTitleMode.Mini)
    .title("答题结果")
    .padding({
      top: AppStorage.get("topHeight"),
      bottom: AppStorage.get("bottomHeight")
    })
    .linearGradient({
      colors: [
        ['#ccdffc', 0],
        [$r("app.color.gray_light_color"), 1]
      ]
    })
  }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709870775828-86b22ef4-06a4-4ff1-8281-999009d2ba9c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::success
提交代码

:::

<h1 id="x9teL">点击查看题目详情</h1>
:::success
点击对应的错题，进入题目详情查看答案

+ 注册题目的点击事件
+ 传入分类id, 试卷id，题目id
+ 在答题详情根据参数读取参数，并设置索引，并且对应只读状态
+ 显示答案

:::

+ 将获取所有答案的排序字段换成题目的id

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1716628405229-8cb87253-a8eb-4005-8d06-612d6b345ee7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_27%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ 给公共路由参数增加index属性

```typescript
export interface CommonRouterParams {
  classifyId?: number
  paperId?: number
  questionId?: number
}
```

+ 注册题目序号点击事件

```typescript
 .onClick(() => {
                      router.pushUrl({
                        url: Constants.PAGE_ANSWER_DETAIL,
                        params: {
                          classifyId: item.classify_id,
                          paperId: item.paper_id,
                          questionId: item.question_info_id
                        }
                      })
                    })
```

+ 声明一个状态用来控制答题只读状态

```typescript
@State
isReadOnly: boolean = false // 是否只读状态
```

+ 答题页面根据传入参数判断是否只读状态

```typescript
 // 获取答题题目
  async getQuestionList() {
    const params = router.getParams() as CommonRouterParams
    if (params.classifyId && params.paperId) {
      this.list = await QuestionInfoService.getQuestionInfoList(params.classifyId, params.paperId)
      if(params.questionId) {
        this.isReadOnly = true
        this.currentIndex = this.list.findIndex(item => item.id === params.questionId)
      }
      this.getCurrentOptions() // 获取当前选项s
      await this.getAllAnswer()
      this.initCurrentAnswer()
      this.checkCanSubmit()

    }
  }
```

+ 根据只读状态控制

:::success
1. 不可以改变题的选择
2. 不可以显示交卷
3. 显示答案

:::

+ 在读题模式下不可答题

```typescript
 ForEach(this.currentOptions, (item: AnswerItemModel) => {
                  AnswerItem({ item: item })
                    .onClick(() => {
                      !this.isReadOnly && this.selectAnswer(item)
                    })
                }, (item: AnswerItemModel) => this.getCurrentQuestion()!.id + '_' + JSON.stringify(item))
```

+ 读题模式下不显示交卷

```typescript
 if (this.showSubmit && !this.isReadOnly) {
            Row() {
              Button("交卷查看结果", {
                type: ButtonType.Normal
              })
                .borderRadius(48)
                .width(200)
                .height(48)
                .backgroundColor($r("app.color.send_code_color"))
                .onClick(() => {
                  this.submitPaper()
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({
              top: 20
            })
          }
```

+ 显示答案

```typescript
 if (this.isReadOnly) {
            Column({ space: 10 }) {
              // 显示答案
              Text("答案")
                .fontColor($r("app.color.text_main_color"))
                .width('100%')

              Row({ space: 20 }) {
                Row({ space: 2 }) {
                  Text("正确答案: ")
                    .fontColor($r("app.color.text_main_color"))
                  Text((JSON.parse(this.getCurrentQuestion()!.right_answer_letter) as string[]).join(",") )
                    .fontColor($r("app.color.right_full_color"))
                }

                Row({ space: 2 }) {
                  Text("您的答案: ")
                    .fontColor($r("app.color.text_main_color"))
                  Text((JSON.parse(this.userAnswer.user_answer || '[]') as string[]).join(",") )
                    .fontColor(this.userAnswer.is_right ? $r("app.color.right_full_color")
                      : $r("app.color.error_full_color")
                    )
                }
              }
              .width('100%')
              Text("解析: ")
                .fontColor($r("app.color.text_main_color"))
                .width('100%')
              Row({ space: 2 }) {
                Text(this.getCurrentQuestion()!.answer_solution)
                  .fontColor($r("app.color.right_full_color"))
              }
              .width('100%')
            }
            .width('100%')
            .padding(10)
            .margin({
              top: 50
            })
          }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1709887268599-fba57230-3b6b-4953-8ba6-a210341d1244.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::success
提交代码

:::

<h1 id="M80uk">重新答题</h1>
:::success
在结果页中，点击重新刷题，可以删除之前的答题记录，并重新答题

:::

+ 封装删除某个大类，某个试卷的所有的答题结果的services/question_user_answer.ets

```typescript
// 删除某个大类的某个试卷的题目
  static async delAllAnswer (answerList: QuestionUserAnswer[]) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await  dataBase!.collection<QuestionUserAnswer>(QuestionUserAnswer)
      .delete(answerList)
    return result
  }
```

+ 封装删除用户答题结果的services/question_user_all.ets

```typescript
 // 删除用户答题结果
  static async delQuestionUserAll(result: QuestionUserAll) {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const res = dataBase!.collection<QuestionUserAll>(QuestionUserAll)
      .delete(result)
    return res
  }
```

+ 点击重新答题-删除答案-重新进入答题

```typescript
Button("重新刷题")
            .width('60%')
            .onClick(async () => {
              await QuestionUserAnswerService.delAllAnswer(this.answerList)
              await QuestionUserAllService.delQuestionUserAll(this.questionUser)
              router.replaceUrl({
                url: Constants.PAGE_ANSWER_DETAIL,
                params: router.getParams()
              })
            })
            .backgroundColor($r("app.color.send_code_color"))
```

:::success
提交代码

:::



<h1 id="FxrdU">首页刷题排名</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1710300076504-763110cb-333d-41fa-aa29-111ebd3a6e81.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ 封装获取所有成绩的services/question_user_all.ets

```typescript
 // 获取所有人答题成绩排名 前6名
  static async getAllUserTop () {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await dataBase!.collection<QuestionUserAll>(QuestionUserAll)
     .query()
     .orderByDesc("score")
     .limit(6)
     .get()
    return result
  }
```

+ 实现一个展示类的继承封装

```typescript
export class QuestionScoreDisplay extends QuestionUserAll {
  avatar: string = ""
  nick_name: string = ""
  constructor(obj: QuestionUserAll, avatar: string, nick_name: string) {
    super()
    this.avatar = avatar
    this.nick_name = nick_name
    this.id = obj.id
    this.classify_id = obj.classify_id
    this.paper_id = obj.paper_id
    this.user_id = obj.user_id
    this.is_done = obj.is_done
    this.start_time = obj.start_time
    this.end_time = obj.end_time
    this.remark = obj.remark
    this.score = obj.score
  }
}
```

+ 实现读取每个人的头像和昵称

```typescript
 // 获取所有人答题成绩排名 前6名
  static async getAllUserTop () {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await dataBase!.collection<QuestionUserAll>(QuestionUserAll)
     .query()
     .orderByDesc("score")
     .limit(6)
     .get()
    let index = 0
    let arr: QuestionScoreDisplay[] = []
    while (index < result.length) {
     const userResult = await dataBase!.collection<UserInfo>(UserInfo)
        .query()
        .equalTo("user_id", result[index].user_id)
        .get()
      arr.push(new QuestionScoreDisplay(result[index], userResult.length ? userResult[0].avatar: '', userResult.length ? userResult[0].nick_name: '' ))
      index++
    }
    return arr
  }
```

+ 在排名中获取数据

```typescript
 @State
  list: QuestionScoreDisplay[] = []
  aboutToAppear(): void {
    this.getAllUserTop()
  }
  async getAllUserTop () {
    this.list = await QuestionUserAllService.getAllUserTop()
  }
```

+ 渲染内容

```typescript
  ForEach(this.list, (item: QuestionScoreDisplay, index: number) => {
                this.TopListItem(item, index)
              })
```

+ 渲染结构

```typescript
  @Builder
  TopListItem(item: QuestionScoreDisplay, index: number) {
    Stack({ alignContent: Alignment.Start }) {
      if (index === 0) {
        Image($r("app.media.ic_1"))
          .height(48)
      } else if (index == 1) {
        Image($r("app.media.ic_2"))
          .height(48)
      } else if(index === 2) {
        Image($r("app.media.ic_3"))
          .height(48)
      }else {
        Text((index + 1).toString())
          .margin({
            left: 18
          })
      }
      Row({ space: 8 }) {
        Image(item.avatar || $r("app.media.waiter"))
          .height(40)
          .aspectRatio(1)
          .borderRadius(20)
        Text(item.nick_name)
          .fontSize(13)
          .fontWeight(400)
        Blank()
        Text(item.score + '')
      }
      .padding({ left: 65 })
      .width('100%')
    }
    .clip(false)
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1710315736009-c45e93d6-5058-455c-a5ff-dfd05e983729.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
提交代码

:::



<h1 id="irGNQ">统计在线答题人数和错题集合</h1>
+ 声明一个class

```typescript
export class UserCollect {
  all_people: number = 0 
  all_wrong: number = 0
}
```

+ 封装services-models/question_user_all.ets

```typescript
// 统计所有交卷的人
  static async getUserCollect() {
    const dataBase = await CloudDataBase.getCloudDataBase()
    const result = await dataBase!.collection<QuestionUserAll>(QuestionUserAll)
      .query()
      .get()
    // 对result进行分组
    let map: Record<string, boolean> = {}
    result.forEach(item => {
      if (!map[item.user_id]) {
        map[item.user_id] = true
      }
    })
    const wrongResult = await dataBase!.collection<QuestionUserAnswer>(QuestionUserAnswer)
      .query()
      .equalTo("is_right", false)
      .get()
    let obj = new UserCollect()
    obj.all_people = Object.keys(map).length
    obj.all_wrong = wrongResult.length
    return obj
  }
```

+ 在初始化调用

```typescript
 @State
  collect: UserCollect = new UserCollect()
  aboutToAppear(): void {
    this.getCollect()
  }
  async getCollect() {
    this.collect = await QuestionUserAllService.getUserCollect()
  }
```

+ 替换内容

```typescript
   Text(this.collect.all_people + '人参与')
                .width(74)
                .textAlign(TextAlign.Center)
                .fontSize(11)
                .fontColor('#979797')

  Text(this.collect.all_wrong +'道错题')
                  .width(64)
                  .textAlign(TextAlign.Center)
                  .fontSize(11)
                  .fontColor('#979797')
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1710316742222-84a9b3f5-4000-41bc-afc5-4b5e3ed05ac6.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::success
提交代码

:::



<h1 id="iCG48">实时同步</h1>
:::color2
当更新数据之后，答题之后，更新首页的排行榜

:::

+ 提交答题结果触发

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715413285307-7435e2f5-4b2b-4716-879f-609be3b6c81b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ Top页面监听事件 更新数据

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1715413336201-72113cb4-94a0-4290-96cc-5fcf9cb94404.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

