:::color2
ä»£ç ä»“åº“åœ°å€ï¼š [https://gitee.com/shuiruohanyu/wechat_02](https://gitee.com/shuiruohanyu/wechat_02)

:::

:::color2
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªç»¼åˆæ€§çš„å¤§æ¡ˆä¾‹æ¥å®ç°å¾®ä¿¡èŠå¤©åŠŸèƒ½ï¼Œé‡Œé¢æ¶‰åŠéŸ³è§†é¢‘å¤„ç†-ç…§ç›¸æœºå¤„ç†-å’Œå¸¸è§„çš„ä¸€äº›æ“ä½œ

:::

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1708400191768-004e418e-df30-40a7-996c-7d04c868875a.gif)

<h1 id="jbVhS">åˆ›å»ºä¸€ä¸ªwechaté¡¹ç›®</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707399175439-1b6a2cec-e637-4532-ba19-a4d44dfd4d34.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_56%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
ä½¿ç”¨API12çš„ç¼–è¾‘å™¨éœ€è¦æ›´æ–°ä¾èµ–

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711781429319-db422dbc-2a9c-4225-b7a9-5a365c9347be.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_24%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

:::color2
å°†è®²ä¹‰ä¸­çš„å›¾ç‰‡æ·»åŠ åˆ°resources/base/mediaç›®å½•ä¸‹

[å›¾ç‰‡.zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727514411340-ed32bd8f-e810-44f6-a2e7-39a5f35f5455.zip)

:::

+ æ‹·è´æ‰€æœ‰å›¾ç‰‡ 

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707399227379-ad437bcb-c766-4f29-ba13-0971cd030d2a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ å¯¼å…¥æ‰€æœ‰åŸºæœ¬è‰²å€¼åˆ°color.jsonä¸­

```typescript
{
  "color": [
    {
      "name": "start_window_background",
      "value": "#FFFFFF"
    },
    {
      "name": "primary",
      "value": "#1AAD19"
    },
    {
      "name": "second_primary",
      "value": "#a9ea7a"
    },
    {
      "name": "text_primary",
      "value": "#2A2929"
    },
    {
      "name": "text_second",
      "value": "#818181"
    },
    {
      "name": "back_color",
      "value": "#ededed"
    },
    {
      "name": "second_back_color",
      "value": "#f6f6f6"
    },
    {
      "name": "border_color",
      "value": "#f4f5f6"
    },
    {
      "name": "danger",
      "value": "#e75f58"
    },
    {
      "name": "white",
      "value": "#ffffff"
    },
    {
      "name": "bottom_color",
      "value": "#a4a4a4"
    },
    {
      "name": "bottom_voice_color",
      "value": "#515151"
    },
    {
      "name": "voice_back_color",
      "value": "#CC3E3E3E"
    },
    {
      "name": "voice_round_color",
      "value": "#323232"
    },
    {
      "name": "voice_round_font_color",
      "value": "#919191"
    },
    {
      "name": "chat_primary",
      "value": "#8aec71"
    },
    {
      "name": "animate_voice_color",
      "value": "#4a8040"
    },
    {
      "name": "black",
      "value": "#000000"
    },
    {
      "name": "popup_back",
      "value": "#4d4d4d"
    },
    {
      "name": "location_back",
      "value": "#80767676"
    },
    {
      "name": "pay_back",
      "value": "#57ab70"
    }
  ]
}
```

+ ä¿®æ”¹é¡¹ç›®çš„åç§°

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707401810937-f152a884-1ff1-432b-be23-cb0ab65d6500.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_34%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
å¦‚æœä½ ä¹Ÿæƒ³ä¿®æ”¹è‹±æ–‡ç¯å¢ƒä¸‹çš„ï¼Œå¯ä»¥åŒæ—¶ä¿®æ”¹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707401854840-78469bc7-bdb3-4592-828a-201bf933fc6f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_33%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ ä½¿ç”¨API12çš„ç¼–è¾‘å™¨æ¥ç”Ÿæˆå›¾æ ‡

:::color2
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711782191689-13cbcee3-28b2-4ee2-bd48-fcccfc84b10b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

æœ€ç»ˆé€‰ç”¨æœ€å¤§çš„å›¾æ ‡æ›¿æ¢mediaç›®å½•ä¸‹çš„foreground.png

:::



+ ä½¿ç”¨gitç®¡ç†

:::color2
å»ºç«‹ä¸€ä¸ªä»“åº“ï¼Œä½¿ç”¨gitç®¡ç†è¯¥é¡¹ç›®

:::

+ åœ¨é¡¹ç›®ç›®å½•ä¸‹æ‰§è¡Œ

```bash
$ git init 
```

+ é€šè¿‡DevEcoStudioè‡ªå¸¦çš„gitè¿›è¡Œæäº¤å’Œæ¨é€

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707401579166-e08b2d21-21c4-43a6-bd57-585528eee4d5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_20%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="YthHA">æ­å»ºåŸºç¡€éª¨æ¶é¡µé¢</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707401903671-ee2bcf8f-cf66-4023-9d49-54d19738a673.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
é¦–å…ˆå®ç°ä¸»é¡µä¸­å››ä¸ªåŸºæœ¬çš„tabç»„ä»¶ï¼Œå¹¶ä¸”èƒ½å¤Ÿå®ç°åˆ‡æ¢æ—¶æ ·å¼çš„å˜åŒ–

:::

+ åœ¨ets/modelsç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªtab.etsæ–‡ä»¶

```typescript
// tabså›¾æ ‡
export class TabBarClass {
  title: string = ""
  name: string = ""
  icon: ResourceStr = ""
  selectIcon: ResourceStr = ""
}
```

+ å…¥å£æ–‡ä»¶ pages/Index.ets

:::color2
å®šä¹‰å››ä¸ªtabbaræ•°æ®

:::

```typescript
import { TabBarClass } from '../models/tab'

@State
  tabList: TabBarClass[] = [{
    icon: $r('app.media.ic_public_message'),
    name: 'wechat',
    title: 'å¾®ä¿¡',
    selectIcon: $r('app.media.ic_public_message_filled')
  }, {
    icon: $r('app.media.ic_public_contacts_group'),
    name: 'connect',
    title: 'è”ç³»äºº',
    selectIcon:  $r('app.media.ic_public_contacts_group_filled')
  }, {
    icon: $r('app.media.ic_gallery_discover'),
    name: 'discover',
    title: 'å‘ç°',
    selectIcon: $r('app.media.ic_gallery_discover_filled')
  }, {
    icon: $r('app.media.ic_public_contacts'),
    name: 'my',
    title: 'æˆ‘çš„',
    selectIcon: $r('app.media.ic_public_contacts_filled')
  }]
```

+ æ ¹æ®æ•°æ®åŠ¨æ€å£°æ˜å››ä¸ªtab

```typescript
  @State
  currentIndex: number = 0
  @Builder
  CommonTabBar (item: TabBarClass) {
    Column () {
      Image(this.tabList[this.currentIndex].name === item.name ? item.selectIcon : item.icon )
        .width(20)
        .height(20)
      Text(item.title)
        .fontSize(12)
        .fontColor(item.name === this.tabList[this.currentIndex].name  ? $r('app.color.primary') : $r('app.color.text_primary'))
        .margin({
          top: 5
        })
    }
  }
build() {
    Tabs({ index: $$this.currentIndex }) {
      ForEach(this.tabList, (item: TabBarClass) => {
        TabContent() {
          Text(item.title)
        }.tabBar(this.CommonTabBar(item))

      }, (item: TabBarClass) => item.name.toString())
    }.barPosition(BarPosition.End)
    .animationDuration(300)
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707411927336-b0986ab2-e0d7-4364-a2d2-1a5554adba45.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_19%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
æäº¤ä»£ç 

:::



<h1 id="ly1OE">è”ç³»äººæ•°æ®æ¸²æŸ“</h1>
+ åœ¨modelsä¸‹æ–°å»ºusers.etsï¼Œåˆ†åˆ«å®šä¹‰ç”¨æˆ·ç±»å‹å’Œ10ä¸ªéšæœºæ•°æ®

```typescript
// ç”¨æˆ·ä¿¡æ¯
export interface  UserInfo {
  username: string  // ç”¨æˆ·æ˜µç§°
  avatar: string  // ç”¨æˆ·å¤´åƒ
  user_id: string  // ç”¨æˆ·id
}
export class UserInfoModel implements UserInfo {
  username: string = ''
  avatar: string = ''
  user_id: string = ''

  constructor(model: UserInfo) {
    this.username = model.username
    this.avatar = model.avatar
    this.user_id = model.user_id
  }
}
export const DefaultUserList: UserInfo[] = [{
  username: 'å°è¶´èœ',
  avatar: 'https://img2.baidu.com/it/u=2778471297,524433918&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
  user_id: '1'
},{
  username: 'è€æ¿',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F9853de1a-3985-42e6-be59-849853318793%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069489&t=f960a72e50a399ddec92b18b3c7fc2d9',
  user_id: '2'
},{
  username: 'è€å©†',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fd064be90-6b8c-4a6d-9721-837206fbb4a7%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069489&t=c810057a56c27b5747e1e92bfde37799',
  user_id: '3'
},{
  username: 'ç‰©ä¸šå°å¼ ',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fabf9e746-a09c-4b08-bcba-1e347a370226%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069489&t=b47c00cad15f8dbdc390e82b95348ed2',
  user_id: '4'
},{
  username: 'æ°´è‹¥å¯’å®‡',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Ff1d11ab1-35ff-4f2c-b9e9-3e0c996d34a2%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069489&t=e3234db982e8a36639d170fc5cec7848',
  user_id: '5'
},{
  username: 'å°æ—',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fe9543d7c-02f3-484f-a3f0-5bfa8b2e6ef9%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069502&t=118303a29ce4a8ef2c1a496ae880b76b',
  user_id: '6'
},{
  username: 'èŠ±å¼€å¯Œè´µ',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F8d90d041-784a-407f-a82e-b851fafdf746%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069547&t=d374ebb6973f68b95ba345827a304455',
  user_id: '7'
},{
  username: 'å¦ˆå¦ˆ',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2F373c6d24-1f8b-4000-8dd9-8d8410c35e71%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069618&t=51805a82420593c2a3cda47b9f65a80e',
  user_id: '8'
},{
  username: 'æ²§æµ·ä¸€ç”Ÿç¬‘',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fbb560b27-a0b7-4062-ae40-efe4e5a8a748%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069619&t=8605f8477712cf9c5a1159db0cd7dab4',
  user_id: '9'
},{
  username: 'çˆ±å“­çš„ç‡•å­ğŸ¨ğŸ¨',
  avatar: 'https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fdc2617f6-4a68-4d4a-8c54-8cbc84e3446a%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1708069619&t=a8b7b4f1e600d53e5547479d947b1809',
  user_id: '10'
}]
```

:::color1
è¿™é‡Œç”¨i2cç”Ÿæˆäº†classçš„å®ç°ç±»ï¼Œç›®çš„æ˜¯åé¢çš„åœ°æ–¹ä¼šä½¿ç”¨

:::

+ å°è£…å…³äºå¾®ä¿¡èŠå¤©çš„é¦–é€‰é¡¹ç±»
+ åœ¨etsç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªconstants/index.ets ç”¨äºå­˜å‚¨ä¸€äº›å¸¸é‡

```typescript
export const WeChat_StoreKey: string = 'wechat'  // å¾®ä¿¡èŠå¤©å­˜å‚¨é¦–é€‰é¡¹çš„key
export const WeChat_ConnectKey: string = 'wechat_connect' // å¾®ä¿¡è”ç³»äººçš„key

```

:::color2
è¯¥å˜é‡ç”¨äºå­˜å‚¨é¦–é€‰é¡¹çš„ä¸€äº›å¸¸ç”¨çš„key

:::

+ åœ¨utilsç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªchat_store.etsæ–‡ä»¶ï¼Œç”¨äºå­˜å‚¨é¦–é€‰é¡¹

```typescript
import { WeChat_StoreKey } from  '../constants'
import preferences from '@ohos.data.preferences'

export class WeChatStore {
  static  getWeChatStore () {
    return  preferences.getPreferences(getContext(), WeChat_StoreKey)
  }
}
```

+ å°è£…ä¸€ä¸ªè·å–è”ç³»äººçš„æ–¹æ³•

```typescript
  // è·å–å¾®ä¿¡è”ç³»äºº
  static async getWeChatConnect() {
    const store = await WeChatStore.getWeChatStore()
    return JSON.parse(store.getSync(WeChat_ConnectKey, JSON.stringify(DefaultUserList)) as string) as UserInfoModel[]
  }
```

+ æ–°å»ºä¸€ä¸ªConnectç»„ä»¶ï¼Œä½ç½®ä½äºets/pages/connect/Connect.ets

```typescript
@Component
struct Connect {
  build() {
    Text("è”ç³»äººç»„ä»¶")
  }
}
export default Connect
```

+ åœ¨ForEachå¾ªç¯ä¸­æ¸²æŸ“è¯¥ç»„ä»¶

```typescript
build() {
    Tabs({ index: $$this.currentIndex }) {
      ForEach(this.tabList, (item: TabBarClass) => {
        TabContent() {
          if(item.name === "connect") {
            Connect()
          }else {
            Text(item.title)
          }
        }.tabBar(this.CommonTabBar(item))

      }, (item: TabBarClass) => item.name.toString())
    }.barPosition(BarPosition.End)
    .animationDuration(300)
  }
```

+ åœ¨Connectçš„åˆå§‹åŒ–ä¸­è·å–å‘˜å·¥æ•°æ®

```typescript
import { promptAction } from '@kit.ArkUI'
import { UserInfo, UserInfoModel } from '../../models/users'
import { WeChatStore } from '../../utils/chat_store'

@Component
struct Connect {
  @State
  userList: UserInfoModel[] = []

  aboutToAppear(): void {
    this.getUserList()
  }

  async getUserList() {
    this.userList = await WeChatStore.getWeChatConnect()
  }

  build() {
    Text(JSON.stringify(this.userList))
  }
}

export default Connect
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707413420403-f6489e80-34dd-4538-a05e-94e5cfb7d279.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color3
éœ€è¦æ¨¡æ‹Ÿå™¨orçœŸæœºæ‰å¯ä»¥çœ‹åˆ°æ•°æ®

:::

+ å®ŒæˆåŸºæœ¬çš„ç»“æ„æ¸²æŸ“- Connect/Index.ets

```typescript
 build() {
    Column() {
      Row() {
        Search({ placeholder: 'æœç´¢' })
          .height(30)
          .backgroundColor($r('app.color.white'))
          .borderRadius(4)
      }.width('100%')
      .padding({
        left: 10,
        right: 10
      })

      List () {
        ForEach(this.userList, (item: UserInfo) => {
          ListItem() {
            Row({ space: 10 }) {
              Image(item.avatar)
                .width(30)
                .height(30)
                .borderRadius(4)
              Column() {
                Text(item.username)
                  .fontColor($r('app.color.text_primary'))
                  .fontSize(14)
              }.layoutWeight(1)
              .alignItems(HorizontalAlign.Start)
              .justifyContent(FlexAlign.Center)
            }
            .width('100%')
            .height(60)
            .padding({ left: 10, right: 10 })
            .stateStyles({
              pressed: {
                .backgroundColor($r('app.color.back_color'))
              },
              normal: {
                .backgroundColor($r('app.color.white'))
              }
            })
          }
        }, (item: UserInfo) => item.user_id)
      }
      .backgroundColor(Color.White)
      .padding({
        top: 10,
        bottom: 10
      })
      .divider({
        strokeWidth: 1,
        color: $r('app.color.border_color')
      })
    }
    .height('100%')
    .padding({
      top: 20
    })
    .backgroundColor($r('app.color.back_color'))
  }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707447642918-f768381b-8aa8-49d4-9f45-a716438f345a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color3
è¯·æ³¨æ„ï¼Œå› ä¸ºå›¾ç‰‡ä¸­ç”¨åˆ°äº†åœ¨çº¿å›¾ç‰‡ï¼Œéœ€è¦åœ¨module.json5ä¸­å¼€å¯ç½‘ç»œæƒé™

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707447688237-5a16d5ce-d112-495d-a906-edb982e5831d.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::



<h1 id="w32vZ">è”ç³»äººç­›é€‰</h1>
+ å®šä¹‰ä¸€ä¸ªç­›é€‰å­—æ®µå’Œç­›é€‰åçš„æ•°ç»„

```typescript
 @State
  searchName: string = ""
  @State
  filterList: UserInfoModel[] = []
```

+ ç»‘å®šæœç´¢è¾“å…¥æ¡†

```typescript
 Search({ placeholder: 'æœç´¢', value: $$this.searchName })
```

+ å®ç°æ›´æ–°æ–¹æ³•

```typescript
 updateFilterList () {
    if(this.searchName) {
      this.filterList = this.userList.filter(item => item.username.indexOf(this.searchName) > -1)
      return
    }
    this.filterList = this.userList
  }
```

+ åœ¨è·å–å®Œç”¨æˆ·ä¹‹åæ›´æ–°ä¸€æ¬¡

```typescript
async getUserList() {
    this.userList = await WeChatStore.getWeChatConnect()
    this.updateFilterList()
  }
```

+ ç›‘å¬searchNameçš„å˜åŒ–-æ‰§è¡Œè¯¥æ–¹æ³•

```typescript
 @State
  @Watch("updateFilterList")
  searchName: string = ""
```

+ æ›¿æ¢å¾ªç¯çš„å†…å®¹

```typescript
  ForEach(this.filterList, (item: UserInfoModel) => {
```

+ æ•ˆæœ

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708399786929-b2bbf3b0-45b9-4c61-912d-18252418072e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::info
æäº¤ä»£ç 

:::

<h1 id="LlFU7">æ–°å»ºèŠå¤©è¯¦æƒ…é¡µé¢</h1>
:::color3
å½“ç‚¹å‡»è”ç³»äººé‡Œé¢çš„ä»»ä½•ä¸€ä¸ªäººçš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥å’Œå½“å‰äººçš„èŠå¤©è¯¦æƒ…-èŠå¤©è¯¦æƒ…åº”è¯¥æ˜¯ä¸ªé¡µé¢

:::

+ æ–°å»ºpages/ChatDetail/ChatDetail.etsæ–‡ä»¶

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707447964587-9bca78bf-8f2c-4875-b157-92256040e809.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_70%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

```typescript
@Entry
@Component
struct ChatDetail {
  build() {
    Column() {
      Row() {
        Stack({ alignContent: Alignment.Start }) {
          Image($r('app.media.ic_public_arrow_left'))
            .width(30)
            .height(30)

          Text("å°æœæœ")
            .width('100%')
            .textAlign(TextAlign.Center)
            .fontSize(16)
            .fontColor($r('app.color.text_primary'))
        }
        .height(50)
      }
      .padding({
        left: 10,
        right: 10
      })
    }
  }
}
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707494860442-e30ad46f-cc63-492a-8c11-958a23406446.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ ç‚¹å‡»ä»»æ„çš„ç”¨æˆ·è·³è½¬åˆ°èŠå¤©è¯¦æƒ…

:::color3
åœ¨Connect/Index.etsä¸­æ³¨å†Œç‚¹å‡»äº‹ä»¶

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707495349127-18a1ddd4-abff-47db-8bb0-2b437fd4817f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ ç‚¹å‡»èŠå¤©é¡µè¿”å›è·¯ç”±

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707495487681-382d29ea-0b11-43e8-934f-4557754528f8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_43%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color3
è¿™é‡Œç”±äºç”¨äº†Stackå †å å®¹å™¨ï¼Œå¯¼è‡´ä¹‹å‰çš„å›¾ç‰‡ç»„ä»¶è¢«åæ·»åŠ çš„æ–‡æœ¬ç›–ä½äº† æ‰€ä»¥éœ€è¦è°ƒæ•´ä¸€ä¸‹å±‚çº§

:::



:::color1
æäº¤ä»£ç 

:::



<h1 id="xHWPz">å»ºç«‹é»˜è®¤ç”¨æˆ·</h1>
:::color1
ç”±äºå½“å‰è·å–å½“å‰ç”¨æˆ·çš„æ¥å£ï¼Œæˆ‘ä»¬åœ¨é¦–é€‰é¡¹ä¸­å®šä¹‰ä¸€ä¸ªé»˜è®¤çš„ç”¨æˆ·

:::

```typescript
// å½“å‰é»˜è®¤ç”¨æˆ·
export const CurrentUser: UserInfo = {
  username: 'è€é«˜',
  avatar: 'https://img2.baidu.com/it/u=3135824442,872902204&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500',
  user_id: '9999'
}
```

+ åœ¨å¸¸é‡ä¸­å®šä¹‰ä¸€ä¸ªkey

```typescript
export const WeChat_CurrentUserKey: string = "wechat_current_user" // å½“å‰ç”¨æˆ·ä¿¡æ¯
```

+ åœ¨é¦–é€‰é¡¹ä¸­å®šä¹‰ä¸€ä¸ªè·å–å½“å‰ç”¨æˆ·çš„æ–¹æ³•

```typescript
// è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  static async getCurrentUser()  {
    const store = await WeChatStore.getWeChatStore()
    return JSON.parse(store.getSync(WeChat_CurrentUserKey, JSON.stringify(CurrentUser)) as string) as UserInfoModel
  }
```

+ åœ¨abilityå¯åŠ¨ä¹‹åè·å–å½“å‰ç”¨æˆ·å¹¶è®¾ç½®ç»™å…¨å±€çŠ¶æ€

```typescript
async onWindowStageCreate(windowStage: window.WindowStage): Promise<void>  {
    // Main window is created, set main page for this ability
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onWindowStageCreate');
    WeChatStore.context = this.context
    const user = await WeChatStore.getCurrentUser()
    AppStorage.setOrCreate<UserInfoModel>(WeChat_CurrentUserKey, user)
    windowStage.loadContent('pages/Index', async (err) => {
      if (err.code) {
        hilog.error(0x0000, 'testTag', 'Failed to load the content. Cause: %{public}s', JSON.stringify(err) ?? '');
        return;
      }
      hilog.info(0x0000, 'testTag', 'Succeeded in loading the content.');
    });
  }

```

:::success
æ³¨æ„ï¼š åœ¨abilityä¸­è°ƒç”¨çš„æ–¹æ³•ä¸­å¦‚æœç”¨åˆ°äº†getContextï¼Œæ­¤æ—¶æ˜¯æ‹¿ä¸åˆ°å†…å®¹çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¯¹åŸæ¥çš„é¦–é€‰é¡¹ç®¡ç†è¿›è¡Œä¸€äº›è°ƒæ•´

:::

+ é¦–é€‰é¡¹è°ƒæ•´

```typescript
static context: Context
  static getWeChatStore() {
    return preferences.getPreferences(WeChatStore.context || getContext(), WeChat_StoreKey)
  }
```

+ åœ¨èŠå¤©è¯¦æƒ…ä¸­åˆå§‹åŒ–æ—¶è·å–å½“å‰ç”¨æˆ·çš„æ•°æ®

```typescript
@StorageProp(WeChat_CurrentUserKey)
currentUser: UserInfoModel = new UserInfoModel({} as UserInfo)
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707496079834-c4b4c342-7884-4e46-ac26-f22d5ac7adaf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



<h1 id="QfMVz">ç‚¹å‡»è”ç³»äººä¼ å…¥é€šä¿¡ç”¨æˆ·</h1>
:::color1
å½“ç‚¹å‡»æŸä¸ªè”ç³»äººè¿›è¡ŒèŠå¤©æ—¶ï¼Œè¦å°†è¯¥è”ç³»äººçš„ä¿¡æ¯ä¼ å…¥åˆ°èŠå¤©è¯¦æƒ…ä¸­

:::

+ Connect/Index.ets

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707496217790-19853b57-5d40-4b7e-88e2-9ad6572f05e2.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_32%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨èŠå¤©è¯¦æƒ…ä¸­æ¥æ”¶å‚æ•°

```typescript
@Provide
  talkUser: UserInfoModel = new UserInfoModel({} as UserInfo)
  aboutToAppear(): void {
     this.getTalkUser()
  }
  // è·å–èŠå¤©è€…ä¿¡æ¯
  async getTalkUser () {
    this.talkUser = router.getParams() as UserInfoModel
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711532128799-db3056d6-4a48-4c4d-98f4-259add7d21ca.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å°†å¤´éƒ¨çš„ä¿¡æ¯æ¢æˆå®æ—¶çš„èŠå¤©äººä¿¡æ¯

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707525316406-feb05527-3224-401b-93cc-e64aa7ce1974.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::



<h1 id="JuEVm">å°è£…åº•éƒ¨è¾“å…¥æ¡†ç»„ä»¶</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707543371230-3f15786e-913a-498e-a715-d43ce7824348.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æ–°å»ºä¸€ä¸ªç»„ä»¶- ChatDetail/Components/BottomInput.ets

:::

```typescript
@Preview
@Component
struct BottomInput {
  build() {
    Column() {
      Row({ space: 10 }) {
        Image($r('app.media.ic_public_sound'))
          .width(25)
          .height(25)

        TextInput()
          .height(35)
          .layoutWeight(1)
          .borderRadius(2)
          .backgroundColor(Color.White)
        Image($r('app.media.ic_public_add_norm'))
          .width(25)
          .height(25)
      }
      .height(60)
      .width('100%')
      .padding({
        left: 10,
        right: 10
      })
    }
    .backgroundColor($r('app.color.second_back_color'))
  }
}

export default BottomInput
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707544509239-0456ae8c-fd5b-4d39-899e-382d356d1103.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨ChatDetailä¸­ä½¿ç”¨

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707544587504-65ba21ad-97fd-4d36-abb5-f9d3f580f072.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711532757525-7ea0710b-4d6d-46a0-ab17-d31d724387ee.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



<h1 id="YXQnA">å®ç°é”®ç›˜é¿è®©æ¨¡å¼</h1>
:::success
åœ¨æ•´ä¸ªå¾®ä¿¡èŠå¤©é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬éƒ½éœ€è¦è®©é”®ç›˜å¼¹èµ·æ—¶ï¼Œèƒ½å¤Ÿå°†é¡µé¢è¿›è¡Œå‹ç¼©

:::

+ åœ¨abilityåˆå§‹åŒ–ä¸­å®ç°é”®ç›˜é¿è®©

```typescript
  const win = await windowStage.getMainWindow()
    win.getUIContext().setKeyboardAvoidMode(KeyboardAvoidMode.RESIZE)
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711533059706-f33d6948-5bb3-460c-9191-82d7470e2f3a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_63%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::success
æäº¤ä»£ç 

:::

<h1 id="laPMW">åˆ‡æ¢è¾“å…¥æ¨¡å¼</h1>
+ ChatDetail/Component/BottomInput.ets

:::color1
å½“ç‚¹å‡»å·¦ä¾§å–‡å­å›¾æ ‡æ—¶ï¼Œåˆ‡æ¢åˆ°è¯­éŸ³æ¨¡å¼ï¼Œåä¹‹åˆ‡æ¢å›æ¥

:::

+ å®šä¹‰ä¸€ä¸ªçŠ¶æ€æ§åˆ¶

```typescript
 @State
 showVoice: boolean = false // æ˜¯å¦å‘é€è¯­éŸ³
```

+ æ ¹æ®çŠ¶æ€æ§åˆ¶å›¾æ ‡å¹¶åˆ‡æ¢

```typescript
Image(this.showVoice ? $r('app.media.ic_public_keyboard') : $r('app.media.ic_public_sound'))
          .width(25)
          .height(25)
          .onClick(() => {
            this.showVoice = !this.showVoice
          })
```

+ æ ¹æ®çŠ¶æ€æ§åˆ¶å‘é€è¯­éŸ³çš„æŒ‰é’®å’Œè¾“å…¥æ¡†

```typescript
    if (this.showVoice) {
          Button("æŒ‰ä½ è¯´è¯", { type: ButtonType.Normal })
            .backgroundColor(Color.White)
            .layoutWeight(1)
            .borderRadius(2)
            .fontColor($r('app.color.text_primary'))
        } else {
          TextInput()
            .height(35)
            .layoutWeight(1)
            .borderRadius(2)
            .backgroundColor(Color.White)
        }
```

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707546563636-fe462bba-3081-49da-9511-82a2807fef53.gif)





<h1 id="U9MC9">æ¶ˆæ¯å¯¹è±¡çš„åˆ›å»º</h1>
:::color1
ä¸è®ºæ˜¯æ–‡æœ¬-è¯­éŸ³-è¿˜æ˜¯ç…§ç‰‡-è§†é¢‘ï¼Œéƒ½éœ€è¦æ¶ˆæ¯å¯¹è±¡ç±»å‹

:::

+ æ–°å»ºmodels/message.etsæ–‡ä»¶ï¼Œåˆ›å»ºå…³äºæ¶ˆæ¯çš„ç±»å‹
+ åˆ›å»ºä¸€ä¸ªæ¶ˆæ¯ç±»å‹çš„æšä¸¾

```typescript
export enum  MessageTypeEnum {
  TEXT, // æ–‡æœ¬
  IMAGE, // å›¾ç‰‡
  AUDIO, // éŸ³é¢‘
  VIDEO, // è§†é¢‘
  LOCATION, // å®šä½
  LINK // é“¾æ¥
}
```

+ åˆ›å»ºæ¶ˆæ¯çš„ç±»å‹

```typescript
export interface MessageInfo {
  id: string // æ ‡è¯†
  sendUser: UserInfo // è¿™æ¡æ¶ˆæ¯çš„å‘é€è€…
  connectUser: UserInfo // è¿™æ¡æ¶ˆæ¯çš„å½’å±è€…
  messageContent: string // æ¶ˆæ¯å†…å®¹  æ–‡æœ¬æ¶ˆæ¯  [å›¾ç‰‡] [è¯­éŸ³â€˜7]
  sendTime: number // å‘é€æ—¶é—´
  // æ¶ˆæ¯ç±»å‹
  messageType: MessageTypeEnum // æ¶ˆæ¯ç±»å‹
  sourceFilePath: string // éŸ³é¢‘åœ°å€ å›¾ç‰‡åœ°å€ è§†é¢‘åœ°å€
  sourceDuration: number // éŸ³é¢‘æˆ–è€…è§†é¢‘çš„é•¿åº¦ å•ä½s
}

```

+ åˆ©ç”¨i2cæ¥ç”Ÿæˆå¯¹åº”çš„classç±»å‹

```typescript
$ i2c ./message.ets
```

+ ç”Ÿæˆå¦‚ä¸‹ä»£ç 

```typescript
export class MessageInfoModel implements MessageInfo {
  id: string = ''
  sendUser: UserInfo = new UserInfoModel({} as UserInfo)
  connectUser: UserInfo = new UserInfoModel({} as UserInfo)
  messageContent: string = ''
  sendTime: number = 0
  messageType: MessageTypeEnum = MessageTypeEnum.TEXT
  sourceFilePath: string = ''
  sourceDuration: number = 0

  constructor(model: MessageInfo) {
    this.id = model.id || util.generateRandomUUID() // ç”Ÿæˆuuid
    this.sendUser = model.sendUser
    this.connectUser = model.connectUser
    this.messageContent = model.messageContent
    this.sendTime = model.sendTime || Date.now() // å‘é€æ—¶é—´
    this.messageType = model.messageType || MessageTypeEnum.TEXT
    this.sourceFilePath = model.sourceFilePath
    this.sourceDuration = model.sourceDuration
  }

```

:::color1
è¿™é‡Œçš„idæˆ‘ä»¬ç‰¹æ®Šå¤„ç†ä¸‹ï¼Œå½“æ²¡æœ‰ä¼ å…¥idæ—¶ï¼Œç›´æ¥åœ¨æ„é€ å‡½æ•°ä¸­è‡ªåŠ¨ç”ŸæˆID

å‘é€æ—¶é—´ä¹Ÿå¤„ç†ä¸‹ï¼Œæ²¡æœ‰ä¼ å…¥çš„æƒ…å†µä¸‹ ç”¨å½“å‰æ—¶é—´

:::

<h1 id="ZR4og">åˆ›å»ºæ¶ˆæ¯ç»„ä»¶</h1>
:::color1
åœ¨æ¶ˆæ¯è¯¦æƒ…ä¸­ï¼Œæˆ‘ä»¬éœ€è¦å±•ç¤ºä¸€æ¡æ¡çš„æ¶ˆæ¯ï¼Œæ­¤æ—¶æˆ‘ä»¬æ–°å»ºä¸€ä¸ªMessage.etsï¼Œç”¨äºå±•ç¤ºæ¶ˆæ¯å†…å®¹

:::

+ æ–°å»ºChatDetail/Components/Message.etsç»„ä»¶

```typescript
@Preview
@Component
struct Message {
  build() {
    Row() {
      Image("https://img2.baidu.com/it/u=2778471297,524433918&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500")
        .height(40)
        .width(40)
        .borderRadius(6)
      Row() {
        Column() {
          Text("ä½ çœŸçš„å¾ˆè®©æˆ‘ä¼¤å¿ƒ")
            .backgroundColor($r('app.color.second_primary'))
            .fontColor($r('app.color.text_primary'))
            .padding(10)
            .lineHeight(24)
            .margin({
              left: 10,
              right: 10
            })
            .borderRadius(5)
        }

      }.layoutWeight(6)
      .justifyContent(FlexAlign.End)
      Text().layoutWeight(1)
    }
    .width('100%')
    .padding({
      left: 20,
      right: 20
    })
    .alignItems(VerticalAlign.Top)
    .direction(Direction.Rtl)
  }
}

export default Message
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707580000643-2dd3cec2-58ee-437f-8a33-cf2135b0210c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_22%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ ¹æ®æ˜¯å¦æ˜¯è‡ªå·±å‘å‡ºçš„æ¶ˆæ¯è¿›è¡Œå¸ƒå±€è°ƒæ•´

```typescript
import { WeChat_CurrentUserKey } from '../../../constants'
import { MessageInfo, MessageInfoModel } from '../../../models/message'
import { UserInfo, UserInfoModel } from '../../../models/users'

@Preview
@Component
struct Message {
  @StorageProp(WeChat_CurrentUserKey)
  currentUser: UserInfoModel = new UserInfoModel({} as UserInfo)
  @Prop
  currentMessage: MessageInfoModel = new MessageInfoModel({} as MessageInfo)
  @State
  isOwnMessage: boolean = this.currentUser.user_id === this.currentMessage?.sendUser?.user_id
  build() {
    Row() {
      Image("https://img2.baidu.com/it/u=2778471297,524433918&fm=253&fmt=auto&app=138&f=JPEG?w=500&h=500")
        .height(40)
        .width(40)
        .borderRadius(6)
      Row() {
        Column() {
          Text("ä½ çœŸçš„å¾ˆè®©æˆ‘ä¼¤å¿ƒ")
            .backgroundColor(this.isOwnMessage ? $r('app.color.second_primary') : $r('app.color.white'))
            .fontColor($r('app.color.text_primary'))
            .padding(10)
            .lineHeight(24)
            .margin({
              left: 10,
              right: 10
            })
            .borderRadius(5)
        }

      }.layoutWeight(6)
      .justifyContent(this.isOwnMessage ? FlexAlign.End : FlexAlign.Start)
      Text().layoutWeight(1)
    }
    .width('100%')
    .padding({
      left: 20,
      right: 20
    })
    .alignItems(VerticalAlign.Top)
    .direction(this.isOwnMessage ? Direction.Rtl : Direction.Ltr)
  }
}

export default Message
```

+ åœ¨ChatDetailä¸­æµ‹è¯•å‡ ä¸ªæ¶ˆæ¯

```typescript
 // æ”¾ç½®æ¶ˆæ¯ç»„ä»¶
      List({  space: 20 }) {
        ForEach([1,2,3,4,5,6,7,8,9,10,11,12], () => {
          ListItem() {
            Message()
          }
        })
      }
      .layoutWeight(1)
      .width('100%')
      .padding({
        top: 20,
        bottom: 70
      })
      .backgroundColor($r('app.color.back_color'))

```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707617802136-9f17039c-d403-44bc-810a-3c01708aba0e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::

<h1 id="sAnLh">è¾“å…¥æ¶ˆæ¯ï¼Œå°†ä½œè€…çš„æ¶ˆæ¯æ›´æ–°åˆ°æ¶ˆæ¯åˆ—è¡¨</h1>
:::color1
+ åŒå‘ç»‘å®šè¾“å…¥æ¡†å†…å®¹
+ è¾“å…¥å†…å®¹ç‚¹å‡»å‘é€æ—¶ï¼Œå°†ä¿¡æ¯ä¼ å…¥åˆ°çˆ¶ç»„ä»¶
+ çˆ¶ç»„ä»¶æ‹¿åˆ°æ¶ˆæ¯æ·»åŠ åˆ°å½“å‰åˆ—è¡¨ä¸­

:::

+ åŒå‘ç»‘å®šè¾“å…¥æ¡†å†…å®¹-ChatDetail/Components/BottomInput.ets

```typescript
  @State
  content: string = "" // è¾“å…¥å†…å®¹
  sendTextMessage: (content: string) => void = () => {} // å‘é€æ¶ˆæ¯

```

+ ä½¿ç”¨$$åŒå‘ç»‘å®š

```typescript
TextInput({ text: $$this.content  })
```

+ ç›‘å¬onSubmitäº‹ä»¶

```typescript
 TextInput({ text: $$this.content  })
  ...
.onSubmit(() => {
              if(this.content) {
                   this.sendTextMessage(this.content)
                   this.content = "" // è®¾ç½®ä¸ºç©º
                }
            })
```

+ åœ¨ChatDetailä¸­å®šä¹‰ä¸€ä¸ªåˆ—è¡¨

```typescript
  @State
  messList: MessageInfoModel[] = []
```

+ å¾ªç¯åˆ—è¡¨

```typescript
 // æ”¾ç½®æ¶ˆæ¯ç»„ä»¶
      List({  space: 20 }) {
        ForEach(this.messList, (item: MessageInfoModel) => {
          ListItem() {
            Message({ currentMessage: item })
          }
        })
      }
```

+ åœ¨çˆ¶ç»„ä»¶ä¸­å®šä¹‰ä¸€ä¸ªæ–¹æ³•ï¼Œä¼ é€’ç»™BottomInputç»„ä»¶

```typescript
     //  æ”¾ç½®åº•éƒ¨ç»„ä»¶
      BottomInput({
        sendTextMessage: (content: string) => {
          this.sendTextMessage(content)
        }
      })
```

+ æ·»åŠ sendTextMessageçš„æ–¹æ³•

```typescript
// å‘é€æ–‡æœ¬æ¶ˆæ¯
  sendTextMessage(content: string) {
    let message = new MessageInfoModel({
      messageContent: content,
      sendUser: this.currentUser,
      connectUser: this.talkUser,
    } as MessageInfo)
    this.messList.push(message) // æ·»åŠ åˆ°ä¿¡æ¯çš„åº•éƒ¨
  }
```

+ å°†ä¿¡æ¯å†…å®¹æ¢æˆåŠ¨æ€çš„![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711538134373-9d596de2-4c1a-4d56-bd0f-60ed63f170da.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_66%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707667847324-a9bc6f9c-4ca6-4a45-8acc-171f2fa2e7c3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="yXGOT">å°è£…æœºå™¨äººå›å¤çš„è¯·æ±‚æ¥å£</h1>
:::color1
ç”±äºæˆ‘ä»¬éœ€è¦å¯¹è¯ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨ä¸€ä¸ªæœºå™¨äººèŠå¤©çš„æ¥å£æ¥è·å–å¯¹åº”çš„æ•°æ®å“åº”

æ¥å£åœ°å€ï¼š[https://api.ownthink.com/bot?appid=xiaosi&userid=user&spoken=](https://api.ownthink.com/bot?appid=xiaosi&userid=user&spoken=)æµ‹è¯•

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707668017271-8e9b7719-e82d-47bd-afbf-8d6e10119fa8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ åœ¨modelsä¸­å®šä¹‰ä¸€ä¸ªchat.ets

```typescript
export interface ChatResponse {
  message: string,
  data: ChatData
}
export interface ChatData {
  type: number,
  info: ChatInfo
}
export interface ChatInfo {
  text: string
}
```

+ åœ¨utilsä¸‹æ–°å»ºä¸€ä¸ªrequest.etsæ–‡ä»¶ï¼Œå°è£…ä¸€ä¸ªè·å–èŠå¤©çš„ç»“æœçš„æ–¹æ³•

```typescript
import { ChatResponse } from '../models/chat'
import http from '@ohos.net.http';
const req = http.createHttp()

export async function requestMessage(content: string) {
  try {
    const res = await req.request(`https://api.ownthink.com/bot?appid=xiaosi&userid=user&spoken=${encodeURIComponent(content)}`)
    const result =JSON.parse(res.result as string) as ChatResponse
    return result
  } catch (error) {
    return Promise.reject(error)
  }
}
```

+ åœ¨å‘é€è‡ªå·±æ¶ˆæ¯åï¼Œè¯·æ±‚æœåŠ¡å™¨è·å–å“åº”çš„æ¶ˆæ¯æ·»åŠ åˆ°Listä¸­

```typescript
 // å‘é€æ–‡æœ¬æ¶ˆæ¯
 async sendTextMessage(content: string) {
    let message = new MessageInfoModel({
      messageContent: content,
      sendUser: this.currentUser,
      connectUser: this.talkUser,
    } as MessageInfo)
    this.messList.push(message) // æ·»åŠ åˆ°ä¿¡æ¯çš„åº•éƒ¨
    await this.getResponseMessage(content)
  }
// è·å–å“åº”æ¶ˆæ¯
  async getResponseMessage (content: string) {
   const result = await requestMessage(content)
    let message = new MessageInfoModel({
      messageContent: result.data?.info?.text,
      sendUser: this.talkUser,
      connectUser: this.talkUser,
    } as MessageInfo)
    this.messList.push(message) // æ·»åŠ åˆ°ä¿¡æ¯çš„åº•éƒ¨
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707669857718-88f6ae1f-a454-4c61-ae48-cf96dbbed563.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ å½“æ­£åœ¨å“åº”æ—¶ï¼Œæ˜¾ç¤ºå¯¹æ–¹æ­£åœ¨è¾“å…¥

```typescript
  @State
  talkUserInputIng: boolean = false // å¯¹æ–¹æ­£åœ¨è¾“å…¥  
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711807304720-4203ba5a-f47b-4e2e-baac-6cfa5cc2d2d8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_41%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ ¹æ®çŠ¶æ€æ˜¾ç¤ºå¯¹æ–¹æ­£åœ¨è¾“å…¥

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707670078567-e2c77746-7671-4a44-8bc7-4fd5f4867620.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_67%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::



<h1 id="eOHmN">æ·»åŠ ä¿¡æ¯æ»šåŠ¨åˆ°åº•éƒ¨</h1>
:::color1
ç»™Listç»„ä»¶ç»‘å®šä¸€ä¸ªscrollerï¼Œæ¯æ¬¡æ·»åŠ ä¿¡æ¯ä¹‹åï¼Œæ»šåŠ¨åˆ°æœ€åº•éƒ¨å°±å¯ä»¥

:::

+ å®šä¹‰ä¸€ä¸ªscroller

```typescript
  // æ»šåŠ¨æ¡å¯¹è±¡
  scroller: Scroller = new Scroller()
```

+ ç»‘å®šåˆ°æ¶ˆæ¯åˆ—è¡¨çš„åˆ—è¡¨

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707670251630-6071db51-52d8-4738-afc3-90d749d691d9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_55%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ¯æ¬¡æ·»åŠ ä¹‹åï¼Œæ»šåŠ¨åˆ°æœ€åº•éƒ¨![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711807334604-94c515b2-0f47-4a37-95f3-4a5488a746a8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)





![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707670379266-f4c0ce69-04bd-4903-b4e9-f642e0ca36a8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::

<h1 id="toNqh">é€šè¿‡é¦–é€‰é¡¹ç¼“å­˜å½“å‰çš„èŠå¤©è®°å½•</h1>
:::color1
æ¯ä¸ªäººçš„èŠå¤©è®°å½•è¦ä¿ç•™

+ æ¯ä¸ªäººçš„èŠå¤©è®°å½•æ˜¯å•ç‹¬å­˜å‚¨çš„- ä¹Ÿå°±æ˜¯æ¯ä¸ªäººå’Œ"æˆ‘"çš„èŠå¤©è®°å½•çš„keyæ˜¯ä¸åŒçš„
+ èŠå¤©è®°å½•è¦éšæ—¶æ›´æ–°-æ–°å¢-åˆ é™¤
+ è¿›å…¥å’ŒæŸä¸ªäººçš„èŠå¤©è®°å½•è¦è¯»å–ä¹‹å‰çš„èŠå¤©è®°å½•

:::

+ åœ¨constants/index.etsä¸­æ·»åŠ ä¸€ä¸ªkey

```typescript
export const WeChat_UserRecordKey: string = "wechat_user_record" // ç”¨æˆ·èŠå¤©è®°å½•
```

+ åœ¨chat_store.etsä¸­ï¼ˆåˆ©ç”¨å›ºå®šKey +  å¯¹è¯ç”¨æˆ·idä½œä¸ºæ ‡è¯†ï¼‰åˆ›å»º è·å–æŸä¸ªäººæ•´ä¸ªçš„èŠå¤©è®°å½•ï¼Œåˆ é™¤æŸä¸ªäººæ•´ä¸ªçš„èŠå¤©è®°å½•ï¼Œæ·»åŠ æŸä¸ªäººçš„æŸä¸€æ¡çš„èŠå¤©è®°å½•ï¼Œåˆ é™¤æŸä¸ªäººçš„æŸä¸€æ¡çš„èŠå¤©è®°å½•

```typescript
// è·å–æŸä¸ªäººçš„æ•´ä¸ªçš„èŠå¤©è®°å½•
  static async getWeChatMessage(userId: string) {
    const store = await WeChatStore.getWeChatStore()
    return JSON.parse(store.getSync(`${WeChat_UserRecordKey}_${userId}`, "[]") as string) as MessageInfoModel[]
  }
  // åˆ é™¤æŸä¸ªäººæ•´ä¸ªçš„èŠå¤©è®°å½•
  static async delWeChatMessage (userId: string) {
    const store = await WeChatStore.getWeChatStore()
    store.deleteSync(`${WeChat_UserRecordKey}_${userId}`)
    await store.flush() // æ›´æ–°ç£ç›˜
  }
  // æ·»åŠ æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async addOneWeChatMessage(userId: string, mess: MessageInfoModel) {
    const store = await WeChatStore.getWeChatStore()
    const list = await WeChatStore.getWeChatMessage(userId)
    list.push(mess) // æ·»åŠ è®°å½•
    store.putSync(`${WeChat_UserRecordKey}_${userId}`, JSON.stringify(list))
    await store.flush()
  }
  // åˆ é™¤æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async delOneWeChatMessage(userId: string, messId: string) {
    const store = await WeChatStore.getWeChatStore()
    let list = await WeChatStore.getWeChatMessage(userId)
    list = list.filter(item => item.id !== messId) // æ’é™¤è®°å½•
    store.putSync(`${WeChat_UserRecordKey}_${userId}`, JSON.stringify(list))
    await store.flush()
  }
```

+ æ·»åŠ è®°å½•æ—¶ï¼Œå­˜å…¥é¦–é€‰é¡¹![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711807374054-41269985-bf54-4c67-90ef-a754e046ebfc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_61%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ åˆå§‹åŒ–æ—¶ï¼Œè·å–èŠå¤©è®°å½•

:::color1
æˆ‘ä»¬éœ€è¦åœ¨å…·å¤‡è‡ªå·±çš„ä¿¡æ¯å’Œå¯¹æ–¹ä¿¡æ¯ä¹‹åï¼Œæ‰å»è·å–èŠå¤©è®°å½•

:::

```typescript
 async getAllRecord () {
    this.messList = await WeChatStore.getWeChatMessage(this.talkUser.user_id)
    this.scroller.scrollEdge(Edge.Bottom)
  }
  // è·å–èŠå¤©è€…ä¿¡æ¯
  async getTalkUser() {
    this.talkUser = router.getParams() as UserInfoModel
    this.getAllRecord()
  }
```



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707673419838-cfffa0e4-8f65-48b5-a688-610531b6ea24.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::



<h1 id="VG6hR">åœ¨ä¸»é¡µå»ºç«‹èŠå¤©è®°å½•</h1>
:::color1
å› ä¸ºæˆ‘ä»¬å’ŒæŸä¸ªäººèŠäº†å¤©ï¼Œåœ¨ä¸»é¡µä¸­ï¼Œåº”è¯¥ä¿ç•™å½“å‰çš„èŠå¤©è®°å½•ï¼ŒèŠå¤©è®°å½•ä¸­åº”è¯¥æ˜¯èŠå¤©çš„æœ€åä¸€æ¡è®°å½•

:::

:::color3
åªè¦å­˜åœ¨èŠå¤©è®°å½•ï¼Œå†æ¬¡è¿›å…¥ä¸»é¡µæ—¶ï¼Œåº”è¯¥è·å–æ‰€æœ‰äººçš„èŠå¤©è®°å½•çš„æœ€åä¸€æ¡

:::

+ åœ¨utils/chat_store.etsä¸­å£°æ˜ä¸€ä¸ªè·å–æ‰€æœ‰èŠå¤©è®°å½•çš„æ–¹æ³•

```typescript
 // è·å–æ‰€æœ‰äººçš„èŠå¤©è®°å½•çš„æœ€åä¸€æ¡
  static async getAllLastRecord () {
    const store = await WeChatStore.getWeChatStore()
    const result = store.getAllSync()
    AlertDialog.show({
      message: JSON.stringify(result)
    })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707751982979-2db374a0-17e9-4736-a1cc-5dfac30a4405.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)'

+ éå†æ‰¾åˆ°æ‰€æœ‰çš„èŠå¤©è®°å½•å¹¶å–å‡ºæ‰€æœ‰èŠå¤©è®°å½•ï¼Œ

```typescript
// è·å–æ‰€æœ‰äººçš„èŠå¤©è®°å½•çš„æœ€åä¸€æ¡
  static async getAllLastRecord() {
    const store = await WeChatStore.getWeChatStore()
    const result = store.getAllSync() as object
    let list: MessageInfoModel[] = []
    Object.keys(result).map(key => {
      if (key.includes(WeChat_UserRecordKey)) {
        // å¦‚æœåŒ…å«è®°å½•çš„key
        if (result[key]) {
          let recordList = JSON.parse(result[key]) as MessageInfoModel[]
          if(recordList.length) {
            // æ·»åŠ æœ€åä¸€æ¡è®°å½•
            list.push(recordList[recordList.length - 1])
          }
        }
      }
    })
    // å¯¹listè¿›è¡Œæ’åº
    list.sort((a: MessageInfoModel, b: MessageInfoModel) => {
      return b.sendTime - a.sendTime
    })
    return list
  }
```

+ åœ¨pages/WeChat/WeChat.etså»ºç«‹ä¸»é¡µçš„ç»„ä»¶ï¼ˆéPageï¼‰

:::color3
åˆå§‹åŒ–æ—¶ï¼Œè·å–èŠå¤©è®°å½•

:::

```typescript
import { MessageInfoModel } from '../../models/message'
import { WeChatStore } from '../../utils/chat_store'

@Component
struct WeChat {
  @State
  list: MessageInfoModel[] = []
  aboutToAppear(): void {
    this.getRecordList()
  }
  async getRecordList () {
    this.list = await WeChatStore.getAllLastRecord()
  }
  // è½¬åŒ–æ—¶é—´
  transTime(time: number) {
    const dateObj = new Date(time)
    const year = dateObj.getFullYear()
    const month = dateObj.getMonth()
    const date = dateObj.getDate()
    const hours = dateObj.getHours();
    const minutes = dateObj.getMinutes();
    if (date === new Date().getDate()) {
      // å½“å¤©çš„æ¶ˆæ¯
      return `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`
    } else if (year === new Date().getFullYear()) {
      return `${(month + 1).toString()}æœˆ${date}æ—¥`
    } else {
      return `${year}å¹´${(month + 1).toString()}æœˆ${date}æ—¥`
    }
  }

  build() {
    Column() {
      List() {
        ForEach(this.list, (item: MessageInfoModel) => {
          ListItem() {
            Row({ space: 10 }) {
              Image(item.connectUser.avatar)
                .width(50)
                .height(50)
                .borderRadius(4)

              Column({ space: 10 }) {
                Row() {
                  Text(item.connectUser.username)
                    .fontColor($r('app.color.text_primary'))
                    .fontSize(16)
                  Text(this.transTime(item.sendTime))
                    .fontSize(12)
                    .fontColor($r('app.color.text_second'))
                    .margin({
                      top: 10
                    })
                }
                .justifyContent(FlexAlign.SpaceBetween)
                .width('100%')

                Text(item.messageContent)
                  .fontColor($r('app.color.text_second'))
                  .fontSize(14)
                  .maxLines(1)
              }
              .justifyContent(FlexAlign.SpaceBetween)
              .alignItems(HorizontalAlign.Start)
              .height(50)
              .layoutWeight(1)
              .padding({
                top: 3,
                bottom: 3
              })
            }
            .stateStyles({
              normal: {
                .backgroundColor($r('app.color.white'))
              },
              pressed: {
                .backgroundColor($r('app.color.back_color'))
              }
            })
          }
          .padding({
            top: 10,
            bottom: 10
          })
        })
      }
      .divider({
        strokeWidth: 1,
        color: $r('app.color.border_color')
      })
      .padding({
        left: 10,
        right: 20
      })
    }

    .height('100%')


  }
}

export default WeChat
```

+ åœ¨pages/Index.etsä¸­æ˜¾ç¤ºWeChat

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711544304295-3ca57b53-af59-4870-b853-a8c8abb0d4eb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_35%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707756164461-8e2e6b08-9bf0-4e67-aafd-ff0927698ef3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color3
æäº¤ä»£ç 

:::



<h1 id="mjhi8">å¤„ç†é¦–é€‰é¡¹çš„é•¿åº¦é™åˆ¶é—®é¢˜</h1>
:::color2
å› ä¸ºç›®å‰æ˜¯å°†ä¸€ä¸ªäººæ‰€æœ‰çš„èŠå¤©è®°å½•å­˜äºä¸€ä¸ªKeyé‡Œé¢ï¼Œä½†æ˜¯valueçš„é•¿åº¦æœ‰8192å­—èŠ‚çš„é™åˆ¶ï¼Œ

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712212993659-4f86afcb-b0b0-433d-9b66-a1043fc09e44.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

+ æ‰€ä»¥é’ˆå¯¹è¯¥ä¸šåŠ¡è¿›è¡Œå¦‚ä¸‹çš„æ”¹åŠ¨

:::color2
æˆ‘å’Œæ¯ä¸ªäººçš„èŠå¤©è®°å½•å­˜ä¸€ä¸ªä»“åº“ï¼Œæ¯æ¡æ¶ˆæ¯å­˜å•ç‹¬çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¸€ä¸ªèŠ‚ç‚¹çš„é™åˆ¶1ä¸‡ä¸ªå­—

+ èŠå¤©è®°å½•ä»“åº“keyè§„èŒƒ-  å›ºå®škey_+ç”¨æˆ·id
+ èŠå¤©è¯¦æƒ…key_ é‡‡ç”¨æ¶ˆæ¯id 

:::

+ æ”¹é€ åæ–¹æ³•(è°ƒç”¨æ–¹ä¸éœ€è¦æ”¹å˜)

```typescript
import {
  WeChat_StoreKey,
  WeChat_ConnectKey,
  WeChat_CurrentUserKey,
  WeChat_UserRecordKey,
} from '../constants'
import preferences from '@ohos.data.preferences'
import { DefaultUserList, UserInfoModel, CurrentUser } from '../models/users'
import { MessageInfoModel } from '../models/message'
import { emitter } from '@kit.BasicServicesKit'

export class WeChatStore {
  static context: Context

  static getWeChatStore() {
    return preferences.getPreferences(WeChatStore.context || getContext(), WeChat_StoreKey)
  }

  // è·å–å¾®ä¿¡è”ç³»äºº
  static async getWeChatConnect() {
    const store = await WeChatStore.getWeChatStore()
    return JSON.parse(store.getSync(WeChat_ConnectKey, JSON.stringify(DefaultUserList)) as string) as UserInfoModel[]
  }

  // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
  static async getCurrentUser() {
    const store = await WeChatStore.getWeChatStore()
    return JSON.parse(store.getSync(WeChat_CurrentUserKey, JSON.stringify(CurrentUser)) as string) as UserInfoModel
  }

  static getWeChatMessageStore(userId: string) {
    return preferences.getPreferencesSync(getContext(), {
      name: `${WeChat_UserRecordKey}_${userId}`
    })
  }

  // è·å–æŸä¸ªäººçš„æ•´ä¸ªçš„èŠå¤©è®°å½•
  static  getWeChatMessage(userId: string) {
    const store = WeChatStore.getWeChatMessageStore(userId)
    const allRecord = store.getAllSync() as object
    if(allRecord) {
     const list = Object.values(allRecord).map((item: string) => JSON.parse(item) as MessageInfoModel)
      list.sort((a, b) => a.sendTime - b.sendTime )
      return list
    }
    return []

  }

  // åˆ é™¤æŸä¸ªäººæ•´ä¸ªçš„èŠå¤©è®°å½•
  static async delWeChatMessage(userId: string) {
    preferences.deletePreferences(getContext(), {
      name: `${WeChat_UserRecordKey}_${userId}`
    })
  }

  // æ·»åŠ æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async addOneWeChatMessage(userId: string, mess: MessageInfoModel) {
    const store =  WeChatStore.getWeChatMessageStore(userId)
    store.putSync(mess.id, JSON.stringify(mess))
    await store.flush()
  }

  // åˆ é™¤æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async delOneWeChatMessage(userId: string, messId: string) {
    const store =  WeChatStore.getWeChatMessageStore(userId)
    store.deleteSync(messId)
    await store.flush()
  }

  // è·å–æ‰€æœ‰äººçš„èŠå¤©è®°å½•çš„æœ€åä¸€æ¡
  static async getAllLastRecord() {
    const users = await WeChatStore.getWeChatConnect()
    let list: MessageInfoModel[] = []
    users.forEach(user => {
      const messList = WeChatStore.getWeChatMessage(user.user_id)
      if(messList && messList.length) {
        list.push(messList[messList.length - 1])
      }
    })

    // å¯¹listè¿›è¡Œæ’åº
    list.sort((a: MessageInfoModel, b: MessageInfoModel) => {
      return b.sendTime - a.sendTime
    })
    return list
  }
}
```



:::color2
å¤„ç†è¿›å»è¯¦æƒ…é¡µä¸æ»šåŠ¨åˆ°åº•éƒ¨çš„é—®é¢˜

:::



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712215661369-8a56a29e-cb12-4d3f-953a-948c8fc53ea4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_47%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

<h1 id="SaTJ0">é€šè¿‡çº¿ç¨‹é€šä¿¡æ›´æ–°èŠå¤©è®°å½•</h1>
:::info
emitterå¯ä»¥æ”¯æŒä¸åŒçº¿ç¨‹å†…çš„æ•°æ®é€šä¿¡

+ ç”¨æ³•
1. <font style="color:rgb(40, 113, 204);">é€šè¿‡onæ–¹æ³•ç›‘å¬äº‹ä»¶</font>
2. <font style="color:rgb(40, 113, 204);">é€šè¿‡emitè§¦å‘äº‹ä»¶</font>
3. <font style="color:rgb(40, 113, 204);">éœ€è¦é€šè¿‡ç»Ÿä¸€çš„eventIdæˆ–è€…eventNameæ¥ç»‘å®šæ¥è¿›è¡Œç»‘å®š</font>

:::



:::color2
å› ä¸ºæ— è®ºæ€ä¹ˆå‘æ¶ˆæ¯ï¼Œéƒ½ä¼šè®²è¿‡chat_storeä¸­çš„æ·»åŠ æ¶ˆæ¯å’Œåˆ é™¤æ¶ˆæ¯ï¼Œæ‰€ä»¥åªéœ€è¦åœ¨è¿™é‡Œå‡ºå‘äº‹ä»¶å³å¯

:::

+ åœ¨constants/index.etsä¸­å®šä¹‰ä¸€ä¸ªæ›´æ–°èŠå¤©è®°å½•äº‹ä»¶åç§°

```typescript
export const Record_Update_EventName: string = "update_record" // æ›´æ–°èŠå¤©è®°å½•çš„key
```

+ åœ¨æ·»åŠ æˆ–è€…åˆ é™¤æ¶ˆæ¯çš„æ—¶å€™ï¼Œè§¦å‘è¯¥äº‹ä»¶

```typescript
// æ·»åŠ æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async addOneWeChatMessage(userId: string, mess: MessageInfoModel) {
    const store = await WeChatStore.getWeChatStore()
    const list = await WeChatStore.getWeChatMessage(userId)
    list.push(mess) // æ·»åŠ è®°å½•
    store.putSync(`${WeChat_UserRecordKey}_${userId}`, JSON.stringify(list))
    await store.flush()
    emitter.emit(Record_Update_EventName)
  }

  // åˆ é™¤æŸä¸ªäººçš„ä¸€æ¡èŠå¤©è®°å½•
  static async delOneWeChatMessage(userId: string, messId: string) {
    const store = await WeChatStore.getWeChatStore()
    let list = await WeChatStore.getWeChatMessage(userId)
    list = list.filter(item => item.id !== messId) // æ’é™¤è®°å½•
    store.putSync(`${WeChat_UserRecordKey}_${userId}`, JSON.stringify(list))
    await store.flush()
    emitter.emit(Record_Update_EventName)
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707757118037-bfaca0e5-b499-47a1-91ad-8c93a56f2909.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_61%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨WeChat/Index.etsä¸­ç›‘å¬

```typescript
 async getRecordList () {
    this.list = await WeChatStore.getAllLastRecord()
    emitter.on(Record_Update_EventName, async () => {
      // æ›´æ–°èŠå¤©è®°å½•
      this.list = await WeChatStore.getAllLastRecord()
    })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711692746533-98394895-06d0-4895-a473-b9ea45dec583.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_16%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color2
æäº¤ä»£ç 

:::



<h1 id="KQdci">ç‚¹å‡»ä¸»é¡µçš„èŠå¤©è¿›å…¥èŠå¤©è¯¦æƒ…</h1>
:::color2
å½“æˆ‘ä»¬ç‚¹å‡»ä¸»é¡µçš„èŠå¤©è®°å½•æ—¶ï¼Œæˆ‘ä»¬éœ€è¦è¿›å…¥åˆ°è¯¦æƒ…ä¸­

+ å’Œä¹‹å‰ç‚¹å‡»è”ç³»äººè¿›å…¥èŠå¤©è¯¦æƒ…ä¸€è‡´

:::

+ æ³¨å†ŒListItemçš„ç‚¹å‡»äº‹ä»¶

```typescript
ListItem() 
...
  .onClick(() => {
             router.pushUrl({
              url: 'pages/ChatDetail/ChatDetail',
              params: item.connectUser
            })
          })
```

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707759291176-01be5c49-b28e-49df-9027-69128f6f88f9.gif)



:::color1
æäº¤ä»£ç 

:::



<h1 id="gLFXQ">èŠå¤©è¯¦æƒ…-é•¿æŒ‰æ˜¾ç¤ºæµ®å±‚èœå•</h1>
:::color1
+ æ ¹æ®å¾®ä¿¡çš„äº¤äº’ï¼Œå½“æˆ‘ä»¬é•¿æŒ‰ä¸€ä¸ªä¿¡æ¯çš„æ—¶å€™ï¼Œåº”è¯¥ä¼šå‡ºç°å¦‚å›¾

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707790144281-2ac7eafa-aaa6-43f9-8480-2a032771d5b9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ ¹æ®æ‰‹åŠ¿äº‹ä»¶ + çŠ¶æ€æ§åˆ¶æ¥æ˜¾ç¤ºè¿™äº›

:::

+ å®šä¹‰ä¸€ä¸ªæ˜¾ç¤ºPopupçš„çŠ¶æ€

:::success
ç»„ä»¶ä½ç½®ï¼š ChatDetail/Components/Message.ets

:::

```typescript
  @State
  showPopup: boolean = false // æ˜¯å¦æ˜¾ç¤ºæµ®å±‚
```

+ ç»™æ¯ä¸ªæ–‡æœ¬æ¶ˆæ¯ç»‘å®šé•¿æŒ‰æ‰‹åŠ¿äº‹ä»¶

```typescript
Column() {
  ...
}
.gesture(
          LongPressGesture()
            .onAction(() => {
              this.showPopup = true // æ˜¾ç¤ºçˆ¶å±‚
            }))
```

+ ç»™å½“å‰çš„æ–‡æœ¬å…ƒç´ ä½¿ç”¨bindPopupå±æ€§

```typescript
 Text(this.currentMessage.messageContent)
          .backgroundColor(this.isOwnMessage ? $r("app.color.second_primary") : $r("app.color.white"))
          .fontColor($r("app.color.text_primary"))
          .padding(10)
          .margin({
            left: 10,
            right: 10
          })
          .borderRadius(4)
          .bindPopup(this.showPopup, {
            builder:  this.getContent,
            popupColor: $r("app.color.popup_back"),
            backgroundBlurStyle: BlurStyle.NONE,
            onStateChange: (event) => {
              // å½“æ‰‹æŒ‡ç‚¹äº†å…¶ä»–ä½ç½® å…³é—­çŠ¶æ€
              this.showPopup = event.isVisible
            }
          })
```

+ åœ¨models/popup.etsä¸­å®šä¹‰å¯¹åº”çš„ç±»å‹

```typescript
export interface PopupItem {
  title: string
  icon: ResourceStr
  itemClick?: () => void
}
```

+ åœ¨Messageä¸­å£°æ˜å¯¹åº”çš„æ•°æ®

```typescript
@State
  popupList: PopupItem[] = [{
    title: 'å¬ç­’æ’­æ”¾',
    icon: $r("app.media.ic_public_ears")
  },
    {
      title: 'æ”¶è—',
      icon: $r("app.media.ic_public_cube")
    }, {
      title: 'è½¬æ–‡å­—',
      icon: $r("app.media.ic_public_trans_text")
    }, {
      title: 'åˆ é™¤',
      icon: $r("app.media.ic_public_cancel")
    }, {
      title: 'å¤šé€‰',
      icon: $r("app.media.ic_public_multi_select")
    }, {
      title: 'å¼•ç”¨',
      icon: $r("app.media.ic_public_link")
    }, {
      title: 'æé†’',
      icon: $r("app.media.ic_public_warin")
    }]
```

+ å°è£…getContentçš„builderæ–¹æ³•

```typescript
// ç”¨æ¥æ˜¾ç¤ºå¼¹å±‚çš„å†…å®¹
  @Builder
  getContent() {
     GridRow ({ columns: 5 }) {
       ForEach(this.popupList, (item: PopupItem) => {
         GridCol() {
           Column({ space: 6 }) {
             Image(item.icon)
               .fillColor($r("app.color.white"))
               .width(18)
               .height(18)
             Text(item.title)
               .fontColor($r("app.color.white"))
               .fontSize(14)
           }
           .height(60)
         }
         .onClick(() => {
           item.itemClick && item.itemClick() // å¦‚æœç‚¹å‡»äº‹ä»¶å­˜åœ¨ å°±è§¦å‘
         })
       })
     }
    .width(300)
    .padding({
      top: 15,
      left: 10
    })
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707812329399-19795026-091c-494b-842c-d1e14cf3a0e1.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::



<h1 id="Ne3Y7">åˆ é™¤æŸä¸€æ¡èŠå¤©è®°å½•</h1>
+ æ³¨å†Œåˆ é™¤å›¾æ ‡çš„äº‹ä»¶

```typescript
{
      title: 'åˆ é™¤',
      icon: $r("app.media.ic_public_cancel"),
      itemClick: () => {
         this.delMessage(this.currentMessage.id)
      }
    }
```

+ ç»™å…ƒç´ æ³¨å†Œç‚¹å‡»äº‹ä»¶

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707814145374-03156483-cd7c-48b4-a1c3-fab188415a69.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_45%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å®šä¹‰ä¼ å…¥çš„ä¸€ä¸ªæ–¹æ³•

```typescript
// åˆ é™¤ä¿¡æ¯çš„æ–¹æ³•
  delMessage: (messId: string) => void = () => {}
```

+ åœ¨çˆ¶ç»„ä»¶ChatDetail/ChatDetail.etsä¸­ä¼ å…¥delMessageæ–¹æ³•

```typescript
// åˆ é™¤ä¿¡æ¯çš„æ–¹æ³•
  delMessage (messId: string) {
    if(messId) {
      // å…ˆç§»é™¤å½“å‰ç»„ä»¶çš„æ•°æ®
      const index = this.messList.findIndex(item => item.id === messId)
      if(index > -1) {
        this.messList.splice(index, 1)
      }
      // å†ç§»é™¤é¦–é€‰é¡¹çš„æ•°æ®
      WeChatStore.delOneWeChatMessage(this.talkUser.user_id, messId)
    }
  }
```

+ ä¼ å…¥æ–¹æ³•

```typescript
 Message({ currentMessage: item, delMessage: (messId: string) => {
              this.delMessage(messId)
            } })
```

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707814299103-c904ab4f-f7df-4920-8253-feecc1c8f7dd.gif)



:::color1
æäº¤ä»£ç 

:::



<h1 id="iwGB7">å®ç°åˆ é™¤æ•´ä¸ªçš„èŠå¤©è®°å½•</h1>
:::color1
å½“æˆ‘ä»¬åœ¨èŠå¤©è®°å½•ä¸­æ»‘åŠ¨æŸä¸ªäººçš„èŠå¤©è®°å½•æ—¶ï¼Œå¯ä»¥åœ¨å³ä¾§å‡ºç°åˆ é™¤æŒ‰é’®ï¼Œç‚¹å‡»åˆ é™¤ï¼Œæˆ‘ä»¬å°±å¯ä»¥å°†æ•´ä¸ªçš„è®°å½•æ¸…é™¤æ‰

:::

+ æ¥åˆ°WeChat/Index.etsæ–‡ä»¶ä¸­ï¼Œåœ¨ListItemå°¾éƒ¨æ·»åŠ åˆ é™¤å…ƒç´ 

```typescript
ListItem() 
  ...
.swipeAction({
            end: () => {
              this.getListEnd()
            }
          })
```

+ å®ç°getListEndæ–¹æ³•

```typescript
 @Builder
  getListEnd() {
    Row() {
      Text("åˆ é™¤")
        .fontColor($r('app.color.white'))
        .width(100)
        .textAlign(TextAlign.Center)
    }.height(70)
    .padding({
      left: 20,
      right: 20
    })
    .backgroundColor($r('app.color.danger'))
  }
```

æ•ˆæœå¦‚å›¾

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707816143669-102ec9f3-f520-4811-bd24-d17e95e33b87.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ æ³¨å†Œç‚¹å‡»äº‹ä»¶

```typescript
@Builder
  getListEnd(userId: string) {
    Row() {
      Text("åˆ é™¤")
        .fontColor($r('app.color.white'))
        .width(100)
        .height(70)
        .textAlign(TextAlign.Center)
        .onClick(() => {
           if(userId) {
             // å…ˆåˆ é™¤ç»„ä»¶ä¸­æ•°æ®
             let index = this.list.findIndex(item => item.connectUser.user_id === userId)
             if(index > -1) {
               this.list.splice(index, 1)
             }
             // å†ç§»é™¤é¦–é€‰é¡¹
             WeChatStore.delWeChatMessage(userId)
           }
        })
    }.height(70)
    .padding({
      left: 20,
      right: 20
    })
    .backgroundColor($r('app.color.danger'))

  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707818975908-be6ba0b3-d0b2-4c5a-b93b-9b3b7b694f32.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="dxwwd">é•¿æŒ‰æ˜¾ç¤ºè¯­éŸ³ç»„ä»¶</h1>
:::color1
ç°åœ¨æˆ‘ä»¬åŸºæœ¬ä¸Šå®ç°äº†æ–‡æœ¬æ¶ˆæ¯çš„å¢åˆ æ”¹æŸ¥ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦å®ç°åœ¨é•¿æŒ‰â€œæŒ‰ä½è¯´è¯â€æ—¶çš„è¯­éŸ³è¾“å…¥ç»„ä»¶

:::

+ é¦–å…ˆè¿˜æ˜¯é€šè¿‡é•¿æŒ‰æ‰‹åŠ¿äº‹ä»¶æ¥æ§åˆ¶
+ ç›‘å¬æŒ‰ä½è¯´è¯çš„é•¿æŒ‰æ‰‹åŠ¿äº‹ä»¶

```typescript
  @State
  showVoiceCom: boolean = false // æ˜¯å¦æ˜¾ç¤ºå‘é€è¯­éŸ³ç»„ä»¶
  Button("æŒ‰ä½ è¯´è¯", { type: ButtonType.Normal })
            .backgroundColor(Color.White)
            .layoutWeight(1)
            .borderRadius(2)
            .fontColor($r('app.color.text_primary'))
           .gesture(LongPressGesture()
              .onAction(() => {
                this.showVoiceCom = true // é•¿æŒ‰æ‰“å¼€
              })
              .onActionEnd(() => {
                this.showVoiceCom = false // æ¾æ‰‹å…³é—­
              }))
```

+ åˆ›å»ºChatDetail/Components/VoiceInput.etsç»„ä»¶

```typescript
@Component
struct VoiceInput {
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
        // æ˜¾ç¤ºå…³é—­å’Œæ–‡æœ¬
        Row() {
          Row() {
            Image($r("app.media.ic_public_cancel"))
              .width(30)
              .height(30)
              .fillColor($r("app.color.voice_round_font_color"))
          }
          .width(70)
          .aspectRatio(1)
          .borderRadius(35)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r("app.color.voice_round_color"))
          .rotate({
            angle: -10
          })

          Row() {
            Text("æ–‡")
              .fontSize(24)
              .textAlign(TextAlign.Center)
              .fontColor($r("app.color.voice_round_font_color"))
          }
          .width(70)
          .aspectRatio(1)
          .borderRadius(35)
          .justifyContent(FlexAlign.Center)
          .backgroundColor($r("app.color.voice_round_color"))
          .rotate({
            angle: 10
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .padding({
          left: 40,
          right: 40
        })
        .margin({
          bottom: 30
        })

        Stack() {
          Image($r("app.media.ic_public_output"))
            .width('100%')
            .height(120)
            .fillColor($r("app.color.bottom_color"))
            .scale({
              x: 1.2
            })
          Image($r("app.media.ic_public_recorder"))
            .width(30)
            .height(30)
            .fillColor($r("app.color.bottom_voice_color"))
        }
        .width('100%')
      }
    }
    .height('100%')
    .backgroundColor($r("app.color.voice_back_color"))

  }
}

export default VoiceInput
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707838500180-7eeeafe8-1ad7-4c72-9b98-d60e7bf051f5.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ ä½¿ç”¨bindContentConveræ¨¡æ€æ§åˆ¶![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711698933544-74519815-7210-4886-9534-664b1a5f4011.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_46%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

```typescript
 .bindContentCover($$this.showVoiceCom, this.getVoiceCom,{
      modalTransition: ModalTransition.NONE
    })
```



![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707841929989-c9585a1a-908e-4ea9-b369-1f2c3e31b7e0.gif)



:::color1
æäº¤ä»£ç 

:::



<h1 id="eKQak">ç»„åˆæ‰‹åŠ¿ç§»åŠ¨è®¾ç½®ä¸åŒçŠ¶æ€</h1>
:::color1
å½“æˆ‘ä»¬é•¿æŒ‰ä¹‹åï¼Œæ­¤æ—¶å¯ä»¥æ»‘åŠ¨å·¦ç§»ï¼Œå³ç§»ï¼Œ ä¹Ÿå¯ä»¥ä¿æŒç•™åœ¨åŸåœ°ï¼Œæ­¤æ—¶ä¼šæœ‰ä¸‰ç§çŠ¶æ€

1. å·¦ç§»å–æ¶ˆ
2. å³ç§»è¯­éŸ³è½¬æ–‡å­—
3. ç•™åœ¨åŸåœ°å½•åˆ¶éŸ³é¢‘

:::

+ åœ¨models/voice.etsä¸­å¯¼å‡ºä¸€ä¸ªæšä¸¾

```typescript
export enum VoiceRecordEnum {
  Cancel, // å–æ¶ˆå½•åˆ¶
  RecordIng, // å½•åˆ¶ä¸­
  Transfer // è¯­éŸ³è½¬åŒ–
}
```

+ åœ¨BottomInputä¸­å£°æ˜ä¸€ä¸ªåˆå§‹åŒ–çŠ¶æ€

```typescript
  @Provide
  voiceState: VoiceRecordEnum = VoiceRecordEnum.RecordIng // å½“å‰çš„çŠ¶æ€
  screenWidth: number = 0 // è®°å½•æ•´ä½“å®½åº¦
```

+ é€šè¿‡displayè·å–å±å¹•å®é™…å®½åº¦vp

```typescript
 aboutToAppear(): void {
    this.getScreenWidth()
  }
  async getScreenWidth() {
    const result = await display.getAllDisplays()
    if (result && result.length) {
      this.screenWidth = px2vp(result[0].width)
      this.screenHeight = px2vp(result[0].height)
    }
  }
```

+ ä½¿ç”¨ç»„åˆæ‰‹åŠ¿å¤„ç† é•¿æŒ‰ + ç§»åŠ¨çš„ä¸šåŠ¡

```typescript
 Button("æŒ‰ä½ è¯´è¯", { type: ButtonType.Normal })
  ...
  .gesture(
              GestureGroup(GestureMode.Parallel,
                // é•¿æŒ‰æ‰‹åŠ¿
                LongPressGesture()
                  .onAction(() => {
                    this.showVoiceCom = true
                  })
                  .onActionEnd(() => {
                    this.showVoiceCom = false
                      this.voiceState = VoiceRecordEnum.RecordIng
                  }),
                // æ‹–åŠ¨æ‰‹åŠ¿
                PanGesture()
                  .onActionUpdate((event) => {
                    // å–æ¶ˆ
                    if (event.fingerList[0].globalY > this.screenHeight - 120) {
                      // è¡¨ç¤ºæ²¡æœ‰å‡ºå»å½•éŸ³åŒº
                      this.voiceState = VoiceRecordEnum.RecordIng
                    } else {
                      // è¡¨ç¤ºå‡ºå»äº†
                      if (event.fingerList[0].globalX < this.screenWidth / 2) {
                        this.voiceState = VoiceRecordEnum.Cancel
                      } else {
                        this.voiceState = VoiceRecordEnum.Transfer
                      }
                    }

                  })
              )
            )
```

:::color1
GestureModeçš„å±æ€§ä»‹ç»

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1707842816553-9eb7bb44-b430-4a80-a0cf-a67bd5e57a38.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_46%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

 

:::

+ åœ¨VoiceInputä¸­æ ¹æ®çŠ¶æ€æ§åˆ¶æ˜¾ç¤ºå†…å®¹

```typescript
import { VoiceRecordEnum } from '../../../models/voice'

@Preview
@Component
struct VoiceInput {
  @Consume
  voiceState: VoiceRecordEnum
  aboutToDisappear(): void {
    this.voiceState = VoiceRecordEnum.RecordIng
  }
  build() {
    Stack({ alignContent: Alignment.Bottom }) {
      Column() {
      }.height('100%')
      .width('100%')
      .justifyContent(FlexAlign.Center)

      // åº•éƒ¨å†…å®¹
      Column() {
        Row() {
          // å·¦ä¾§å†…å®¹
          Row() {
            Image($r('app.media.ic_public_cancel'))
              .width(30)
              .height(30)
              .fillColor(this.voiceState === VoiceRecordEnum.Cancel ? $r('app.color.text_primary') : $r('app.color.voice_round_font_color'))

          }
          .backgroundColor( this.voiceState === VoiceRecordEnum.Cancel ? $r('app.color.bottom_color') : $r('app.color.voice_round_color'))
          .width(70)
          .height(70)
          .borderRadius(35)
          .justifyContent(FlexAlign.Center)
          .rotate({
            angle: -10
          })
          .scale({
            x: this.voiceState === VoiceRecordEnum.Cancel ? 1.2 : 1,
            y: this.voiceState === VoiceRecordEnum.Cancel ? 1.2 : 1
          })

          Row() {
            Text("æ–‡")
              .textAlign(TextAlign.Center)
              .fontSize(24)
              .fontColor(this.voiceState === VoiceRecordEnum.Transfer ? $r('app.color.text_primary') : $r('app.color.voice_round_font_color'))
          }
          .backgroundColor( this.voiceState === VoiceRecordEnum.Transfer ? $r('app.color.bottom_color') : $r('app.color.voice_round_color'))
          .width(70)
          .height(70)
          .borderRadius(35)
          .justifyContent(FlexAlign.Center)
          .rotate({
            angle: 10
          })
          .scale({
            x: this.voiceState === VoiceRecordEnum.Transfer ? 1.2 : 1,
            y: this.voiceState === VoiceRecordEnum.Transfer ? 1.2 : 1
          })
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceBetween)
        .padding({
          left: 40,
          right: 40
        })
        .margin({
          bottom: 30
        })
        Stack() {
          // åº•éƒ¨å›¾ç‰‡
          Image($r('app.media.ic_public_output'))
            .width('100%')
            .height(120)
            .fillColor(this.voiceState === VoiceRecordEnum.RecordIng ? $r('app.color.bottom_color') : $r('app.color.voice_round_color'))
            .scale({
              x: 1.2
            })
          Image($r('app.media.ic_public_recorder'))
            .width(30)
            .height(30)
            .fillColor(this.voiceState === VoiceRecordEnum.RecordIng ? $r('app.color.bottom_voice_color') : $r('app.color.bottom_color'))

        }
        .height(120)
        .width('100%')
      }
    }
    .height('100%')
    .width('100%')
    .backgroundColor($r('app.color.voice_back_color'))
  }
}
export default VoiceInput
```

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707843783640-c9a48714-a3c0-4390-a94e-3e644117d382.gif)

:::color1
æäº¤ä»£ç 

:::



<h1 id="Lq2Bc">æ ¹æ®ä¸åŒçŠ¶æ€æ˜¾ç¤ºä¸åŒå†…å®¹</h1>
:::color1
æ»‘åŠ¨åˆ°ä¸åŒçš„çŠ¶æ€æ—¶ï¼Œåˆ‡æ¢æ˜¾ç¤ºå†…å®¹çš„ä¸åŒå†…å®¹

:::

![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1707997394258-0957d754-3f42-48bb-a62e-db6a53590cb4.gif)

  

+ å°è£…ä¸€ä¸ªbuilder

```typescript
 @Builder
  getDisplayContent () {
    if(this.voiceState === VoiceRecordEnum.Cancel) {
      Row()
        .height(80)
        .width(100)
        .borderRadius(20)
        .backgroundColor($r('app.color.danger'))
        .margin({
          left: 30
        })
    }
    if(this.voiceState === VoiceRecordEnum.RecordIng) {
      Row()
        .height(80)
        .width(180)
        .borderRadius(20)
        .backgroundColor($r('app.color.chat_primary'))
    }

    if(this.voiceState === VoiceRecordEnum.Transfer) {
      Row()
        .height(120)
        .width(280)
        .borderRadius(20)
        .backgroundColor($r('app.color.chat_primary'))
    }
  }
```

+ æ˜¾ç¤ºå†…å®¹

```typescript
 Column() {
        this.getDisplayContent()
      }.height('100%')
      .width('100%')
      .justifyContent(FlexAlign.Center)
      .alignItems(this.voiceState === VoiceRecordEnum.Cancel ?  HorizontalAlign.Start : HorizontalAlign.Center)
```

:::color1
æäº¤ä»£ç 

:::



<h1 id="OfXqn">å½•éŸ³å®ç°è¿‡ç¨‹ã€</h1>
:::color2
å‘é€è¯­éŸ³

   å’Œå‘é€æ¶ˆæ¯æ˜¯ä¸€æ ·çš„ï¼Œåªä¸è¿‡æ¶ˆæ¯çš„æœ¬è´¨ä¸Šæ˜¯éŸ³é¢‘æ–‡ä»¶ï¼Œmp3, wav, m4a,

 å¾®ä¿¡çš„å‘é€è¯­éŸ³åŸç†- åœ¨æœ¬åœ°é€šè¿‡æ‰‹æœºä¾§å½•åˆ¶ä¸€æ®µéŸ³é¢‘ï¼Œå½¢æˆ æ–‡ä»¶ï¼ˆå†™å…¥ç£ç›˜ï¼‰-bufferï¼ˆå†…å­˜å½¢å¼ï¼‰- æµ

èŠå¤©è®°å½•åªè¦å­˜åœ¨

    å¾®ä¿¡èŠå¤©è®°å½• å­˜äºé¦–é€‰é¡¹é‡Œé¢- æ²™ç®±æ–‡ä»¶è·¯å¾„-æŒ‡å®šçš„å°±æ˜¯ éŸ³é¢‘ è§†é¢‘ ç…§ç‰‡ 

:::





:::color2
<font style="color:rgba(0, 0, 0, 0.9);">ä½¿ç”¨AudioCapturerå½•åˆ¶éŸ³é¢‘æ¶‰åŠåˆ°AudioCapturerå®ä¾‹çš„åˆ›å»ºã€éŸ³é¢‘é‡‡é›†å‚æ•°çš„é…ç½®ã€é‡‡é›†çš„å¼€å§‹ä¸åœæ­¢ã€èµ„æºçš„é‡Šæ”¾ç­‰</font>

:::

:::color3
ç›®å‰åªæ”¯æŒçœŸæœºæµ‹è¯•

:::

:::success
ä½¿ç”¨Audio

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711701005307-392b6432-2a51-4a17-bbe4-c677b699de31.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_18%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711816787944-3b4a8e13-3ad9-4220-a09f-5fcdc8629d35.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_13%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
æƒé™  éº¦å…‹é£ ç…§ç›¸æœº è¿™äº›æƒé™åªä¼šç”³è¯·ä¸€æ¬¡ å°±è®°ä½å•¦

:::

+ é¦–å…ˆåœ¨module.json5ä¸­é…ç½®æƒé™ç”³è¯·éº¦å…‹é£æƒé™

```typescript
{
      "name": "ohos.permission.MICROPHONE",
      "reason": "$string:MICROPHONE_REASON",
      "usedScene": {
        "abilities": ["EntryAbility"],
        "when": "always"
      }
    }
```



+ åœ¨media/string.jsonä¸­é…ç½®å¯¹åº”çš„reasonå±æ€§

```typescript
 {
      "name": "MICROPHONE_REASON",
      "value": "ç”¨äºå‘é€è¯­éŸ³"
    }
```

:::color2
æƒé™åˆ†ä¸¤ä¸ª

    ç³»ç»Ÿæƒé™ . system_agent .  æ¯”å¦‚ç½‘ç»œæƒé™-ä¸éœ€è¦æ‰‹åŠ¨ç”³è¯·ï¼Œä¸éœ€è¦ç”¨æˆ·åŒæ„

    éœ€è¦ç”¨æˆ·æˆæƒçš„æƒé™ user_agent ã€‚éº¦å…‹é£-è¯»å†™é€šè®¯å½• å¿…é¡»å¾—ç”¨æˆ·åŒæ„

:::

+ åœ¨é•¿æŒ‰çš„é€»è¾‘ä¸­åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»ç”³è¯·äº†éº¦å…‹é£æƒé™ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç”³è¯·

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711704136130-f4ef22db-0077-4f8b-bfad-0466a4148fcb.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_29%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
é¡¹ç›®ä¸€å¯åŠ¨å°±ç”³è¯·ä¸€ä¸‹ éº¦å…‹é£

abilityçš„onCreateä¸­å°±å¯ä»¥å®ç°

:::

+ åœ¨abilityä¸­ç”³è¯·éº¦å…‹é£æƒé™

```typescript
 async onCreate(want: Want, launchParam: AbilityConstant.LaunchParam): Promise<void> {
    hilog.info(0x0000, 'testTag', '%{public}s', 'Ability onCreate');
    const manager = abilityAccessCtrl.createAtManager() // åˆ›å»ºç¨‹åºæ§åˆ¶ç®¡ç†å™¨
    await manager.requestPermissionsFromUser(this.context,
      [
        "ohos.permission.MICROPHONE"
      ])
  }
```

:::color2
**<font style="color:#DF2A3F;">å¦‚æœå·²ç»ç”³è¯·è¿‡æƒé™ï¼Œå†æ¬¡å»è¯·æ±‚æƒé™å¼¹çª—å·²ç»ä¸å‡ºæ¥å•¦ï¼ï¼ï¼ï¼</font>**

**<font style="color:#DF2A3F;">å½“æˆ‘ä»¬æŒ‰ä½è¯´è¯æ—¶ï¼Œéƒ½å¾—å»æ£€æŸ¥ä¸€ä¸‹</font>**

:::



:::color2
éœ€è¦CheckAceessTokenSyncæ–¹æ³•æ¥è·å–æ˜¯å¦æ‹¥æœ‰äº†æƒé™

ä½†æ˜¯CheckAceessTokenSync éœ€è¦tokenId, tokenIdåˆéœ€è¦ ä¸€ä¸ªæ–¹æ³•æ¥è·å–

:::

```typescript
// æ£€æŸ¥æƒé™
  async checkPermission() {
    try {
      const manager = abilityAccessCtrl.createAtManager() // åˆ›å»ºç¨‹åºæ§åˆ¶ç®¡ç†å™¨
      // è·å–åº”ç”¨ä¿¡æ¯
      const buildInfo = bundleManager.getBundleInfoForSelfSync(bundleManager.BundleFlag.GET_BUNDLE_INFO_WITH_APPLICATION)
      const status = manager.checkAccessTokenSync(buildInfo.appInfo?.accessTokenId, "ohos.permission.MICROPHONE")
      if (status === abilityAccessCtrl.GrantStatus.PERMISSION_DENIED) {
        // ä¸è¢«å…è®¸
        const context = getContext() as common.UIAbilityContext
        context.startAbility({
          bundleName: 'com.huawei.hmos.settings',
          abilityName: 'com.huawei.hmos.settings.MainAbility',
          uri: "application_info_entry",
          parameters: {
            pushParams: buildInfo.name
          }
        })
      } else {
        this.showVoiceCom = true
        this.beginCollectVoice()
      }
    } catch (error) {

    }
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711706833342-55e6a9e4-67df-4bc3-9cc5-c896ab736576.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_42%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708099277159-a1441e34-f299-4c41-9a64-07a23f45495a.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_14%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ–°å»ºutils/file_operate.ets(æ–‡ä»¶æ“ä½œ)

:::color2
å› ä¸ºåç»­è§†é¢‘å’ŒéŸ³é¢‘ç…§ç‰‡ä¼šé¢‘ç¹åˆ›å»ºæ–‡ä»¶ï¼Œæ‰€ä»¥å°è£…ä¸€ä¸ªå…¬å…±çš„æ“ä½œç±»

:::

```typescript
import { fileIo } from '@kit.CoreFileKit'

export class FileCommon {
  // åˆ›å»ºä¸€ä¸ªéŸ³é¢‘æ–‡ä»¶ å¹¶è¿”å›è·¯å¾„
  static createAudioFile() {
    let filePath = getContext().filesDir + '/' + Date.now() + '.wav'
    const file = fileIo.openSync(filePath, fileIo.OpenMode.CREATE)
    fileIo.closeSync(file)
    return filePath // åˆ›å»ºæ–‡ä»¶
  }
  static delFilePath (filePath: string) {
    if(filePath) {
      fileIo.unlinkSync(filePath)
    }
  }
}
```

+ æ–°å»º<font style="color:rgba(0, 0, 0, 0.9);">utils/audio_recorder.etsæ–‡ä»¶</font>

```typescript
import { audio } from '@kit.AudioKit'
import { fileIo } from '@kit.CoreFileKit'

export default class AudioCapturer {
  static audioCapturer: audio.AudioCapturer
  static audioStreamInfo: audio.AudioStreamInfo = {
    samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_44100,
    channels: audio.AudioChannel.CHANNEL_1,
    sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE,
    encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW
  }
  static audioCapturerInfo: audio.AudioCapturerInfo = {
    source: audio.SourceType.SOURCE_TYPE_MIC, // éŸ³æºç±»å‹
    capturerFlags: 0 // éŸ³é¢‘é‡‡é›†å™¨æ ‡å¿—
  }
  static recordIng: boolean = false

  // æ˜¯å¦æ­£åœ¨å½•åˆ¶

  // æ˜¯å¦æ­£åœ¨å½•åˆ¶
  // åˆå§‹åŒ–å½•éŸ³é‡‡é›†å™¨
  static async init() {
    AudioCapturer.audioCapturer = await audio.createAudioCapturer({
      streamInfo: AudioCapturer.audioStreamInfo,
      capturerInfo: AudioCapturer.audioCapturerInfo
    });
  }

  static async start(filePath: string) {
    try {
      if (!AudioCapturer.audioCapturer) return
      AudioCapturer.recordIng = true
      await AudioCapturer.audioCapturer.start() // å¼€å§‹å½•éŸ³
      let file = fileIo.openSync(filePath, fileIo.OpenMode.READ_WRITE | fileIo.OpenMode.CREATE); // å¦‚æœæ–‡ä»¶ä¸å­˜åœ¨åˆ™åˆ›å»ºæ–‡ä»¶
      let fd = file.fd;
      let statFile = fileIo.statSync(fd)
      let bufferSize: number = statFile.size
      while (AudioCapturer.recordIng) {
        let size = await AudioCapturer.audioCapturer.getBufferSize();
        let buffer = await AudioCapturer.audioCapturer.read(size, true);
        if(buffer) {
            let options: FileOptions = {
                  offset: bufferSize,
                  length: buffer.byteLength
          };
            fileIo.writeSync(fd, buffer, options) // å†™å…¥æ–‡ä»¶
          bufferSize += buffer.byteLength
        }
  
      }
    } catch (error) {
      AlertDialog.show({
        message: JSON.stringify(error)
      })
    }

  }

  static async stop() {
    if (AudioCapturer.audioCapturer) {
      // åªæœ‰é‡‡é›†å™¨çŠ¶æ€ä¸ºSTATE_RUNNINGæˆ–STATE_PAUSEDçš„æ—¶å€™æ‰å¯ä»¥åœæ­¢
      if (AudioCapturer.audioCapturer.state === audio.AudioState.STATE_RUNNING ||
        AudioCapturer.audioCapturer.state === audio.AudioState.STATE_PAUSED
      ) {
        AudioCapturer.recordIng = false
        await AudioCapturer.audioCapturer.stop(); // åœæ­¢é‡‡é›†
      }

    }
  }

  // é‡Šæ”¾èµ„æº
  static async release() {
    if (AudioCapturer.audioCapturer) {
      await AudioCapturer.audioCapturer.release()
    }
  }
}

export class FileOptions {
  offset: number = 0;
  length: number = 0
}
```

:::color1
+ åœ¨BottomInputä¸­ä½¿ç”¨

:::

+ åˆå§‹åŒ–æ—¶è¿›è¡Œinitï¼Œå¸è½½ç»„ä»¶æ—¶è¿›è¡Œrelease

```typescript
aboutToAppear(): void {
    AudioCapturer.init()
  }
  aboutToDisappear(): void {
    AudioCapturer.release()
  }
```

 

:::color2
å½“é•¿æŒ‰æ—¶ï¼Œåˆ›å»ºæ–‡ä»¶å¼€å§‹å½•éŸ³

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711809638399-66482dfd-09f0-4c82-91e7-e082c60d3ad0.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_37%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å£°æ˜ä¸€ä¸ªå˜é‡è®°å½•ä¸´æ—¶éŸ³é¢‘å­˜å‚¨çš„è·¯å¾„åœ°å€

```typescript
tempAudioPath: string = "" // ä¸´æ—¶å½•éŸ³å˜é‡
```

+ æ”¶é›†å½•éŸ³çš„æ–¹æ³•

```typescript
 // å¼€å§‹æ”¶é›†å£°éŸ³
  beginCollectVoice() {
    this.tempAudioPath = FileCommon.createAudioFile()
    AudioCapturer.start(this.tempAudioPath) // å¼€å§‹å½•éŸ³
  }
```

+ å…³é—­å½•éŸ³çš„æ–¹æ³•

```typescript
  // åœæ­¢è¯­éŸ³æ”¶é›†
  stopCollectVoice () {
    AudioCapturer.stop()
  }
```

:::color2
åœ¨ç§»åŠ¨åˆ°å·¦ä¾§æ—¶æ¾æ‰‹æ—¶ï¼Œå°†åŸæœ‰æ–‡ä»¶åˆ é™¤

:::

```typescript
// æ¾æ‰‹åˆ¤æ–­é€»è¾‘
  releaseFinger () {
    this.showVoiceCom = false
    this.stopCollectVoice() // å…ˆå…³é—­å½•éŸ³
    if(this.voiceState === VoiceRecordEnum.Cancel) {
      // å¦‚æœæ¾æ‰‹æ—¶ï¼Œæ˜¯å–æ¶ˆçŠ¶æ€ ä¸ç®¡å½•çš„è¯­éŸ³æ€ä¹ˆæ · ç›´æ¥åˆ é™¤
      FileCommon.delFilePath(this.tempAudioPath) // åˆ é™¤è·¯å¾„
    }else if(this.voiceState === VoiceRecordEnum.Transfer) {
      // å¦‚æœæ˜¯è½¬åŒ–æ–‡æœ¬ç±»
    }
    else if(this.voiceState === VoiceRecordEnum.RecordIng) {
      // å¦‚æœæ˜¯æ­£å¸¸å½•éŸ³ å‘é€è¯­éŸ³ä¿¡æ¯
    }
    this.voiceState = VoiceRecordEnum.RecordIng
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711814541220-1e47a24a-27a3-4ad3-9bb2-74339c14c353.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_36%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="lTpgA">è®¡ç®—éŸ³é¢‘æ—¶é•¿</h1>
:::color1
+ åªè¦å¼€å§‹å½•éŸ³-å°±è®¡æ—¶ï¼Œæš‚åœï¼Œå°±ä¸å†è®¡æ—¶ï¼Œç»“æŸåœæ­¢è®¡æ—¶

:::

+ å®šä¹‰æ—¶é—´å˜é‡

```typescript
 // è®¡ç®—è®¡æ—¶å™¨
  duration: number = 0 // ç§’
 
  timer: number = -1 // å®šæ—¶å™¨æ ‡è®°

```

+ å®šä¹‰å¼€å§‹å’Œç»“æŸä¸¤ä¸ªæ–¹æ³•

```typescript
 // å¼€å§‹è®¡æ—¶
  startTime () {
    this.timer = setInterval(() => {
      this.duration++
    }, 1000)
  }
  // ç»“æŸè®¡æ—¶
  endTime () {
    clearInterval(this.timer)
  }
```

+ å¼€å§‹è®¡æ—¶å’Œç»“æŸè®¡æ—¶

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711815373403-8755b3e0-9984-400e-a7a2-de090ccb437f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708018458952-0629b658-c47c-46b1-90ff-3f72408cc864.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="C4yrN">åˆ›å»ºè¯­éŸ³æ¶ˆæ¯å‘é€</h1>
:::color1
å½“æ¾æ‰‹æ—¶ï¼ŒçŠ¶æ€ä¸ºå½•åˆ¶å‘é€æ—¶ï¼Œå°†è¯­éŸ³æ¶ˆæ¯å‘é€ä¸€æ¡ä¿¡æ¯

:::

+ åœ¨BottomInputä¸­å¯¼å…¥å½“å‰ç”¨æˆ·å’Œå¯¹è¯ç”¨æˆ·

```typescript
  @StorageProp(WeChat_CurrentUserKey)
  currentUser: UserInfoModel = new UserInfoModel({} as UserInfo)
  @Consume
  talkUser: UserInfoModel
```

+ åœ¨BottomInputä¸­å£°æ˜ä¸€ä¸ªæ–¹æ³•

```typescript
  sendAudioMessage: (mess: MessageInfoModel) => void = () => {}
```

+ æ–°å»ºä¸€ä¸ªå‘é€è¯­éŸ³ä¿¡æ¯çš„æ–¹æ³•

```typescript
 // å‘é€è¯­éŸ³æ¶ˆæ¯
  sendAudio () {
    let mess = new MessageInfoModel({
      sourceDuration: this.duration,
      messageContent: `[è¯­éŸ³]${this.duration}"`,
      connectUser: this.talkUser,
      sendUser: this.currentUser,
      messageType: MessageTypeEnum.AUDIO,
      sourceFilePath: this.tempAudioPath
    } as MessageInfo)
    this.sendAudioMessage(mess)
    this.tempAudioPath = "" // æ¸…ç©ºä¸´æ—¶è·¯å¾„
    this.duration = 0 // æ—¶é•¿å½’é›¶
  }
```

+ æ¾æ‰‹æ—¶ï¼Œå‘é€è¯­éŸ³ä¿¡æ¯

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711816082370-5f1d5187-3aa3-4e94-af16-f08b9540d851.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_44%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨çˆ¶ç»„ä»¶ä¼ å…¥å‘é€è¯­éŸ³çš„æ–¹æ³•

```typescript
// å‘é€è¯­éŸ³æ¶ˆæ¯
  async sendAudioMessage (mess: MessageInfoModel) {
    this.messList.push(mess) // æ·»åŠ åˆ°ä¿¡æ¯çš„åº•éƒ¨
    this.scroller.scrollEdge(Edge.Bottom) // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
    WeChatStore.addOneWeChatMessage(this.talkUser.user_id, mess) // æ·»åŠ åˆ°èŠå¤©è®°å½•
  }
```

+ ä¼ é€’æ–¹æ³•

```typescript
   //  æ”¾ç½®åº•éƒ¨ç»„ä»¶
      BottomInput({
        sendTextMessage: (content: string) => {
          this.sendTextMessage(content)
        },
        sendAudioMessage: (mess: MessageInfoModel) => {
          this.sendAudioMessage(mess)
        }
      })
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708019433851-c9c517db-435a-47b7-80dc-89e7ae46fbde.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="YrTS1">æ¸²æŸ“è¯­éŸ³åœºæ™¯ä¸‹çš„æ¶ˆæ¯ç»„ä»¶</h1>
+ åŠ ä¸Šä¸€ä¸ªåˆ¤æ–­ï¼Œå½“å½•åˆ¶æ—¶é•¿å°äº1ç§’æ—¶ï¼Œå¤„ç†è¯­éŸ³é”€æ¯

```typescript
  else if (this.voiceState === VoiceRecordEnum.RecordIng) {
      // å¦‚æœæ˜¯æ­£å¸¸å½•éŸ³ å‘é€è¯­éŸ³ä¿¡æ¯
      if(this.duration < 1) {
        promptAction.showToast({ message: 'å½•åˆ¶å£°éŸ³æ—¶é—´å¤ªçŸ­' })
        FileCommon.delFilePath(this.tempAudioPath) // åˆ é™¤è·¯å¾„
        return
      }
      this.sendAudio()
    }
```

:::color1
å½“å‘é€çš„æ¶ˆæ¯ä¸ºè¯­éŸ³æ—¶ï¼Œæ¸²æŸ“è¯­éŸ³æ¡

:::

+ å®ç°å¤šä¸ªæ–¹æ³•

```typescript
  // è·å–æ–‡æœ¬æ¶ˆæ¯
  @Builder
  getTextContent() {
    Text(this.currentMessage.messageContent)
      .backgroundColor(this.isOwnMessage ? $r('app.color.second_primary') : $r('app.color.white'))
      .fontColor($r('app.color.text_primary'))
      .padding(10)
      .lineHeight(24)
      .margin({
        left: 10,
        right: 10
      })
      .borderRadius(5)
  }
  // è·å–è¯­éŸ³å®½åº¦
  getAudioWidth () {
    let minWidth: number = 20
    let maxWidth: number = 90
    let calWidth: number = minWidth + (100 * this.currentMessage.sourceDuration / 60)
    if(calWidth > maxWidth) return maxWidth+"%"
    return calWidth+"%"
  }
  // è·å–è¯­éŸ³æ˜¾ç¤º
  @Builder
  getAudioContent () {
    Row({ space: 5 }) {
      Text(`${this.currentMessage.sourceDuration}'`)
        .textAlign(TextAlign.Center)
      Image($r("app.media.ic_public_recorder"))
        .width(20)
        .height(20)
        .rotate({
          angle: this.isOwnMessage ? 180 : 0
        })
    }
    .width(this.getAudioWidth())
    .backgroundColor(this.isOwnMessage ? $r('app.color.chat_primary') : $r('app.color.white'))
    .justifyContent(this.isOwnMessage ? FlexAlign.End : FlexAlign.Start)
    .height(40)
    .padding({
      left: 10,
      right: 10
    })
    .margin({
      left: 10,
      right: 10
    })
    .borderRadius(4)
    .direction(this.isOwnMessage ? Direction.Ltr :  Direction.Rtl )
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711888178739-e3cf7a49-d000-4829-aa16-ed77dc48531e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708019917168-d28e1070-f9b3-4d2f-8552-3fc28fd09369.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::



<h1 id="NgYBa">æ’­æ”¾è¯­éŸ³AudioRender</h1>
+ åˆ›å»ºä¸€ä¸ªaudio_rendererçš„é™æ€ç±»

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711888316834-61c103db-ef74-4806-a962-48119acff47b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ utils/audio_renderer

```typescript
// ç”¨æ¥æ’­æ”¾pcméŸ³é¢‘
import { audio } from '@kit.AudioKit'
import { fileIo } from '@kit.CoreFileKit';

export class AudioRenderer {
  static renderIng: boolean = false // æ˜¯å¦æ­£åœ¨æ’­æ”¾
  // å®ä¾‹
  static renderModel: audio.AudioRenderer
  // é‡‡æ ·é…ç½®
  static audioStreamInfo: audio.AudioStreamInfo = {
    samplingRate: audio.AudioSamplingRate.SAMPLE_RATE_16000,
    channels: audio.AudioChannel.CHANNEL_1,
    sampleFormat: audio.AudioSampleFormat.SAMPLE_FORMAT_S16LE,
    encodingType: audio.AudioEncodingType.ENCODING_TYPE_RAW
  };
  static audioRendererInfo: audio.AudioRendererInfo = {
    rendererFlags: 0, // éŸ³é¢‘æ¸²æŸ“å™¨ 0 æ™®é€š  1 ä½æ—¶å»¶ (ä¸æ”¯æŒ)
    usage: audio.StreamUsage.STREAM_USAGE_MOVIE
    // åœºæ™¯
  }
  // åˆ›å»ºæ’­æ”¾å™¨çš„å‚æ•°å‡†å¤‡å¥½äº†
  static audioRendererOptions: audio.AudioRendererOptions = {
    streamInfo: AudioRenderer.audioStreamInfo,
    rendererInfo: AudioRenderer.audioRendererInfo
  }
  // åˆå§‹åŒ–æ–¹æ³•
  static async init () {
      if(!AudioRenderer.renderModel) {
        // åˆ›å»ºå®ä¾‹
        AudioRenderer.renderModel = await audio.createAudioRenderer(AudioRenderer.audioRendererOptions)
      }
  }
  // éŸ³é¢‘çš„é‡Šæ”¾å’Œæš‚åœ
  static async stop () {
    if(AudioRenderer.renderModel && AudioRenderer.renderModel.state === audio.AudioState.STATE_RUNNING) {
      AudioRenderer.renderIng = false
     await AudioRenderer.renderModel.stop() // é€šçŸ¥æ–¹æ³•

    }
  }
  // å¼€å§‹è¯­éŸ³æ’­æ”¾
  static  async start (filePath: string, callback?: () => void) {
    if(AudioRenderer.renderModel && filePath) {
      // å…ˆç®¡ä¸€ä¸‹çŠ¶æ€
      // å¦‚æœä½ åœ¨æ’­çš„æƒ…å†µä¸‹ è¿˜èƒ½æ’­å—ï¼Ÿ
      // ä»€ä¹ˆæƒ…å†µä¸‹èƒ½æ’­ï¼Ÿ æš‚åœ åœæ­¢ å‡†å¤‡
      let stateList:  audio.AudioState [] = [
        audio.AudioState.STATE_PREPARED,
        audio.AudioState.STATE_PAUSED,
        audio.AudioState.STATE_STOPPED
      ]
      if(!stateList.includes(AudioRenderer.renderModel.state)) {
        // ä¸åŒ…å«çš„æƒ…å†µä¸‹ æ­¤æ—¶å°±ä¸èƒ½æ’­äº†
        return
      }
      // æ­¤æ—¶å¯ä»¥æ’­
      AudioRenderer.renderIng = true

      await AudioRenderer.renderModel.start() // å¯åŠ¨æ’­æ”¾
      // è¯»å†™æ–‡ä»¶ filePathçš„æ–‡ä»¶ ä¸€æ®µæ®µçš„è¯»å– è¯»å®Œæ‹‰åˆ° å…³é—­æ–‡ä»¶ åœæ­¢æ’­æ”¾
     const file = fileIo.openSync(filePath, fileIo.OpenMode.READ_ONLY) // è¯»è¿™ä¸ªæ–‡ä»¶çš„buffer  ä¸€æ®µæ®µçš„è¯»å– 1280
      const stat = fileIo.statSync(file.fd) // è¯¦ç»†ä¿¡æ¯
      const bufferSize = await AudioRenderer.renderModel.getBufferSize() // è·å–ç¼“å†²åŒºçš„é•¿åº¦
      let buf = new ArrayBuffer(bufferSize) // åˆ›å»ºä¸€ä¸ªç¼“å†²åŒºå¯¹è±¡ é•¿åº¦æ˜¯éŸ³é¢‘é‡‡é›†å™¨é•¿åº¦çš„é•¿åº¦
      let totalSize = 0 // æ€»é‡å€¼
      while (totalSize < stat.size &&  AudioRenderer.renderIng) {
         fileIo.readSync(file.fd, buf, {
           offset: totalSize,
           length: bufferSize
         })
        // å‘ç‚¹- writeæ˜¯ä¸ªå¼‚æ­¥æ–¹æ³•  éœ€è¦ä¸€æ®µæ®µçš„å»æ’­æ”¾ éœ€è¦å†™å…¥å®Œè¿™ä¸€æ®µä»¥å å†å»å†™å…¥ä¸‹ä¸€æ®µ
         await AudioRenderer.renderModel.write(buf) // å¾€éŸ³é¢‘é‡‡é›†å™¨å†™å…¥ç¼“å†²åŒºå†…å®¹  æ’­å®Œå†ä¸‹ä¸€æ®µ
        if (AudioRenderer.renderModel!.state.valueOf() === audio.AudioState.STATE_RELEASED) { // å¦‚æœæ¸²æŸ“å™¨çŠ¶æ€ä¸ºreleasedï¼Œå…³é—­èµ„æº
          fileIo.close(file);
        }
        // æ­¤æ—¶è¦ç»§ç»­
        totalSize += bufferSize
      }
      // å…³é—­æ–‡ä»¶
      fileIo.closeSync(file.fd)
      AudioRenderer.stop() // å…³é—­
      callback && callback()
    }
  }
  // é‡Šæ”¾
  static async release () {
    if(AudioRenderer.renderModel) {
      await AudioRenderer.renderModel.release() // é‡Šæ”¾æ–¹æ³•
    }
  }
}
```

+ åœ¨è¯¦æƒ…ä¸­åˆå§‹åŒ–(ChatDetail)

```typescript
aboutToAppear(): void {
    AudioRenderer.init()
  }
  aboutToDisappear(): void {
    AudioRenderer.stop()
  }
```

+ ç‚¹å‡»å£°éŸ³æ’­æ”¾

```typescript
.onClick(() => {
      AudioRenderer.start(this.currentMessage.sourceFilePath)
    })
```

:::color2
æ’­æ”¾å£°éŸ³å›¾ç‰‡å¸§[å£°éŸ³å¸§åŠ¨ç”».zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727514411336-e2029eba-73f8-4276-bf36-2bdc922a82a7.zip)

:::

+ æ”¾å…¥åˆ°èµ„æºç›®å½•ä¸‹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712044768453-41e8d48a-f58c-4815-8adf-73a4db140975.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ›¿æ¢å£°éŸ³æ¶ˆæ¯çš„ä½ç½®ï¼Œä½¿ç”¨å›¾ç‰‡å¸§ç»„ä»¶

```typescript
ImageAnimator()
        .images([
           {
            src: $r("app.media.ic_public_voice3")
          },
          {
            src: $r("app.media.ic_public_voice1")
          },
          {
            src: $r("app.media.ic_public_voice2")
          },
          {
            src: $r("app.media.ic_public_voice3")
          }
        ])
        .iterations(-1)
        .state(this.audioState)
        .width(20)
        .height(20)
        .rotate({
          angle: this.isOwnMessage ? 180 : 0
        })
```

+ å£°æ˜çŠ¶æ€audioState

```typescript
 @State
  audioState: AnimationStatus = AnimationStatus.Initial
```

+ æ’­æ”¾æ—¶è®¾ç½®çŠ¶æ€

```typescript
 .onClick(() => {
      AudioRenderer.start(this.currentMessage.sourceFilePath)
      this.audioState = AnimationStatus.Running
    })
```

+ åœ¨AudioRendererä¸­å®ç°ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œæ’­æ”¾ç»“æŸæ—¶ï¼Œæ‰§è¡Œ

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712046162491-e20a8dad-af3a-459e-b836-5008975ac172.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_59%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712046172338-82cf0175-ddf9-40a7-bcdd-8737d888b984.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_61%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ’­æ”¾ä¼ å…¥å›è°ƒï¼Œç»“æŸå›¾ç‰‡å¸§åŠ¨ç”»

```typescript
 .onClick(async () => {
        await AudioRenderer.stop() // ç‚¹å‡»å…ˆåœæ­¢æ’­æ”¾
        this.audioState = AnimationStatus.Initial
        AudioRenderer.start(this.currentMessage.sourceFilePath, () => {
          this.audioState = AnimationStatus.Stopped
        }) // æ’­æ”¾
        this.audioState = AnimationStatus.Running
      })
```

:::color3
æäº¤ä»£ç 

:::





<h1 id="J2pOG">åˆ é™¤æ¶ˆæ¯æ—¶ï¼Œåˆ é™¤ä¸´æ—¶è¯­éŸ³æ–‡ä»¶</h1>
:::color2
åœ¨åˆ é™¤å•æ¡æ¶ˆæ¯æ—¶ï¼Œå¦‚æœå­˜åœ¨ä¸´æ—¶å¼•ç”¨è·¯å¾„åˆ™ç›´æ¥åˆ é™¤

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711941984519-3d06e7a9-b382-46c4-a442-c1d2c1d270c8.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_51%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
åˆ é™¤æ•´ä¸ªèŠå¤©è®°å½•æ—¶ï¼Œå¾—éå†æŸ¥æ‰¾

éœ€è¦åœ¨é¦–é€‰é¡¹ä¸­çš„åˆ é™¤è¯­éŸ³çš„æ–¹æ³•å®ç°

:::

```typescript
 // åˆ é™¤â€œæˆ‘â€å’ŒæŸä¸ªäººçš„æ•´ä¸ªçš„èŠå¤©è®°å½•
  static async delWeChatMessage(userId: string) {
    // æ£€æŸ¥æ˜¯å¦æœ‰å¼•ç”¨æ–‡ä»¶ å¦‚æœæœ‰å…¨åˆ é™¤æ‰
   const list = WeChatStore.getWeChatMessage(userId)
    list.forEach(item => {
      if(item.sourceFilePath) {
        FileCommon.delFilePath(item.sourceFilePath) // åˆ é™¤æˆ‘å’Œä½ ä¹‹é—´æ‰€æœ‰çš„å¼•ç”¨æ–‡ä»¶
      }
    })
    preferences.deletePreferences(getContext(), {
      name: `${WeChat_UserRecordKey}_${userId}`
    })
  }
```

<h1 id="YtBpk">å‘é€ä¿¡æ¯-å¢åŠ å£°éŸ³æç¤º</h1>
:::color3
ç»™$rawfileç›®å½•ä¸‹æ”¾ç½®ä»¥ä¸‹å£°éŸ³çš„ç´ æ

[å£°éŸ³.zip](https://weiqi123.yuque.com/attachments/yuque/0/2024/zip/32778948/1727514411344-bbc00c77-297f-4037-ab1e-2bc7aa6bb5a9.zip)

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708101636078-a40e16b9-2cd6-4b6d-a27b-8289889e6a13.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_26%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å°è£…AvPlayeræ’­æ”¾ç±»

:::color2
avplayerç‰¹ç‚¹æ˜¯ 1ä¸ªå®ä¾‹æ’­å‡ºä¸€ç§å£°éŸ³ï¼Œå¤šå®ä¾‹å£°éŸ³å…è®¸é‡å 

:::

:::color2
å› ä¸ºAvPlayerå¯ä»¥å®ç°å¤šå®ä¾‹æ’­æ”¾ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬é‡‡ç”¨å®ä¾‹æ–¹å¼è¿›è¡Œæ’­æ”¾

:::



![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1711951136560-43c2bba2-859c-4d7b-a200-e6a0beb4c96b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_42%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ–°å»ºutils/av_player.ets

```typescript
import media from '@ohos.multimedia.media'

export class AvPlayer {
  avPlayer: media.AVPlayer | null = null
  async init() {
    this.avPlayer = await media.createAVPlayer()
    this.watchCallBack()
  }
  watchCallBack () {
    this.avPlayer?.on("stateChange", (state: string) => {
      switch (state) {
        case 'initialized': // avplayer è®¾ç½®æ’­æ”¾æºåè§¦å‘è¯¥çŠ¶æ€ä¸ŠæŠ¥
          console.info('AVPlayer state initialized called.');
          this.avPlayer?.prepare()
          break;
        case 'prepared': // prepareè°ƒç”¨æˆåŠŸåä¸ŠæŠ¥è¯¥çŠ¶æ€æœºcesi
          console.info('AVPlayer state prepared called.');
          this.avPlayer?.play()
          break;
        case 'playing': // playæˆåŠŸè°ƒç”¨åè§¦å‘è¯¥çŠ¶æ€æœºä¸ŠæŠ¥
          console.info('AVPlayer state playing called.');
          break;
        case 'paused': // pauseæˆåŠŸè°ƒç”¨åè§¦å‘è¯¥çŠ¶æ€æœºä¸ŠæŠ¥
          console.info('AVPlayer state paused called.');
          break;
        case 'completed': // æ’­æ”¾ç»“æŸåè§¦å‘è¯¥çŠ¶æ€æœºä¸ŠæŠ¥
          console.info('AVPlayer state completed called.');
          this.avPlayer?.reset(); //è°ƒç”¨æ’­æ”¾ç»“æŸæ¥å£
          break;
        case 'stopped': // stopæ¥å£æˆåŠŸè°ƒç”¨åè§¦å‘è¯¥çŠ¶æ€æœºä¸ŠæŠ¥
          console.info('AVPlayer state stopped called.');
          this.avPlayer?.reset(); //è°ƒç”¨æ’­æ”¾ç»“æŸæ¥å£
          break;
        case 'released':
          console.info('AVPlayer state released called.');
          this.avPlayer?.reset(); //è°ƒç”¨æ’­æ”¾ç»“æŸæ¥å£
          break;
        case 'error':
          console.error('AVPlayer state error called.')
          this.avPlayer?.reset(); //è°ƒç”¨æ’­æ”¾ç»“æŸæ¥å£
          break;
        default:
          console.info('AVPlayer state unknown called.');
          break;
      }
    })
  }
  async play(fileName: string) {
    let fileDescriptor = await getContext().resourceManager.getRawFd(fileName);
    let avFileDescriptor: media.AVFileDescriptor =
      { fd: fileDescriptor.fd, offset: fileDescriptor.offset, length: fileDescriptor.length }
    this.avPlayer!.fdSrc = avFileDescriptor
  }
  async stop () {
    await this.avPlayer?.stop()
  }
  async release () {
    await this.avPlayer?.release()
  }
}
```

+ åœ¨ChatDetailä¸­åˆå§‹åŒ–æ—¶è¿›è¡Œåˆå§‹åŒ–

```typescript
 player: AvPlayer = new AvPlayer() // åˆå§‹åŒ–avplayer
  aboutToAppear(): void {
    this.player.init()
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712030353615-4769fbf8-9c4d-4674-93bc-f18147273c0c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_40%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å‘é€æ¶ˆæ¯æ—¶æ’­æ”¾éŸ³ä¹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712030427988-effbfc50-c6d2-4a9b-8aad-7efef01e225e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_52%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å‘é€è¯­éŸ³æ—¶æ’­æ”¾éŸ³ä¹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712032581258-caab77d9-b99f-4d9a-b8a2-02c8bb9cb04b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_61%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color3
æäº¤ä»£ç 

:::



<h1 id="lY77F">æ¸²æŸ“åº•éƒ¨è¾“å…¥èœå•</h1>
![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708101809193-4d51294e-c346-48ff-ba40-b23ea7fdae7b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color3
ç»§ç»­ä½¿ç”¨ä¹‹å‰å®šä¹‰çš„models/popup.etsä¸­çš„PopupItemç±»å‹

åœ¨BottomInputä¸­å£°æ˜åº•éƒ¨çš„å…«ä¸ªæ•°æ®

:::

```typescript
@State
  bottomList: PopupItem[] = [{
    icon: $r('app.media.ic_public_photo'),
    title: 'ç…§ç‰‡',
  }, {
    icon: $r('app.media.ic_public_carema'),
    title: 'æ‹æ‘„',

  }, {
    icon: $r('app.media.ic_statusbar_gps'),
    title: 'ä½ç½®',

  }, {
    icon: $r('app.media.ic_public_voice'),
    title: 'è¯­éŸ³è¾“å…¥',

  }, {
    icon: $r("app.media.ic_public_collect"),
    title: 'æ”¶è—',

  }, {
    icon: $r("app.media.ic_public_contacts_filled"),
    title: 'ä¸ªäººåç‰‡',

  }, {
    icon: $r("app.media.ic_public_folder_filled"),
    title: 'æ–‡ä»¶',

  }, {
    icon:  $r("app.media.ic_public_music_filled"),
    title: 'éŸ³ä¹',
  }]

  @State
  showBottomCard: boolean = false // æ˜¾ç¤ºåº•éƒ¨

```

+ åœ¨åº•éƒ¨æ¸²æŸ“

```typescript
 if (this.showBottomCard) {
        // åº•éƒ¨ç»“æ„
        GridRow({ columns: 4 }) {
          ForEach(this.bottomList, (item: PopupItem) => {
            GridCol() {
              this.getBottomCard(item)
            }.height(100)
          })
        }
        .width('100%')
      
      }

```

+ å£°æ˜ä¸€ä¸ªè‡ªå®šä¹‰æ¸²æŸ“builder

```typescript
@Builder
  getBottomCard(item: PopupItem) {
    Column() {
      Column() {
        Image(item.icon)
          .width(30)
          .height(30)
          .fillColor("#4c4c4c")
      }
      .backgroundColor(Color.White)
      .width(56)
      .aspectRatio(1)
      .borderRadius(10)
      .justifyContent(FlexAlign.Center)
      .alignItems(HorizontalAlign.Center)

      Text(item.title)
        .fontSize(12)
        .fontColor($r('app.color.text_second'))
        .margin({
          top: 10
        })
    }.layoutWeight(1)
    .alignItems(HorizontalAlign.Center)
    .onClick(() => {
      item.itemClick && item.itemClick()
    })
  }
```



+ ç‚¹å‡»å³ä¾§åŠ å·è¿›è¡ŒæŠ˜å å±•å¼€

 ![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712033769569-e1ea885e-8eaa-45c4-9b6e-b98d710213ec.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_46%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ é”®ç›˜èšç„¦å…³é—­åº•éƒ¨
+ å£°æ˜ä¸€ä¸ªTextController

```typescript
  textController: TextInputController = new TextInputController()

```

+ ç»‘å®šTextInputç»„ä»¶-ç‚¹å‡»æ—¶éšè—åº•éƒ¨å¡ç‰‡

```typescript
 TextInput({ text: $$this.content, controller: this.textController })
.onClick(() => {
              animateTo({ duration: 100 }, () => {
                this.showBottomCard = false
              })
            })
```

+ åˆ‡æ¢è¯­éŸ³æ–‡æœ¬æ—¶ï¼Œå…³æ‰ä¸‹æ–¹çš„å¼¹å±‚

```typescript
 Image(this.showVoice ? $r('app.media.ic_public_keyboard') : $r('app.media.ic_public_sound'))
          .width(25)
          .height(25)
          .onClick(() => {
            this.showVoice = !this.showVoice
            if(this.showVoice) {
              animateTo({ duration: 100 }, () => {
                this.showBottomCard = false
              })
            }
          })
```



![](https://cdn.nlark.com/yuque/0/2024/gif/8435673/1708103781071-3b8a3573-cd0f-49fa-bda3-67d9f31c0bc2.gif)



:::color3
æäº¤ä»£ç 

:::

<h1 id="GH5fT"></h1>
:::color2
æ‚²è§‚è€…æ­£ç¡® ä¹è§‚è€…å‰è¡Œ

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712833989766-c28b5b8e-441f-4664-85c0-a19f2afb2080.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_23%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
å½“æ¾æ‰‹æ—¶ï¼Œå–æ¶ˆçŠ¶æ€ç›´æ¥è®¾ç½®æ—¶é•¿ä¸º0

:::

+ æ¨é€ PushKit . - ä¸éœ€è¦é¸¿è’™ç«¯å†™ä»£ç 

:::color2
éœ€è¦æœåŠ¡ç«¯æ”¯æŒ

è®²æ€è·¯å¸®å¤§å®¶å»é¢è¯•

:::

:::color2
Kitèƒ½åŠ›å¤ªå¤šäº† - 50000ä¸ªAPI

:::

<h1 id="Z4btn">é€‰æ‹©å›¾ç‰‡-å‘é€ç…§ç‰‡</h1>
:::color2
æ‰“å¼€ç›¸å†Œ- ä¸éœ€è¦æƒé™-è·å–ç…§ç‰‡æˆ–è€…è§†é¢‘

ç­‰åŒäºå‰ç«¯çš„ input type='file'

:::



:::color2
è‡´å‘½é—®é¢˜ï¼š ç›®å‰æ¨¡æ‹Ÿå™¨ä¸å…è®¸æ‹–ç…§ç‰‡è¿›å»

æ€ä¹ˆåŠï¼Ÿ

:::

:::color2
ç›¸å†Œä¸å…è®¸éšæ„çš„å†™å…¥

1. å®‰å…¨ç»„ä»¶ SaveButton ç»„ä»¶ ç»™5ç§’é’Ÿçš„æ—¶é—´è·å–å†™å…¥æƒé™ 5ç§’æ”¶å›
2. å‘é‚®ä»¶ å°†è‡ªå·±çš„åŒ…åå’Œç”³è¯·ç›¸å†Œç†ç”±å†™å…¥

:::

:::color2
[https://gitee.com/shuiruohanyu/copy_image](https://gitee.com/shuiruohanyu/copy_image)

:::



:::color3
+ ç‚¹å‡»å›¾ç‰‡æ—¶ï¼Œé€‰æ‹©å¤šå¼ å›¾ç‰‡ï¼Œè¿›è¡Œå‘é€

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708104098527-aaf22cce-fc58-47d3-8258-d5178441485e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_38%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨BottomInputä¸­å®šä¹‰sendPhotoæ–¹æ³•

```typescript
 // å‘é€ç…§ç‰‡æ–¹æ³•
  async sendPhoto() {
    const photo = new picker.PhotoViewPicker()
    const result = await photo.select({
      maxSelectNumber: 9,
      MIMEType: picker.PhotoViewMIMETypes.IMAGE_TYPE
    })
    if (result.photoUris.length) {
      let imgList: MessageInfoModel[] = []
      result.photoUris.forEach(item => {
        // æ‹·è´æ–‡ä»¶åˆ°æ²™ç®±
        const file = fileIo.openSync(item, fileIo.OpenMode.READ_ONLY)
        let newFileName = getContext().filesDir + '/' + Date.now() + '.jpg'
        fileIo.copyFileSync(file.fd, newFileName)
        const newMess = new MessageInfoModel({
          connectUser: this.talkUser,
          sendUser: this.currentUser,
          messageContent: '[å›¾ç‰‡]',
          messageType: MessageTypeEnum.IMAGE,
          sourceFilePath: newFileName
        } as MessageInfo)
        imgList.push(newMess) // æ·»åŠ åˆ°åˆ—è¡¨
        fileIo.closeSync(file.fd) // é‡Šæ”¾èµ„æº
      })
      this.sendImageList(imgList)
       // å…³é—­åº•éƒ¨
    animateTo({ duration: 150 }, () => {
      this.showBottomCard = false
    })
    }
  }
```

+ å­ç»„ä»¶æ¥å…¥ä¸€ä¸ªæ–¹æ³•

```typescript
  // å‘é€å›¾ç‰‡æ¶ˆæ¯
  sendImageList: (list: MessageInfoModel[]) => void = () => {}
```

+ çˆ¶ç»„ä»¶å®šä¹‰æ–¹æ³•

```typescript
// å‘é€å›¾ç‰‡æ¶ˆæ¯
  async sendImgMessage (list: MessageInfoModel[]) {
    this.messList.push(...list)
    this.scroller.scrollEdge(Edge.Bottom) // æ»šåŠ¨åˆ°æœ€åº•éƒ¨
    list.forEach(item => {
      WeChatStore.addOneWeChatMessage(this.talkUser.user_id, item) // æ·»åŠ åˆ°èŠå¤©è®°å½•
    })
    this.player.play("send.wav")
  }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712046755786-23ccaaf4-6db9-495c-b1be-5fac6552bc48.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_42%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ¸²æŸ“å›¾ç‰‡ä¿¡æ¯

```typescript
 // è·å–å›¾ç‰‡æ˜¾ç¤º
  @Builder
  getImageContent() {
    Column() {
      Image("file://" + this.currentMessage.sourceFilePath)
        .borderRadius(4)
        .width('100%')
        .enabled(false)
    }
    .width('40%')
    .margin({
      left: 10,
      right: 10
    })

  }
```

+ æ ¹æ®ä¸åŒæ¡ä»¶æ¸²æŸ“

```typescript
if(this.currentMessage.messageType === MessageTypeEnum.TEXT) {
            // æ–‡æœ¬æ¶ˆæ¯
            this.getTextContent()
          }
          if(this.currentMessage.messageType === MessageTypeEnum.AUDIO) {
            // è¯­éŸ³æ¶ˆæ¯
            this.getAudioContent()
          }
          if(this.currentMessage.messageType === MessageTypeEnum.IMAGE) {
            // è¯­éŸ³æ¶ˆæ¯
            this.getImageContent()
          }
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708160290352-0a43fb9b-74f3-4962-810e-6662aaf46dc4.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_31%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color3
æäº¤ä»£ç 

:::



<h1 id="pqJFu">å›¾ç‰‡é¢„è§ˆ</h1>
:::color2
å›¾ç‰‡éœ€è¦é•¿æŒ‰åˆ é™¤

:::

:::color1
å½“ç‚¹å‡»å›¾ç‰‡æ—¶ï¼Œå¼¹å‡ºå±‚è¿›è¡Œæ¸²æŸ“

:::

+ æ–°å»ºä¸€ä¸ªChatDetail/Components/PreviewImg.etsæ–‡ä»¶

```typescript
@CustomDialog
struct PreviewImage {
  controller: CustomDialogController
  url: string = ""
  build() {
    Column() {
      Image(this.url)
        .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .onClick(() => {
      this.controller.close()
    })
    .justifyContent(FlexAlign.Center)
  }
}
export default PreviewImage
```

+ åœ¨ChatDetailä¸­è¿›è¡Œå®šä¹‰

```typescript
 previewUrl: string = ""
  previewController: CustomDialogController = new CustomDialogController({
    builder: PreviewImg({
      url: this.previewUrl
    }),
    autoCancel: false,
    customStyle: true
  })
```

+ Messageç»„ä»¶å£°æ˜ä¸€ä¸ªå‡½æ•°å˜é‡

```typescript
  previewImage: () => void = () => {}
```

+ ç‚¹å‡»å›¾ç‰‡è°ƒç”¨

```typescript
// è·å–å›¾ç‰‡æ˜¾ç¤º
  @Builder
  getImageContent() {
    Column() {
      Image("file://" + this.currentMessage.sourceFilePath)
        .borderRadius(4)
        .width('100%')
        .enabled(false)
    }
    .width('40%')
    .margin({
      left: 10,
      right: 10
    }).onClick(() => {
      this.previewImage()
    })

  }
```

+ çˆ¶ç»„ä»¶ä¼ å…¥æ–¹æ³•ChatDetail

```typescript
  Message({
              currentMessage: item, delMessage: (messId: string) => {
                this.delMessage(messId)
              },
              previewImage: () => {
               this.previewUrl = "file://" + item.sourceFilePath
                this.previewController.open()
              }
            })
```

:::color1
æäº¤ä»£ç 

:::



<h1 id="wal8B">å”¤èµ·ç›¸æœºæ‹ç…§å‘é€ç…§ç‰‡</h1>
:::color2
ä¸¤ç§æ–¹å¼

+ æå…¶å¤æ‚çš„éœ€è¦å„ç§å„æ ·çš„å¯¹è±¡ 
+ æœ€ç®€å•çš„æ–¹å¼ ã€‚picker 

:::

+ BottomInput.ets æ³¨å†Œå”¤èµ·ç›¸æœº

```typescript
{
    icon: $r('app.media.ic_public_carema'),
    title: 'æ‹æ‘„',
    itemClick: () => {
      this.openCamera()
    }

  }
```

+ å®ç°æ‰“å¼€ç›¸æœºæ–¹æ³•

```typescript
 // æ‰“å¼€ç›¸æœº
  async openCamera() {
    try {
      let pickerProfile: cameraPicker.PickerProfile = {
        cameraPosition: camera.CameraPosition.CAMERA_POSITION_BACK
      };
      let pickerResult: cameraPicker.PickerResult = await cameraPicker.pick(getContext(),
        [cameraPicker.PickerMediaType.PHOTO, cameraPicker.PickerMediaType.VIDEO], pickerProfile);
      console.log("the pick pickerResult is:" + JSON.stringify(pickerResult));
    } catch (error) {
      promptAction.showToast({
        message: 'ç›¸æœºæ‰“å¼€å¼‚å¸¸'
      })
    }
  }
```

+ æ‹æ‘„ç…§ç‰‡

```typescript
 if (pickerResult.mediaType === "photo") {
        // å¥‡è‘©bug ç›´æ¥åˆ¤æ–­æšä¸¾å¾—åˆ°çš„æ˜¯false
        // å¦‚æœæ˜¯å›¾ç‰‡
        const imgPath = getContext().filesDir + '/' + Date.now() + '.jpg'
        const file = fileIo.openSync(pickerResult.resultUri, fileIo.OpenMode.READ_ONLY)
        fileIo.copyFileSync(file.fd, imgPath) // æ‹·è´æ–‡ä»¶
        const newMess = new MessageInfoModel({
          connectUser: this.talkUser,
          sendUser: this.currentUser,
          messageContent: '[å›¾ç‰‡]',
          messageType: MessageTypeEnum.IMAGE,
          sourceFilePath: imgPath
        } as MessageInfo)
        this.sendImageList([newMess])
      }
```



:::color1
æäº¤ä»£ç 

:::

<h1 id="k2vEx">å‘é€è§†é¢‘</h1>
+ æ ¹æ®ç±»å‹ä¸åŒå¤„ç†ä¸åŒçš„å›¾ç‰‡å’Œè§†é¢‘

```typescript
  // æ‰“å¼€ç›¸æœº
  async openCamera() {
    try {
      let pickerProfile: cameraPicker.PickerProfile = {
        cameraPosition: camera.CameraPosition.CAMERA_POSITION_BACK
      };
      let pickerResult: cameraPicker.PickerResult = await cameraPicker.pick(getContext(),
        [cameraPicker.PickerMediaType.PHOTO, cameraPicker.PickerMediaType.VIDEO], pickerProfile);

      let imgPath = getContext().filesDir + '/' + Date.now() + '.'
      let extendName = "jpg"
      let messType = MessageTypeEnum.IMAGE
      let messContent = '[å›¾ç‰‡]'
      if (pickerResult.mediaType === "video") {
        // å¥‡è‘©bug ç›´æ¥åˆ¤æ–­æšä¸¾å¾—åˆ°çš„æ˜¯false
        // å¦‚æœæ˜¯è§†é¢‘
        extendName = "mp4"
        messType = MessageTypeEnum.VIDEO
        messContent = "[è§†é¢‘]"
      }
      const file = fileIo.openSync(pickerResult.resultUri, fileIo.OpenMode.READ_ONLY)
      fileIo.copyFileSync(file.fd, imgPath + extendName) // æ‹·è´æ–‡ä»¶
      const newMess = new MessageInfoModel({
        connectUser: this.talkUser,
        sendUser: this.currentUser,
        messageContent: messContent,
        messageType: messType,
        sourceFilePath: imgPath + extendName
      } as MessageInfo)
      this.sendImageList([newMess])
    } catch (error) {
      promptAction.showToast({
        message: 'ç›¸æœºæ‰“å¼€å¼‚å¸¸'
      })
    }
  }
```

:::color1
åœ¨Message.etsä¸­æ·»åŠ è§†é¢‘æ¶ˆæ¯åˆ¤æ–­

:::

```typescript
  if (this.currentMessage.messageType === MessageTypeEnum.VIDEO) {
            // è¯­éŸ³æ¶ˆæ¯
            this.getVideoContent()
          }
```

+ å®šä¹‰VideoController

```typescript
  videoController: VideoController = new VideoController() // è§†é¢‘controller

```

+ æ¸²æŸ“ä¸€ä¸ªè§†é¢‘æ¨¡å¼ä¸‹çš„builder

```typescript
 @Builder
  getVideoContent() {
    Column() {
      Stack() {
        Video({
          src: "file://" + this.currentMessage.sourceFilePath,
          controller: this.videoController
        })
          .controls(false)
          .width(100)
          .height(150)
          .borderRadius(4)
          .id(this.currentMessage.id)
          .onPrepared(async () => {
            this.videoController.setCurrentTime(0.1) // æ‹¨åˆ°0.1ç§’
          })
        Image($r("app.media.ic_public_play"))
          .width(30)
          .height(30)
          .fillColor($r("app.color.back_color"))
      }
    }
    .margin({
      left: 10,
      right: 10
    })
  }
```

+ ç‚¹å‡»è§†é¢‘æ¸²æŸ“

```typescript
 .onClick(() => {
      this.previewImage()
    })
```

+ é¢„è§ˆç»„ä»¶æ”¯æŒå›¾ç‰‡å’Œè§†é¢‘é¢„è§ˆ

```typescript
import { MessageTypeEnum } from '../../../models/message'

@CustomDialog
struct PreviewImage {
  controller: CustomDialogController
  url: string = ""
  showType: MessageTypeEnum = MessageTypeEnum.IMAGE
  build() {
    Column() {
      if(this.showType === MessageTypeEnum.IMAGE) {
        Image(this.url)
          .width('100%')
      }
      if(this.showType === MessageTypeEnum.VIDEO) {
        Video({
          src: this.url
        })
          .loop(true)
          .autoPlay(true)
          .controls(false)
          .width('100%')
          .height('100%')
      }

    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Black)
    .onClick(() => {
      this.controller.close()
    })
    .justifyContent(FlexAlign.Center)
  }
}
export default PreviewImage
```

+ åœ¨ChatDetailä¸­ä¼ å…¥å¯¹åº”çš„å‚æ•°

```typescript
showType: MessageTypeEnum = MessageTypeEnum.IMAGE
previewController: CustomDialogController = new CustomDialogController({
    builder: PreviewImg({
      url: this.previewUrl,
      showType: this.showType
    }),
    autoCancel: false,
    customStyle: true
  })
```

+ åœ¨ä¼ é€’ç»™Messageç»„ä»¶æ—¶ï¼Œä¼ å…¥type

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712218598647-287a01e7-0042-4169-b2d7-b3906b8fae38.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_49%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::

<h1 id="eC8dt">å‘é€ä½ç½®ç»„ä»¶</h1>
:::color2
å‚è€ƒé“¾æ¥ï¼š[å®˜æ–¹æ–‡æ¡£](https://developer.huawei.com/consumer/cn/doc/app/agc-help-harmonyos-releaseapp-0000001126380068)

:::

:::color2
åä¸ºåœ°å›¾å¿…é¡»è°ƒè¯•è¯ä¹¦æ‰èƒ½æ˜¾ç¤º

:::

:::color2
<h2 id="RxCx2"><font style="color:rgba(0, 0, 0, 0.9);">ç”Ÿæˆç­¾åè¯ä¹¦æŒ‡çº¹</font></h2>
éœ€è¦è¿›è¡Œä¸€ç³»åˆ—çš„é…ç½®æ“ä½œ

+ p12æ–‡ä»¶
+ csræ–‡ä»¶
+ ceræ–‡ä»¶-è°ƒè¯•è¯ä¹¦
+ p7bæ–‡ä»¶-è°ƒè¯•è¯ä¹¦

AGCå¼€å¯åœ°å›¾æœåŠ¡

é…ç½®åº”ç”¨åŒ…å’Œè¯ä¹¦

é…ç½®é¡¹ç›®çš„module.json5ä¸­çš„åº”ç”¨æŒ‡çº¹

:::

:::color2
**<font style="color:#DF2A3F;">æ³¨æ„ï¼šç›®å‰åªèƒ½é‡‡ç”¨è°ƒè¯•è¯ä¹¦æŸ¥çœ‹åœ°å›¾ï¼Œå‘å¸ƒè¯ä¹¦ç›®å‰æ¨¡æ‹Ÿå™¨æ— æ³•æ¸²æŸ“åœ°å›¾</font>**

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712990537451-65cdb13a-a843-465f-a783-c96fa8e02e62.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_30%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ é…ç½®client_id

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712988775048-57be56a4-fce0-4153-bfad-6605165bd82c.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ·»åŠ è¯ä¹¦æŒ‡çº¹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712988814713-dbc236b1-91ba-407c-81d5-72fea624e38e.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_28%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ æ·»åŠ è°ƒè¯•è®¾å¤‡è§å›¾

:::color2
æ·»åŠ Profileæ—¶ é€‰æ‹©æ‰€æœ‰çš„è®¾å¤‡

:::

åœ°å›¾å±•ç¤º

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712990650458-7db7bdb8-eef3-45b8-aba8-4801e402b710.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_30%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

```typescript
import { MapComponent, mapCommon, map } from '@kit.MapKit';
import { AsyncCallback } from '@kit.BasicServicesKit';
```



+ æ–°å»ºåœ°å›¾ç»„ä»¶-ChatDetail/Components/Locaiton.ets

```typescript
import { MapComponent } from '@hms.core.map.MapComponent';

@Component
struct Location {

  build() {
    Row() {
      MapComponent({
        mapOptions: {
          position: {
            target: {
              latitude: 39.9,
              longitude: 116.4
            },
            zoom: 10
          }
        },
        mapCallback: () => {}
      }).width('100%').height('100%')
    }
    .height('100%')
  }
}

export default Location
```

+ å®šä¹‰å˜é‡

```typescript
  @State
  showLocation: boolean = false

```

+ å®šä¹‰ä½ç½®çš„builder

```typescript
 @Builder
  getLocation() {
    Stack({ alignContent: Alignment.Top }) {
      Location()
      Row () {
        Text("å–æ¶ˆ")
          .fontColor($r("app.color.text_second"))
          .fontWeight(FontWeight.Bold)
        Button("å‘é€")
          .type(ButtonType.Normal)
          .borderRadius(4)
          .backgroundColor($r("app.color.pay_back"))
          .fontColor($r("app.color.white"))
          .height(30)
          .width(60)
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .padding({
        left: 20,
        right: 20
      })
      .width('100%')
      .height(60)
      .margin({
        top: 50
      })
    }
    .width('100%')
  }
```

+ ç»‘å®šå¼¹å±‚

:::color2
å› ä¸ºä¹‹å‰ç»‘å®šäº†è¯­éŸ³è¾“å‡ºç»„ä»¶çš„å¼¹å±‚ï¼Œæ‰€ä»¥è¿™é‡Œçš„å¼¹å±‚è¦ç»‘å®šåœ¨å…¶ä»–ä½ç½®

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712331669446-9e4718c3-24ca-46b8-8999-6cb65ddc96b9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_57%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712331620038-039eab31-1b64-4a80-ad3e-cfa892798d4f.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::

<h1 id="dHn5H">è·å–å½“å‰ä½ç½®</h1>
:::color2
æ¨¡æ‹Ÿå™¨æ‰“å¼€å¼€å…³

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712993158339-987687ca-139f-43f7-91d9-74c51dc189e7.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_12%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::

:::color2
+ ç”³è¯·è¯»å–ä½ç½®æƒé™
+ è·å–ç»çº¬åº¦
+ è®¾ç½®ç»çº¬åº¦

:::

+ è®¾ç½®ç»çº¬åº¦ä½ç½®æƒé™module.json5

```typescript
 {
        "name": "ohos.permission.LOCATION",
        "reason": "$string:LOCATION_REASON",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "always"
        }
      },
      {
        "name": "ohos.permission.APPROXIMATELY_LOCATION",
        "reason": "$string:LOCATION_REASON",
        "usedScene": {
          "abilities": ["EntryAbility"],
          "when": "always"
        }
      },
```

+ åœ¨abilityä¸­ç”³è¯·å®šä½

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712332050243-2f89d690-c027-43d0-9193-db4a720ddac3.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_54%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ åœ¨Locaitonç»„ä»¶ä¸­å£°æ˜ä¸€ä¸ªå›è°ƒå‡½æ•°è·å–MapController

```typescript
import { AsyncCallback } from '@kit.BasicServicesKit';
import { MapComponent, mapCommon, map } from '@kit.MapKit';


@Component
struct Location {
  callback?: AsyncCallback<map.MapComponentController>;
  mapController?: map.MapComponentController;
  aboutToAppear(): void {
    this.callback = async (err, mapController) => {
      if (!err) {
        // è·å–åœ°å›¾çš„æ§åˆ¶å™¨ç±»ï¼Œç”¨æ¥æ“ä½œåœ°å›¾
        this.mapController = mapController;
      }
    };
  }
  build() {
    Row() {
      MapComponent({
        mapOptions: {
          position: {
            target: {
              latitude: 39.9,
              longitude: 116.4
            },
            zoom: 10
          }
        },
        mapCallback: this.callback
      }).width('100%').height('100%')
    }
    .height('100%')
  }
}

export default Location
```

+ è·å–ä½ç½®ååˆå§‹åŒ–è®¾ç½®æˆ‘çš„ä½ç½®

```typescript
 this.callback = async (err, mapController) => {
      if (!err) {
        // è·å–åœ°å›¾çš„æ§åˆ¶å™¨ç±»ï¼Œç”¨æ¥æ“ä½œåœ°å›¾
        this.mapController = mapController;
        this.mapController.setMyLocationEnabled(true)
        this.mapController.setMyLocationControlsEnabled(true)
        // å¯ç”¨æˆ‘çš„ä½ç½®å›¾å±‚
         this.getLocation()
      }
    };
```

+ è·å–ä½ç½®æ–¹æ³•

```typescript
import { MapComponent, mapCommon, map } from '@kit.MapKit';
import { AsyncCallback } from '@kit.BasicServicesKit';
import { geoLocationManager } from '@kit.LocationKit';

@Component
struct Location {
  // åˆå§‹åŒ–åœ°å›¾çš„å±æ€§
  private mapOption: mapCommon.MapOptions = {
    position: {
      target: {
        latitude: 39.9,
        longitude: 116.4
      },
      zoom: 12
    }
  };
  private callback?: AsyncCallback<map.MapComponentController>;
  private mapController?: map.MapComponentController;
  @Link
  currentAddress: string
  aboutToAppear(): void {
    // åœ°å›¾åˆå§‹åŒ–çš„å›è°ƒ
    this.callback = async (err, mapController) => {
      if (!err) {
        // è·å–åœ°å›¾çš„æ§åˆ¶å™¨ç±»ï¼Œç”¨æ¥æ“ä½œåœ°å›¾
        this.mapController = mapController;
        this.mapController.setMyLocationEnabled(true) // å…è®¸æˆ‘çš„å®šä½
        this.mapController.setMyLocationControlsEnabled(true) // å…è®¸æˆ‘çš„å®šä½ç»„ä»¶æ˜¾ç¤º
        // æ­¤æ—¶æ­¤åˆ» å¯ä»¥æ‹¿å®šä½äº†
        this.getLocation()
      }
    };
  }

  async getLocation() {
    try {
      const result = await geoLocationManager.getCurrentLocation()
      // result.latitude
      this.mapController?.setMyLocation({
        latitude: result.latitude,
        longitude: result.longitude,
        altitude: 0,
        accuracy: 0,
        speed: 0,
        timeStamp: 0,
        direction: 0,
        timeSinceBoot: 0
      })
      // åœ°å›¾ä¸Šä½ æ‰€çœ‹åˆ°çš„ä¸œè¥¿ å®é™…ä¸Šæ˜¯ç…§ç›¸æœºå¯¹è±¡çš„é•œå¤´ä½ç½®
      let cameraUpdate: map.CameraUpdate = map.newCameraPosition({
        target: {
          longitude: result.longitude,
          latitude: result.latitude
        },
        zoom: 16 // ç¼©æ”¾çº§åˆ«
      }) // æ–°ç…§ç›¸æœºçš„ä½ç½®
      this.mapController?.moveCamera(cameraUpdate)

      // çœ‹åˆ°å…·ä½“çš„ä½ç½®
      // åˆ©ç”¨èŠ±ç“£åœ°å›¾çš„æµ®å±‚
      this.mapController?.addMarker({
        position: {
          longitude: result.longitude,
          latitude: result.latitude
        },
        title: 'æ‚¨å½“å‰çš„ä½ç½®',
        clickable: true
      })
      // åœ¨ä»¥å®šä½çš„ä½ç½®ç”»ä¸ªåœˆ
      this.mapController?.addCircle({
        radius: 500,
        center: {
          longitude: result.longitude,
          latitude: result.latitude
        },
        fillColor: 0XFF00FFFF
      })
      // è¦æ‹¿ç»çº¬åº¦ç‚¹çš„å…·ä½“çš„è¡—é“ä½ç½®
      const res = await geoLocationManager.getAddressesFromLocation({
        latitude: result.latitude,
        longitude: result.longitude
      })
      if(res.length) {
       this.currentAddress = res[0].placeName as string
      }

    } catch (error) {
      AlertDialog.show({ message: error.message })
    }
  }

  build() {
    MapComponent({
      mapOptions: this.mapOption,
      mapCallback: this.callback // åœ°å›¾åˆå§‹åŒ–å®Œæˆ ä¼šè°ƒç”¨å›è°ƒå‡½æ•°
    })
      .width('100%')
      .height("100%")
  }
}

export default Location
```

+ å‘é€ä½ç½®

```typescript
  // è·å–ä½ç½®
  @Builder
  getLocation () {
    // æ”¾ç½®åœ°å›¾ç»„ä»¶
    Stack({ alignContent: Alignment.Top }) {
      Location({ currentAddress: $currentAddress })
      Row() {
        Text("å–æ¶ˆ")
          .fontColor($r("app.color.text_second"))
          .onClick(() => {
            this.showLocation = false
            this.currentAddress = ""
          })
        Button("ç¡®è®¤")
          .type(ButtonType.Normal)
          .borderRadius(4)
          .backgroundColor($r("app.color.primary"))
          .height(30)
          .width(60)
          .onClick(() => {
            // æ‹¿åˆ°å­ç»„ä»¶çš„å€¼
            // å°†è¿™ä¸ªå€¼ä¼ é€’å‘é€æ¶ˆæ¯
            if(this.currentAddress) {
              // å‘é€æ¶ˆæ¯
              this.sendTextMessage(this.currentAddress)
            }
            this.currentAddress = ""
            this.showLocation = false
          })
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .width('100%')
      .padding({
        left: 20,
        right: 20
      })
      .height(60)
      .margin({
        top: 50
      })
    }

  }
```

:::color1
æäº¤ä»£ç 

:::

<h1 id="hi7t1">è¯­éŸ³è½¬åŒ–</h1>
:::color2
éœ€è¦æ³¨æ„ï¼š åªèƒ½æ”¯æŒçœŸæœºï¼Œåªèƒ½æ”¯æŒé‡‡æ ·ç‡ä¸º16000èµ«å…¹çš„pcméŸ³é¢‘è¯†åˆ«

:::

+ AudioCaputur/AudioRenderer éƒ½è¦æ¢æˆ16000èµ«å…¹

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712995802255-51970ecc-7c9d-4829-81c7-b7887efea99b.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_26%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color2
å½“è¯­éŸ³åˆ’åˆ°å³ä¾§æ—¶ï¼Œè¿›è¡Œè¯­éŸ³è½¬åŒ–

:::

```typescript
import { BusinessError } from '@ohos.base';
import { speechRecognizer, textToSpeech } from '@kit.CoreSpeechKit';
import { util } from '@kit.ArkTS';
import fileIo from '@ohos.file.fs';
import { promptAction } from '@kit.ArkUI';

export class VoiceTransfer {
  // è¯­éŸ³è¯†åˆ«æˆæ–‡å­—
  private static asrEngine: speechRecognizer.SpeechRecognitionEngine;
  // æ–‡å­—è½¬è¯­éŸ³
  private static ttsEngine: textToSpeech.TextToSpeechEngine
  private static voiceExtraParam: Record<string, Object> = {
    "style": 'interaction-broadcast',
    "locate": 'CN',
    "name": 'EngineName'
  };
  private static voiceInitParamsInfo: textToSpeech.CreateEngineParams = {
    language: 'zh-CN',
    person: 0,
    online: 1,
    extraParams: VoiceTransfer.voiceExtraParam
  };

  // æ–‡æœ¬è½¬è¯­éŸ³
  static async textToVoice(speakText: string) {
    if (!VoiceTransfer.ttsEngine) {
      // æ–‡æœ¬è½¬è¯­éŸ³å¼•æ“åˆ›å»º
      VoiceTransfer.ttsEngine = await textToSpeech.createEngine(VoiceTransfer.voiceInitParamsInfo)
    }
    let extraParam: Record<string, Object> = {
      "speed": 1,
      "volume": 1,
      "pitch": 1,
      "languageContext": 'zh-CN',
      "audioType": "pcm"
    }
    let speakParams: textToSpeech.SpeakParams = {
      requestId: util.generateRandomUUID(),
      extraParams: extraParam
    }
    VoiceTransfer.ttsEngine.speak(speakText, speakParams)
  }

  // è®¾ç½®åˆ›å»ºå¼•æ“å‚æ•°
  private static textExtraParams: Record<string, Object> = { "locate": "CN", "recognizerMode": "short" }
  private static textInitParamsInfo: speechRecognizer.CreateEngineParams = {
    language: 'zh-CN',
    online: 1,
    extraParams: VoiceTransfer.textExtraParams
  };
  private static sessionId: string = "" // ä¼šè¯id
  static async VoiceToText(path: string, call: (result: speechRecognizer.SpeechRecognitionResult) => void) {
    try {
      if (!VoiceTransfer.asrEngine) {
        VoiceTransfer.asrEngine = await speechRecognizer.createEngine(VoiceTransfer.textInitParamsInfo)
      }
      if (VoiceTransfer.asrEngine.isBusy()) return // è¯´æ˜æ­£åœ¨è¯†åˆ«ä¸ç”¨å¤„ç†a
      // åˆ›å»ºå›è°ƒå¯¹è±¡
      let setListener: speechRecognizer.RecognitionListener = {
        // å¼€å§‹è¯†åˆ«æˆåŠŸå›è°ƒ
        onStart(sessionId: string, eventMessage: string) {
          console.info("onStart sessionId: " + sessionId + "eventMessage: " + eventMessage);
        },
        // äº‹ä»¶å›è°ƒ
        onEvent(sessionId: string, eventCode: number, eventMessage: string) {
          console.info("onEvent sessionId: " + sessionId + "eventCode: " + eventCode + "eventMessage: " + eventMessage);
        },
        // è¯†åˆ«ç»“æœå›è°ƒï¼ŒåŒ…æ‹¬ä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœ
        onResult(sessionId: string, result: speechRecognizer.SpeechRecognitionResult) {
          call(result) // è¿”å›è¯­éŸ³è¯†åˆ«å†…å®¹
          if(result.isLast) {
            VoiceTransfer.asrEngine.finish(sessionId) // ç»“æŸ
          }
        },
        // è¯†åˆ«å®Œæˆå›è°ƒ
        onComplete(sessionId: string, eventMessage: string) {
          // VoiceTransfer.asrEngine.finish(sessionId) // ç»“æŸ
          console.info("onComplete sessionId: " + sessionId + "eventMessage: " + eventMessage);

        },
        // é”™è¯¯å›è°ƒï¼Œé”™è¯¯ç é€šè¿‡æœ¬æ–¹æ³•è¿”å›
        // è¿”å›é”™è¯¯ç 1002200002ï¼Œå¼€å§‹è¯†åˆ«å¤±è´¥ï¼Œé‡å¤å¯åŠ¨startListeningæ–¹æ³•æ—¶è§¦å‘
        // æ›´å¤šé”™è¯¯ç è¯·å‚è€ƒé”™è¯¯ç å‚è€ƒ
        onError(sessionId: string, errorCode: number, errorMessage: string) {
          console.error("onError sessionId: " + sessionId + "errorCode: " + errorCode + "errorMessage: " + errorMessage);
        },
      }
      // è®¾ç½®å›è°ƒ
      VoiceTransfer.asrEngine.setListener(setListener);

      let audioParam: speechRecognizer.AudioInfo = {
        audioType: 'pcm',
        sampleRate: 16000,
        soundChannel: 1,
        sampleBit: 16
      };
      let extraParam: Record<string, Object> = { "vadBegin": 2000, "vadEnd": 3000, "maxAudioDuration": 60000 };
      let recognizerParams: speechRecognizer.StartParams = {
        sessionId: util.generateRandomUUID(),
        audioInfo: audioParam,
        extraParams: extraParam
      };
      VoiceTransfer.sessionId = recognizerParams.sessionId
      // è°ƒç”¨å¼€å§‹è¯†åˆ«æ–¹æ³•
      VoiceTransfer.asrEngine.startListening(recognizerParams);
      VoiceTransfer.writeAudio(path)
    } catch (error) {
      // AlertDialog.show({
      //   message: JSON.stringify(error)
      // })
    }

  }

  // å†™éŸ³é¢‘æµ
  static async writeAudio(path: string) {

    let file = fileIo.openSync(path, fileIo.OpenMode.READ_WRITE); // è¯»æ–‡ä»¶
    // let stat = fileIo.statSync(file.fd)
    try {
      let buf: ArrayBuffer = new ArrayBuffer(1280);
      let totalSize: number = 0
      while (totalSize < fileIo.statSync(file.fd).size)  {
         fileIo.readSync(file.fd, buf, {
           offset: totalSize,
           length: 1280
         })
        let unit8Array: Uint8Array = new Uint8Array(buf);
        VoiceTransfer.asrEngine.writeAudio(VoiceTransfer.sessionId, unit8Array);
        // è¿™é‡Œå¿…é¡»åŠ å»¶è¿Ÿæ‰å¯ä»¥
        await new Promise<boolean>((resolve) => {
          setTimeout(() => resolve(true), 40)
        })
        // å»¶è¿Ÿæ—¶é—´
        totalSize = totalSize + 1280;
      }
    } catch (e) {
      console.error("read file error " + e);
    } finally {
      fileIo.closeSync(file)
      VoiceTransfer.stopTransfer()
    }
  }
  // åœæ­¢è½¬æ¢æ–‡å­—
  static async stopTransfer() {
    if (VoiceTransfer.asrEngine && VoiceTransfer.asrEngine.isBusy() && VoiceTransfer.sessionId) {
      VoiceTransfer.asrEngine.finish(VoiceTransfer.sessionId)
    }
  }
}
```

+ å½“æ‹–å…¥åˆ°å³ä¾§è½¬åŒ–æ—¶å¤„ç†

```typescript
PanGesture()
                  .onActionUpdate((event) => {
                    // å–æ¶ˆ
                    if (event.fingerList[0].globalY > this.screenHeight - 120) {
                      // è¡¨ç¤ºæ²¡æœ‰å‡ºå»å½•éŸ³åŒº
                      this.voiceState = VoiceRecordEnum.RecordIng
                    } else {
                      // è¡¨ç¤ºå‡ºå»äº†
                      if (event.fingerList[0].globalX < this.screenWidth / 2) {
                        this.voiceState = VoiceRecordEnum.Cancel
                      } else {
                        this.voiceState = VoiceRecordEnum.Transfer
                        // å¦‚æœæ˜¯è½¬åŒ–æ–‡æœ¬ç±»
                        VoiceTransfer.VoiceToText(this.tempAudioPath, (res) => {
                           this.asrResult = res.result
                        })
                      }
                    }

                  })
```

+ åœ¨VoiceInputä¸­æ˜¾ç¤º

```typescript
  @Consume
  asrResult: string

 if(this.voiceState === VoiceRecordEnum.Transfer) {
      Row(){
        Text(this.asrResult)
          .fontSize(20)
          .fontColor($r("app.color.text_primary"))
        }
        .alignItems(VerticalAlign.Top)
        .padding(10)
        .height(120)
        .width(280)
        .borderRadius(20)
        .backgroundColor($r('app.color.chat_primary'))
    }
```

+ åœ¨æ¾æ‰‹é€»è¾‘ä¸­å¤„ç†è½¬åŒ–æ–‡æœ¬

```typescript
// æ¾æ‰‹åˆ¤æ–­é€»è¾‘
  releaseFinger() {
    this.showVoiceCom = false
    this.stopCollectVoice() // å…ˆå…³é—­å½•éŸ³
    VoiceTransfer.stopTransfer()
    if (this.voiceState === VoiceRecordEnum.Cancel) {
      // å¦‚æœæ¾æ‰‹æ—¶ï¼Œæ˜¯å–æ¶ˆçŠ¶æ€ ä¸ç®¡å½•çš„è¯­éŸ³æ€ä¹ˆæ · ç›´æ¥åˆ é™¤
      this.duration = 0
      FileCommon.delFilePath(this.tempAudioPath) // åˆ é™¤è·¯å¾„
    } else if (this.voiceState === VoiceRecordEnum.Transfer) {
       this.duration = 0
       if(this.asrResult) {
         this.sendTextMessage(this.asrResult)
       }
    }
    else if (this.voiceState === VoiceRecordEnum.RecordIng) {
      // å¦‚æœæ˜¯æ­£å¸¸å½•éŸ³ å‘é€è¯­éŸ³ä¿¡æ¯
      this.sendAudio()
    }
    this.voiceState = VoiceRecordEnum.RecordIng
    this.asrResult = "" // è®¾ç½®ä¸ºç©º
  }
```

:::color2
æäº¤ä»£ç 

:::

<h1 id="LoDc5">æµ®åŠ¨èœå•è½¬åŒ–è¯­éŸ³ä¸ºæ–‡æœ¬</h1>
:::color2
å½“æ¶ˆæ¯æ˜¯éŸ³é¢‘æ—¶ï¼Œå°†å…¶è½¬åŒ–ä¸ºæ–‡æœ¬æ˜¾ç¤ºåœ¨ä¸‹æ–¹

:::

+ åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼Œç‚¹å‡»è½¬æ–‡å­—è½¬åŒ–

```typescript
{
      title: 'è½¬æ–‡å­—',
      icon: $r("app.media.ic_public_trans_text"),
      itemClick: () => {
        if(this.currentMessage.messageType === MessageTypeEnum.AUDIO) {
          VoiceTransfer.VoiceToText(this.currentMessage.sourceFilePath, (res) => {
            this.transferResult = res.result
          })
        }
        this.showPopup = false
      }
    }
```

+ åœ¨åº•éƒ¨æ˜¾ç¤ºå†…å®¹

```typescript
// è·å–è¯­éŸ³æ˜¾ç¤º
  @Builder
  getAudioContent() {
    Column({ space: 10 }) {
      Row({ space: 5 }) {
        Text(`${this.currentMessage.sourceDuration}'`)
          .textAlign(TextAlign.Center)
        ImageAnimator()
          .images([
            {
              src: $r("app.media.ic_public_voice3")
            },
            {
              src: $r("app.media.ic_public_voice1")
            },
            {
              src: $r("app.media.ic_public_voice2")
            },
            {
              src: $r("app.media.ic_public_voice3")
            }
          ])
          .iterations(-1)
          .state(this.audioState)
          .width(20)
          .height(20)
          .rotate({
            angle: this.isOwnMessage ? 180 : 0
          })
      }
      .width(this.getAudioWidth())
      .backgroundColor(this.isOwnMessage ? $r('app.color.chat_primary') : $r('app.color.white'))
      .justifyContent(this.isOwnMessage ? FlexAlign.End : FlexAlign.Start)
      .height(40)
      .padding({
        left: 10,
        right: 10
      })
      .margin({
        left: 10,
        right: 10
      })
      .borderRadius(4)
      .direction(this.isOwnMessage ? Direction.Ltr : Direction.Rtl)
      .onClick(() => {
        AudioRenderer.start(this.currentMessage.sourceFilePath, () => {
          this.audioState = AnimationStatus.Stopped
        })
        this.audioState = AnimationStatus.Running
      })
      if(this.transferResult) {
        Text(this.transferResult)
          .backgroundColor(this.isOwnMessage ? $r('app.color.second_primary') : $r('app.color.white'))
          .fontColor($r('app.color.text_primary'))
          .padding(10)
          .lineHeight(24)
          .margin({
            left: 10,
            right: 10
          })
          .borderRadius(5)
      }
    }.alignItems(this.isOwnMessage ? HorizontalAlign.End : HorizontalAlign.Start)

  }
```

:::color2
æäº¤ä»£ç 

:::



<h1 id="NzJvV">å°†æœºå™¨äººè¿”å›æ–‡æœ¬ç”¨AIå°è‰ºæ’­æ”¾å‡ºæ¥</h1>
:::color2
åœ¨åŸæœ‰è¯­éŸ³è½¬æ–‡æœ¬çš„åŸºç¡€ä¸Šï¼Œæ·»åŠ æ–‡æœ¬è½¬è¯­éŸ³çš„æ–¹æ³•å’Œå±æ€§

:::

```typescript
export class VoiceTransfer {
  // æ–‡å­—è½¬è¯­éŸ³
  private static ttsEngine: textToSpeech.TextToSpeechEngine
  private static voiceExtraParam: Record<string, Object> = {
    "style": 'interaction-broadcast',
    "locate": 'CN',
    "name": 'EngineName'
  };
  private static voiceInitParamsInfo: textToSpeech.CreateEngineParams = {
    language: 'zh-CN',
    person: 0,
    online: 1,
    extraParams: VoiceTransfer.voiceExtraParam
  };

  // æ–‡æœ¬è½¬è¯­éŸ³
  static async textToVoice(speakText: string) {
    if (!VoiceTransfer.ttsEngine) {
      // æ–‡æœ¬è½¬è¯­éŸ³å¼•æ“åˆ›å»º
      VoiceTransfer.ttsEngine = await textToSpeech.createEngine(VoiceTransfer.voiceInitParamsInfo)
    }
    let extraParam: Record<string, Object> = {
      "speed": 1,
      "volume": 1,
      "pitch": 1,
      "languageContext": 'zh-CN',
      "audioType": "pcm"
    }
    let speakParams: textToSpeech.SpeakParams = {
      requestId: util.generateRandomUUID(),
      extraParams: extraParam
    }
    VoiceTransfer.ttsEngine.speak(speakText, speakParams)
  }

}
```

:::color2
å½“å¯¹æ–¹è¿”å›æ–‡æœ¬æ—¶ï¼Œç”¨è¯­éŸ³æ’­æ”¾å‡ºæ¥

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1712495123522-dcf1a1b0-12eb-48e6-a1b6-965d6b99a9bc.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_48%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



<h1 id="JAlp4">è®¡ç®—æ˜¾ç¤ºè¯­éŸ³æ³¢å³°</h1>
:::color2
å½“é•¿æŒ‰è¯­éŸ³æ—¶ï¼Œè¾“å‡ºæ³¢å³°åŠ¨ç”»

:::

+ ä½¿ç”¨çº¿ç¨‹é€šä¿¡(å½•éŸ³æ—¶è¾“å‡ºæ³¢æ®µbuffer)

```typescript
emitter.emit("onBuffer", { data: { buffer } })
```

+ voiceInputç›‘å¬buffer

```typescript
aboutToAppear(): void {
   emitter.on("onBuffer", (res: emitter.EventData) => {
     this.calculateAmplitudes(res.data!["buffer"] as ArrayBuffer)
   })
  }
```

+ å¸è½½æ—¶è§£é™¤è®¢é˜…

```typescript
 aboutToDisappear(): void {
    emitter.off("onBuffer")
  }
```

+ å£°æ˜å˜é‡è®°å½•æŒ¯å¹…

```typescript
  @State
  list: number[] = []
```

+ è®¡ç®—æŒ¯å¹…

```typescript
 // è®¡ç®—æ³¢å³°
  calculateAmplitudes(buffer: ArrayBuffer) {
    try {
      const sampleSize = Math.floor(buffer.byteLength / 20); // è®¡ç®—æ¯ä¸ªå‡åˆ†åŒºé—´çš„å¤§å°
      const view = new DataView(buffer);
      const amplitudes: number[] = [];
      // éå†ç¼“å†²åŒºï¼Œè®¡ç®—æ¯ä¸ªæ ·æœ¬çš„æŒ¯å¹…å¹¶è½¬æ¢ä¸ºé«˜åº¦
      // éå†åŸå§‹ç¼“å†²åŒºï¼Œæå–æ¯ä¸ªå‡åˆ†åŒºé—´çš„æŒ¯å¹…
      for (let i = 0; i < buffer.byteLength; i += sampleSize) {
        let sum = 0;
        // è®¡ç®—å½“å‰å‡åˆ†åŒºé—´å†…æ‰€æœ‰æŒ¯å¹…çš„å¹³å‡å€¼
        for (let j = i; j < i + sampleSize; j += 2) { // å‡è®¾æ¯ä¸ªæ ·æœ¬å æ® 2 å­—èŠ‚
          const sample = view.getInt16(j, true);
          sum += Math.abs(sample);
        }
        const averageAmplitude = 150 * sum / (sampleSize / 2) / 32767 ; // å‡è®¾æ¯ä¸ªæ ·æœ¬å æ® 2 å­—èŠ‚
        amplitudes.push(averageAmplitude < 10 ? 10: averageAmplitude );
      }
      animateTo({ duration: 100 }, () => {
        this.list = amplitudes
      })

    }catch (error) {
      AlertDialog.show({ message: error.message })
    }
  }
```

+ æ ¹æ®æŒ¯å¹…æ˜¾ç¤ºå†…å®¹

```typescript
 if (this.voiceState === VoiceRecordEnum.RecordIng) {
      Row({ space:2 }) {
        ForEach(this.list, (v: number) => {
           Row()
             .height(v)
             .width(2)
             .borderRadius(1)
             .backgroundColor($r("app.color.animate_voice_color"))
        })
      }
      .justifyContent(FlexAlign.Center)
      .height(80)
      .width(180)
      .borderRadius(20)
      .backgroundColor($r('app.color.chat_primary'))
    }
```

:::color2
æäº¤ä»£ç 

:::

<h1 id="qvgYI">ä¸»é¡µé¡¶éƒ¨ä¸‹æ‹‰èœå•</h1>
:::color1
åœ¨é¡¶éƒ¨å¢åŠ ä¸€ä¸ªæœç´¢å’Œä¸‹æ‹‰èœå•

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708331145582-c2280aee-48f5-4301-bf3e-4116a667bd23.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ å®šä¹‰ä¸‹æ‹‰çš„æ•°æ®é€‰é¡¹

```typescript
@State
  popList: PopupItem[] = [
    {
      title: 'å‘èµ·ç¾¤èŠ',
      icon: $r('app.media.ic_public_message')
    },
    {
      title: 'æ·»åŠ æœ‹å‹',
      icon: $r('app.media.ic_public_add_friend')
    },
    {
      title: 'æ‰«ä¸€æ‰«',
      icon: $r('app.media.ic_public_scan')
    },
    {
      title: 'æ”¶ä»˜æ¬¾',
      icon: $r('app.media.ic_public_receive')
    }
  ]
```

+ æ ¹æ®æ•°æ®å®ç°ä¸€ä¸ªä¸‹æ‹‰çš„builder

```typescript
@Builder
  getDropDown() {
    Column() {
      ForEach(this.popList, (item: PopupItem) => {
        Row({ space: 5 }) {
          Image(item.icon)
            .fillColor($r('app.color.white'))
            .width(20)
            .height(20)
          Text(item.title)
            .fontColor(Color.White)
            .layoutWeight(1)
            .textAlign(TextAlign.Center)
        }
        .width('100%')
        .height(48)
        .justifyContent(FlexAlign.Center)
        .padding({
          left: 10,
          right: 10
        }).onClick(() => {
          item.itemClick && item.itemClick()
        })

      })
    }
    .width(120)
  }
```

+ å®šä¹‰æ§åˆ¶ä¸‹æ‹‰çš„å±æ€§

```typescript
  @State
  showDropDown: boolean = false // æ˜¾ç¤ºåº•éƒ¨æµ®å±‚
```

+ ç»‘å®šbindPopupå±æ€§

```typescript
 Row() {
        Text(`å¾®ä¿¡(${this.list.length})`)
          .fontSize(16)
          .fontColor($r('app.color.text_primary'))
        Image($r('app.media.ic_public_add_norm'))
          .width(20)
          .height(20)
          .fillColor($r('app.color.text_primary'))
          .position({
            x: '100%'
          })
          .translate({
            x: -40,
            y: 15
          })
          .bindPopup(this.showDropDown, {
            builder: this.getDropDown,
            placement: Placement.Bottom,
            onStateChange: (event) => {
              this.showDropDown = event.isVisible
            },
            popupColor: $r("app.color.popup_back"),
            backgroundBlurStyle: BlurStyle.NONE
          })
          .onClick(() => {
            this.showDropDown = true
          })

      }.width('100%')
      .justifyContent(FlexAlign.Center)
      .height(50)
```

:::color1
æäº¤ä»£ç 

:::

<h1 id="KBcNC">æ‰«ç åŠŸèƒ½</h1>
+ æ³¨å†Œç‚¹å‡»äº‹ä»¶

```typescript
 {
      title: 'æ‰«ä¸€æ‰«',
      icon: $r('app.media.ic_public_scan'),
      itemClick: () => {
        this.scan() // æ‰«ç 
      }
    },
```

+ å®šä¹‰æ‰«ç æ–¹æ³•

```typescript
 // æ‰«ç 
  async scan() {
    // å®šä¹‰æ‰«ç å‚æ•°options
    let options: scanBarcode.ScanOptions = {
      scanTypes: [scanCore.ScanType.ALL],
      enableMultiMode: true,
      enableAlbum: true
    };
    // å¯åŠ¨æ‰«ç ï¼Œæ‹‰èµ·æ‰«ç ç•Œé¢
    try {
      const result = await scanBarcode.startScanForResult(getContext(this), options)
    } catch (error) {
      promptAction.showToast({ message: error.message })
    }
  }
```



<h1 id="eUU7r">å®ç°æ”¶ä»˜æ¬¾é¡µé¢</h1>
:::info
ç‚¹å‡»æ”¶ä»˜æ¬¾ç”Ÿæˆä¸€ä¸ªäºŒç»´ç 

:::

+ æ³¨å†Œæ”¶ä»˜æ¬¾ç‚¹å‡»äº‹ä»¶-è·³è½¬åˆ°æ”¶ä»˜æ¬¾é¡µé¢

```typescript
  {
      title: 'æ”¶ä»˜æ¬¾',
      icon: $r('app.media.ic_public_receive'),
      itemClick: () => {
         router.pushUrl({
           url: 'pages/PayQrCode/PayQrCode'
         })
      }
    }
```

+ åˆ›å»ºä¸€ä¸ªæ”¶ä»˜æ¬¾é¡µé¢ pages/PayQrCode/PayQrCode.ets

```typescript
import { router } from '@kit.ArkUI'

@Entry
@Component
struct PayQrCode {
  build() {
    Column() {
      Row() {
        Stack({ alignContent: Alignment.Start }) {
          Image($r('app.media.ic_public_arrow_left'))
            .width(30)
            .height(30)
            .fillColor($r("app.color.white"))
            .onClick(() => {
              router.back()
            })
            .zIndex(2)

          Text("æ”¶ä»˜æ¬¾")
            .width('100%')
            .textAlign(TextAlign.Center)
            .fontSize(16)
            .fontColor($r('app.color.white'))
        }
        .height(50)
      }
      .padding({
        left: 10,
        right: 10
      })

      Row() {
        Column() {
          Row({ space: 10 }) {
            Image($r("app.media.ic_public_scan"))
              .width(20)
              .height(20)
              .fillColor($r("app.color.pay_back"))
            Text("ä»˜æ¬¾ç ")
              .fontColor($r("app.color.pay_back"))
          }
          .width('100%')
          .justifyContent(FlexAlign.Start)
          .height(60)
          .border({
            width: {
              bottom: 0.5
            },
            color: $r("app.color.border_color")
          })

          // æ˜¾ç¤ºç 
          Column({ space: 20 }) {
            Text("ä¼˜å…ˆä½¿ç”¨xxé“¶è¡Œå‚¨è“„å¡ä»˜æ¬¾")
              .fontColor($r("app.color.text_second"))
              .fontSize(12)
          }
          .margin({
            top: 10,
            bottom: 10
          })
        }
        .padding(10)
        .borderRadius(4)
        .width("100%")
        .backgroundColor($r("app.color.white"))
      }
      .padding({
        left: 10,
        right: 20
      })

    }
    .width('100%')
    .height('100%')
    .backgroundColor($r("app.color.pay_back"))
  }
}

```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708333185972-e0e3d452-f57b-40ac-965e-cdec44fdc120.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



:::color1
æäº¤ä»£ç 

:::



<h1 id="OouaO">ç”Ÿæˆæ¡å½¢ç å’ŒäºŒç»´ç </h1>
:::color1
+ éšæœºç”Ÿæˆä¸€ä¸ªåŸºäºå½“å‰ç”¨æˆ·çš„éšæœºæ•°
+ ä½¿ç”¨äºŒç»´ç ç»„ä»¶æ˜¾ç¤ºäºŒç»´ç 
+ ä½¿ç”¨ç”Ÿæˆæ¡å½¢ç å·¥å…·ç”Ÿæˆæ¡å½¢ç 
+ 30ç§’ä¸€åˆ·æ–°å¯¹åº”çš„ç 

:::

+ å®šä¹‰ä¸€ä¸ªäºŒç»´ç çš„éšæœºæ•°

```typescript
@State
  payParams: string = Math.random().toString()
```

+ åç§’éšæœºç”Ÿæˆéšæœºæ•°

```typescript
@State
  payParams: string = Math.random().toString()
  timer: number = -1
  @State
  barCodeImage: PixelMap | null = null
  aboutToAppear(): void {
    this.createQrCodeValue()
    this.createBarCode()
  }
  aboutToDisappear(): void {
    clearTimeout(this.timer)
  }
  createQrCodeValue () {
    this.timer = setTimeout(async () => {
      this.payParams = Math.random().toString()
    }, 10000)
  }
```

+ ä½¿ç”¨äºŒç»´ç ç»„ä»¶æ˜¾ç¤º

```typescript
  QRCode(this.payParams)
              .width(140)
              .height(140)
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708335402735-7661832d-8637-4752-b1f3-a0ac3ed16bcf.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_15%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

+ ä½¿ç”¨äºŒç»´ç ç”Ÿæˆå·¥å…·ç”Ÿæˆæ¡å½¢ç 

:::danger
æ¨¡æ‹Ÿå™¨ä¸å¯ç”¨-å¾…è§£å†³

:::

+ å®šä¹‰ä¸€ä¸ªçŠ¶æ€æ¥æ”¶PixelMap

```typescript
  @State
  barCodeImage: PixelMap | null = null
```

+ å®šä¹‰ç”Ÿæˆæ¡å½¢ç æ–¹æ³•

```typescript
// åˆ›å»ºæ¡å½¢ç 
  async createBarCode() {
    let options: generateBarcode.CreateOptions = {
      scanType: scanCore.ScanType.CODE128_CODE,
      height: 200,
      width: 800
    }
    // ç å›¾ç”Ÿæˆæ¥å£ï¼ŒæˆåŠŸè¿”å›PixelMapæ ¼å¼å›¾ç‰‡
    this.barCodeImage = await generateBarcode.createBarcode(this.payParams, options)
  }
```

+ æ˜¾ç¤ºæ¡å½¢ç 

```typescript
  Image(this.barCodeImage)
              .width(280)
              .height(100)
              .objectFit(ImageFit.Contain)
```

+ åœ¨åˆå§‹åŒ–æ—¶ç”Ÿæˆ

```typescript
aboutToAppear(): void {
    this.createQrCodeValue()
    this.createBarCode()
  }
```

+ 10ç§’åæ›´æ–°

```typescript
createQrCodeValue () {
    this.timer = setTimeout(async () => {
      this.payParams = Math.random().toString()
      this.createBarCode()
    }, 10000)
  }
```



:::color1
æäº¤ä»£ç 

:::

<h1 id="dz8ll">æˆ‘çš„é¡µé¢ç»“æ„</h1>
:::color1
å®ç°æˆ‘çš„é¡µé¢ç»“æ„

:::

```typescript
@Preview
@Component
struct My {
  @Builder
  getRenderItem (left: string, rightClick?: () => void) {
    Row() {
      Text(left)
      Image($r("app.media.ic_public_right"))
        .width(16)
        .height(16)
    }
    .width('100%')
    .padding({
      left: 20,
      right: 20
    })
    .backgroundColor($r("app.color.white"))
    .height(60)
    .justifyContent(FlexAlign.SpaceBetween)
    .border({
      color: $r("app.color.border_color"),
      width: {
        bottom: 0.5
      }
    })
  }
  build() {
    Column() {
      // é¡¶éƒ¨
      Row () {
        Row({ space: 10 }) {
          Image("https://gimg2.baidu.com/image_search/src=http%3A%2F%2Fsafe-img.xhscdn.com%2Fbw1%2Fea86243a-a102-49d3-90e5-f48d3b909b94%3FimageView2%2F2%2Fw%2F1080%2Fformat%2Fjpg&refer=http%3A%2F%2Fsafe-img.xhscdn.com&app=2002&size=f9999,10000&q=a80&n=0&g=0n&fmt=auto?sec=1710934156&t=5f402de56ae39dbfc8f1ba8e0af465a2")
            .width(60)
            .height(60)
            .borderRadius(6)
          Column({ space: 10 }) {
            Text("è€é«˜").fontSize(18).fontColor($r('app.color.text_primary'))
            Text("å¾®ä¿¡å·ï¼š4334343").fontColor($r('app.color.text_second')).fontSize(14)
          }.alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
        Image($r("app.media.ic_public_right"))
          .width(16)
          .height(16)
          .fillColor($r('app.color.text_second'))
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .padding(30)
      .width('100%')
      .backgroundColor($r("app.color.white"))
      Row().height(10)
      this.getRenderItem("æœåŠ¡")
      Row().height(10)
      this.getRenderItem("æ”¶è—")
      this.getRenderItem("æœ‹å‹åœˆ")
      this.getRenderItem("å¡åŒ…")
      this.getRenderItem("è¡¨æƒ…")
      Row().height(10)
      this.getRenderItem("è®¾ç½®")
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.back_color'))
  }
}
export default My
```

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708342771942-f4b4bbe6-2aa7-4a3c-8e10-436b96c79a16.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_11%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
åœ¨ä¸»é¡µä¸­æ˜¾ç¤ºè¯¥ç»„ä»¶

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708342860147-db053fa7-c5c7-479d-85d0-139b5cf994d9.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_22%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)



+ å°†æˆ‘çš„é¡µé¢çš„æ•°æ®å˜æˆå½“å‰çš„ç”¨æˆ·ä¿¡æ¯

```typescript
@StorageProp(WeChat_CurrentUserKey)
  currentUser: UserInfoModel = new UserInfoModel({} as UserInfo)
  
```

+ æ¸²æŸ“é¡µé¢

```typescript
Row({ space: 10 }) {
          Image(this.currentUser.avatar)
            .width(60)
            .height(60)
            .borderRadius(6)
          Column({ space: 10 }) {
            Text(this.currentUser.username).fontSize(18).fontColor($r('app.color.text_primary'))
            Text(`å¾®ä¿¡å·ï¼š${this.currentUser.user_id}`).fontColor($r('app.color.text_second')).fontSize(14)
          }.alignItems(HorizontalAlign.Start)
        }
        .layoutWeight(1)
```

:::color1
æäº¤ä»£ç 

:::

<h1 id="fQ71U">å‘ç°é¡µé¢ç»“æ„</h1>
:::color1
æ–°å»ºpages/Find/Find.ets

:::

```typescript

@Preview
@Component
struct Find {
  

  @Builder
  getRenderItem(left: string, rightClick?: () => void) {
    Row() {
      Text(left)
      Image($r("app.media.ic_public_right"))
        .width(16)
        .height(16)
    }
    .width('100%')
    .padding({
      left: 20,
      right: 20
    })
    .backgroundColor($r("app.color.white"))
    .height(60)
    .justifyContent(FlexAlign.SpaceBetween)
    .border({
      color: $r("app.color.border_color"),
      width: {
        bottom: 0.5
      }
    })
  }

  build() {
    Column() {
      Row() {
        Text("å‘ç°")
      }
      .justifyContent(FlexAlign.Center)
      .height(40)
      .width('100%')
      Scroll() {
        Column() {
          // é¡¶éƒ¨
          this.getRenderItem("æœ‹å‹åœˆ")
          Row().height(10)
          this.getRenderItem("è§†é¢‘å·")
          this.getRenderItem("ç›´æ’­")
          Row().height(10)
          this.getRenderItem("æ‰«ä¸€æ‰«")
          this.getRenderItem("æ‘‡ä¸€æ‘‡")
          Row().height(10)
          this.getRenderItem("çœ‹ä¸€çœ‹")
          this.getRenderItem("æœä¸€æœ")
          Row().height(10)
          this.getRenderItem("é™„è¿‘")
          Row().height(10)
          this.getRenderItem("è´­ç‰©")
          this.getRenderItem("æ¸¸æˆ")
          Row().height(10)
          this.getRenderItem("å°ç¨‹åº")
          Row().height(10)
        }
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor($r('app.color.back_color'))
  }
}

export default Find
```

:::color1
åœ¨ä¸»é¡µä¸­æ˜¾ç¤ºè¯¥ç»„ä»¶

:::

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708343900447-247f6c94-86cb-4cf7-86ce-bc1813275053.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_10%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

![](https://cdn.nlark.com/yuque/0/2024/png/8435673/1708343971617-37bdfbde-8573-4009-bb1e-46c974afee72.png?x-oss-process=image%2Fwatermark%2Ctype_d3F5LW1pY3JvaGVp%2Csize_21%2Ctext_6buR6ams56iL5bqP5ZGY%2Ccolor_FFFFFF%2Cshadow_50%2Ct_80%2Cg_se%2Cx_10%2Cy_10)

:::color1
æäº¤ä»£ç 

:::



